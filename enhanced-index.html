<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice Gallery - 5 Style System</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            text-align: center;
            max-width: 100vw;
            max-height: 100vh;
            position: relative;
        }
        
        #alice-image {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: opacity 0.8s ease-in-out;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(255, 255, 255, 0.1);
        }
        
        .image-loading {
            opacity: 0.3;
        }
        
        .error-state {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        /* Debug info (hidden by default) */
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        /* Loading indicator */
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .loading-indicator.show {
            display: block;
        }
        
        /* Style transition animation */
        @keyframes styleTransition {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .style-transition {
            animation: styleTransition 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="alice-image" src="https://res.cloudinary.com/dfzowmhfp/image/upload/alice-gallery/anime/001-anime.png" alt="Alice Gallery">
    </div>
    
    <div class="loading-indicator" id="loading">
        <div>Loading Alice Gallery...</div>
    </div>
    
    <div class="debug-info" id="debug">
        Row: <span id="debug-row">001</span> | 
        Style: <span id="debug-style">anime</span> | 
        Status: <span id="debug-status">loading</span>
    </div>
    
    <script>
        class AliceGallery {
            constructor() {
                this.currentRow = 1;
                this.currentStyle = "anime";
                this.pollInterval = 2000;
                
                this.imageElement = document.getElementById('alice-image');
                this.loadingElement = document.getElementById('loading'); 
                this.debugElement = document.getElementById('debug');
                
                this.styles = {
                    "anime": "Anime Style",
                    "comic-90s": "90s Comic Book",
                    "realistic": "Realistic", 
                    "renaissance": "Renaissance",
                    "disney": "Disney Animation"
                };
                
                this.totalRows = 420;
                this.isDebugMode = new URLSearchParams(window.location.search).has('debug');
                
                if (this.isDebugMode) {
                    this.debugElement.classList.add('show');
                }
                
                this.startPolling();
            }
            
            async fetchDisplayConfig() {
                try {
                    const response = await fetch('enhanced-display-control.json?' + Date.now());
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching display config:', error);
                    this.updateDebugStatus('connection-error');
                    return null;
                }
            }
            
            generateImagePath(row, style) {
                const paddedRow = row.toString().padStart(3, '0');
                return `https://res.cloudinary.com/dfzowmhfp/image/upload/alice-gallery/${style}/${paddedRow}-${style}.png`;
            }
            
            updateImage(row, style) {
                if (row === this.currentRow && style === this.currentStyle) return;
                
                const imagePath = this.generateImagePath(row, style);
                
                this.imageElement.classList.add('image-loading');
                this.loadingElement.classList.add('show');
                this.updateDebugStatus('loading');
                
                // Pre-load the image
                const newImg = new Image();
                newImg.onload = () => {
                    this.imageElement.src = imagePath;
                    this.currentRow = row;
                    this.currentStyle = style;
                    
                    setTimeout(() => {
                        this.imageElement.classList.remove('image-loading', 'error-state');
                        this.imageElement.classList.add('style-transition');
                        this.loadingElement.classList.remove('show');
                        this.updateDebugStatus('success');
                        
                        // Remove animation class after animation completes
                        setTimeout(() => {
                            this.imageElement.classList.remove('style-transition');
                        }, 600);
                    }, 200);
                    
                    console.log(`Switched to Row ${row} (${this.styles[style]})`);
                };
                
                newImg.onerror = () => {
                    console.error('Failed to load image:', imagePath);
                    this.imageElement.classList.remove('image-loading');
                    this.imageElement.classList.add('error-state');
                    this.loadingElement.classList.remove('show');
                    this.updateDebugStatus('image-error');
                };
                
                newImg.src = imagePath;
            }
            
            updateDebugStatus(status) {
                if (!this.isDebugMode) return;
                
                document.getElementById('debug-row').textContent = this.currentRow.toString().padStart(3, '0');
                document.getElementById('debug-style').textContent = this.currentStyle;
                document.getElementById('debug-status').textContent = status;
            }
            
            async poll() {
                const config = await this.fetchDisplayConfig();
                
                if (config && config.currentRow && config.currentStyle) {
                    this.updateImage(config.currentRow, config.currentStyle);
                    this.updateDebugStatus('connected');
                }
            }
            
            startPolling() {
                // Show loading initially
                this.loadingElement.classList.add('show');
                this.updateDebugStatus('initializing');
                
                // Initial poll
                this.poll();
                
                // Set up interval
                setInterval(() => {
                    this.poll();
                }, this.pollInterval);
                
                console.log('Alice Gallery System started');
                console.log(`Supporting ${this.totalRows} concepts Ã— ${Object.keys(this.styles).length} styles = ${this.totalRows * Object.keys(this.styles).length} total images`);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AliceGallery();
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                location.reload();
            }
        });
        
        // Keyboard shortcuts for debug mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' && e.ctrlKey) {
                e.preventDefault();
                const debugElement = document.getElementById('debug');
                debugElement.classList.toggle('show');
            }
        });
    </script>
</body>
</html>