<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Alice Display</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        
        .display-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height - better on mobile Safari */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        /* Dual image layers for crossfade */
        .image-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease-in-out;
            
            /* Performance optimizations */
            will-change: opacity, padding;
            contain: layout style paint size;
            transform: translate3d(0, 0, 0);
            isolation: isolate;
        }
        
        .image-layer img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            /* Ken Burns base - slightly larger to allow movement */
            transform-origin: center center;
        }
        
        /* Ken Burns effect animations */
        @keyframes kenburns-1 {
            0% { transform: scale(1.0) translate(0, 0); }
            100% { transform: scale(1.08) translate(-1%, -1%); }
        }
        
        @keyframes kenburns-2 {
            0% { transform: scale(1.0) translate(0, 0); }
            100% { transform: scale(1.08) translate(1%, -0.5%); }
        }
        
        @keyframes kenburns-3 {
            0% { transform: scale(1.05) translate(-0.5%, 0.5%); }
            100% { transform: scale(1.0) translate(0, 0); }
        }
        
        @keyframes kenburns-4 {
            0% { transform: scale(1.08) translate(0.5%, -1%); }
            100% { transform: scale(1.02) translate(-0.5%, 0.5%); }
        }
        
        .image-layer.active img.kenburns {
            animation-duration: 20s;
            animation-timing-function: ease-in-out;
            animation-fill-mode: forwards;
        }
        
        .image-layer.active img.kenburns-1 { animation-name: kenburns-1; }
        .image-layer.active img.kenburns-2 { animation-name: kenburns-2; }
        .image-layer.active img.kenburns-3 { animation-name: kenburns-3; }
        .image-layer.active img.kenburns-4 { animation-name: kenburns-4; }
        
        /* Pause Ken Burns when user prefers reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .image-layer.active img.kenburns {
                animation: none;
            }
        }
        
        .image-layer.active {
            opacity: 1;
            z-index: 2;
        }
        
        .image-layer.inactive {
            opacity: 0;
            z-index: 1;
        }
        
        /* Weather/Time overlay (bottom bar) - now toggleable at bottom-LEFT */
        .status-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            transform: none;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.4s ease, width 0.4s ease, padding 0.4s ease, border-radius 0.4s ease;
            z-index: 10;
            cursor: pointer;
            
            /* Performance optimizations */
            will-change: transform, opacity, width;
            contain: layout style;
            backface-visibility: hidden;
            transform: translate3d(0, 0, 0);
        }
        
        .status-overlay.visible {
            opacity: 1;
        }
        
        /* Collapsed state - small circular indicator */
        .status-overlay.collapsed {
            width: 50px;
            height: 50px;
            padding: 0 !important;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            gap: 0 !important;
            opacity: 0.8;
            overflow: hidden;
        }
        
        /* Hide all items except first one when collapsed */
        .status-overlay.collapsed .status-item:not(:first-child) {
            display: none !important;
        }
        
        /* First status item takes full container in collapsed state */
        .status-overlay.collapsed .status-item:first-child {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            margin: 0;
            padding: 0;
        }
        
        /* Hide text elements completely in collapsed state */
        .status-overlay.collapsed .status-item:first-child > div {
            display: none !important;
        }
        
        /* Weather icon: flex container for perfect centering */
        .status-overlay.collapsed .status-item:first-child .icon {
            font-size: 24px;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            line-height: 1;
            text-align: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item .icon {
            font-size: 18px;
        }
        
        .status-item .label {
            opacity: 0.7;
            font-size: 12px;
        }
        
        .status-item .value {
            font-weight: 500;
        }
        
        /* Tap-to-copy: makes the activity item tappable */
        .tap-to-copy {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.15s ease;
        }
        
        .tap-to-copy:active {
            opacity: 0.6;
        }
        
        /* Copy confirmation toast — floats above the status bar */
        .copy-toast {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            margin-bottom: 8px;
        }
        
        .copy-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Weather widget overlay (corner) - reverted to original */
        .weather-widget {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(30,30,50,0.9) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            color: white;
            min-width: 180px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.4s ease, transform 0.4s ease;
            z-index: 15;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            cursor: pointer;
            
            /* Performance optimizations */
            will-change: transform, opacity, width, height;
            contain: layout style paint; /* CSS containment for independent updates */
            backface-visibility: hidden; /* Prevent flickering */
            transform: translate3d(0, 0, 0); /* Force hardware acceleration */
        }
        
        .weather-widget.hidden {
            /* Collapsed state: small icon only */
            width: 50px;
            height: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 8px;
            border-radius: 25px;
            overflow: hidden;
        }
        
        /* Hide all content except icon when collapsed */
        .weather-widget.hidden .weather-widget-temp,
        .weather-widget.hidden .weather-widget-condition,
        .weather-widget.hidden .weather-widget-description,
        .weather-widget.hidden .weather-widget-divider,
        .weather-widget.hidden .weather-widget-details,
        .weather-widget.hidden .weather-widget-time {
            display: none;
        }
        
        .weather-widget.hidden .weather-widget-icon {
            font-size: 28px;
        }
        
        .weather-widget.hidden .weather-widget-header {
            margin: 0;
            justify-content: center;
        }
        
        .weather-widget-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .weather-widget-icon {
            font-size: 42px;
            line-height: 1;
        }
        
        .weather-widget-temp {
            font-size: 32px;
            font-weight: 300;
        }
        
        .weather-widget-temp .unit {
            font-size: 18px;
            opacity: 0.7;
        }
        
        .weather-widget-condition {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .weather-widget-description {
            font-size: 12px;
            opacity: 0.6;
            text-transform: capitalize;
        }
        
        .weather-widget-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 12px 0;
        }
        
        .weather-widget-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .weather-widget-detail {
            text-align: center;
        }
        
        .weather-widget-detail-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .weather-widget-detail-label {
            opacity: 0.5;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .weather-widget-time {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .weather-widget-clock {
            font-size: 24px;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }
        
        .weather-widget-period {
            font-size: 14px;
            opacity: 0.8;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
        }
        
        /* ═══════════════════════════════════════════════════════════
           PORTRAIT CLOCK — Large standalone clock for mobile portrait.
           Sits in the top-right dead space, hidden on desktop/landscape.
           ═══════════════════════════════════════════════════════════ */
        .portrait-clock {
            display: none;  /* Hidden by default — only shown on mobile portrait */
        }
        
        /* ═══════════════════════════════════════════════════════════
           MOBILE PORTRAIT LAYOUT
           On portrait phones, we position the weather widget in the
           top-left corner where it can toggle on/off smoothly.
           When expanded, the image gets slightly shrunk to avoid overlap.
           When collapsed, image uses full space.
           
           Detection: max-width 480px AND portrait orientation.
           ═══════════════════════════════════════════════════════════ */
        @media (max-width: 480px) and (orientation: portrait) {
            /* ── Portrait: ensure dark background for any visible areas ──── */
            .display-container {
                background: #1a1a2e;
            }
            
            /* ── Portrait: constrain image to fit viewport with space for UI elements ──── */
            .image-layer {
                /* Center image in the available space, accounting for notch */
                /* Fallbacks for Chrome which doesn't support env() */
                padding-top: 100px;
                padding-top: max(100px, calc(env(safe-area-inset-top, 0px) + 50px));
                padding-bottom: 60px;
                padding-bottom: max(60px, calc(env(safe-area-inset-bottom, 0px) + 40px));
                box-sizing: border-box;
            }
            
            .image-layer img {
                /* Constrain to fit within padded area */
                max-height: calc(100dvh - 140px);
                max-width: 100vw;
                width: auto;
                height: auto;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }
            
            .weather-widget {
                /* Reposition to top-left corner, accounting for notch */
                /* Use max() for Chrome fallback (doesn't support env() properly) */
                top: 55px; /* Fallback for browsers without env() support */
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                bottom: auto;
                left: 12px;
                right: auto;
                transform: none;
                
                /* Horizontal bar layout for mobile */
                min-width: auto;
                max-width: 65vw;
                width: auto;
                padding: 10px 14px;
                border-radius: 16px;
                
                /* Horizontal flex layout */
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 8px;
            }
            
            /* Collapsed state positioning */
            .weather-widget.collapsed {
                top: 55px;
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                left: 20px;
            }
            
            /* Horizontal layout for the header */
            .weather-widget-header {
                margin-bottom: 0;
                gap: 6px;
                flex-shrink: 0;
            }
            
            .weather-widget-icon {
                font-size: 24px;
            }
            
            .weather-widget-temp {
                font-size: 20px;
            }
            
            .weather-widget-temp .unit {
                font-size: 12px;
            }
            
            .weather-widget-condition {
                font-size: 12px;
                margin-bottom: 0;
            }
            
            .weather-widget-description {
                font-size: 9px;
                display: none; /* Hide description to save space */
            }
            
            .weather-widget-divider {
                display: none; /* Hide divider in horizontal mode */
            }
            
            .weather-widget-details {
                font-size: 10px;
                flex-direction: row;
                gap: 12px;
                margin-left: auto;
            }
            
            .weather-widget-detail-value {
                font-size: 12px;
            }
            
            .weather-widget-detail-label {
                font-size: 8px;
            }
            
            .weather-widget-time {
                display: none; /* Clock shown separately on portrait */
            }
            
            .weather-widget-clock {
                font-size: 16px;
            }
            
            .weather-widget-period {
                font-size: 12px;
                padding: 3px 8px;
            }
            
            /* Hide the clock row inside the weather widget on portrait */
            .weather-widget-time {
                display: none;
            }
            
            /* Portrait clock - top right with proper padding */
            .portrait-clock {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                position: fixed;
                top: 55px; /* Fallback for Chrome */
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                right: 15px;
                z-index: 15;
                color: white;
                text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            }
            
            .portrait-clock-time {
                font-size: 36px;
                font-weight: 200;
                letter-spacing: 1px;
                font-variant-numeric: tabular-nums;
                line-height: 1;
            }
            
            .portrait-clock-period {
                font-size: 11px;
                font-weight: 500;
                opacity: 0.9;
                margin-top: 4px;
                background: rgba(0,0,0,0.4);
                padding: 3px 8px;
                border-radius: 6px;
            }
            
            /* End portrait clock */
            /* Hide title overlay on mobile - it clutters the display */
            .title-overlay {
                display: none !important;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════
           MOBILE LANDSCAPE LAYOUT
           On landscape phones, the square image fills the viewport
           height, leaving dead space on left and right. We shift
           the image to the right and dock the weather widget in
           the left dead space so they don't overlap.
           
           Detection: max-height 480px AND landscape orientation.
           ═══════════════════════════════════════════════════════════ */
        @media (max-height: 480px) and (orientation: landscape) {
            /* ── Phone Landscape: Optimized two-handed layout ──── */
            .display-container {
                background: #1a1a2e;
                justify-content: center; /* Center image, use margins for UI */
                padding: 0;
            }
            
            /* ── Phone Landscape: Image positioning - center with margin clearance ──── */
            .image-layer {
                padding: 12px 80px 12px 60px; /* Margin for left UI and right controls */
                box-sizing: border-box;
            }
            
            .image-layer img {
                /* Optimize for landscape aspect ratio viewing */
                max-height: calc(100vh - 24px);
                max-width: calc(100vw - 140px); /* Account for left and right UI margins */
                width: auto;
                height: auto;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }
            
            /* ── Phone Landscape: Weather widget - ultra-compact left margin ──── */
            .weather-widget {
                position: fixed;
                top: 50%;
                left: 8px;
                left: max(8px, calc(env(safe-area-inset-left, 0px) + 8px));
                transform: translateY(-50%);
                bottom: auto;
                right: auto;
                
                /* Ultra-compact vertical strip - 40px width as per spec */
                width: 40px;
                min-width: 40px;
                max-width: 40px;
                height: auto;
                max-height: 200px;
                padding: 12px 6px;
                border-radius: 20px;
                
                /* Vertical compact layout */
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                
                /* Enhanced visual prominence for small size */
                background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(30,30,50,0.9) 100%);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.15);
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            }
            
            /* Compact weather widget content for landscape */
            .weather-widget-header {
                flex-direction: column;
                align-items: center;
                gap: 4px;
                margin-bottom: 0;
                width: 100%;
            }
            
            .weather-widget-icon {
                font-size: 20px;
                line-height: 1;
            }
            
            .weather-widget-temp {
                font-size: 14px;
                font-weight: 700;
                text-align: center;
                line-height: 1;
            }
            
            .weather-widget-temp .unit {
                font-size: 10px;
                opacity: 0.8;
            }
            
            .weather-widget-condition {
                display: none; /* Too narrow for text */
            }
            
            .weather-widget-description {
                display: none; /* Too narrow for text */
            }
            
            .weather-widget-divider {
                width: 20px;
                height: 1px;
                background: rgba(255,255,255,0.2);
                margin: 6px 0;
                display: block;
            }
            
            .weather-widget-details {
                display: none; /* Save space in ultra-compact mode */
            }
            
            .weather-widget-time {
                display: none; /* Separate landscape clock used */
            }
            
            /* ── Phone Landscape: Dedicated landscape clock - bottom-right ──── */
            .landscape-clock {
                position: fixed;
                bottom: 12px;
                bottom: max(12px, calc(env(safe-area-inset-bottom, 0px) + 8px));
                right: 12px;
                right: max(12px, calc(env(safe-area-inset-right, 0px) + 12px));
                display: flex;
                align-items: baseline;
                gap: 6px;
                color: white;
                text-shadow: 0 2px 8px rgba(0,0,0,0.7);
                background: rgba(0,0,0,0.3);
                backdrop-filter: blur(8px);
                padding: 6px 12px;
                border-radius: 16px;
                border: 1px solid rgba(255,255,255,0.1);
                z-index: 15;
            }
            
            .landscape-clock-time {
                font-size: 16px; /* Small format as per spec */
                font-weight: 600;
                font-variant-numeric: tabular-nums;
                line-height: 1;
            }
            
            .landscape-clock-period {
                font-size: 12px;
                font-weight: 500;
                opacity: 0.8;
            }
            
            /* ── Phone Landscape: Status overlay - left side vertical stack ──── */
            .status-overlay {
                position: fixed;
                top: 50%;
                left: 58px; /* Right of weather widget */
                left: max(58px, calc(env(safe-area-inset-left, 0px) + 58px));
                bottom: auto;
                right: auto;
                transform: translateY(-50%);
                
                /* Vertical stack layout */
                flex-direction: column;
                align-items: flex-start;
                padding: 8px 12px;
                border-radius: 16px;
                font-size: 12px;
                gap: 8px;
                min-height: auto;
                width: auto;
                max-width: 120px;
                
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                border: 1px solid rgba(255,255,255,0.1);
            }
            
            .status-overlay.collapsed {
                width: 36px;
                height: 36px;
                min-height: 36px;
                border-radius: 50%;
                padding: 0;
                justify-content: center;
                align-items: center;
                flex-direction: row;
            }
            
            .status-item {
                gap: 6px;
                font-size: 11px;
                width: 100%;
            }
            
            .status-item .icon {
                font-size: 14px;
            }
            
            .status-item .value {
                font-size: 12px;
                font-weight: 600;
            }
            
            .status-item .label {
                font-size: 10px;
                opacity: 0.7;
                line-height: 1.2;
            }
            
            /* ── Phone Landscape: Command center - right side, two-handed accessible ──── */
            .command-center {
                position: fixed;
                top: 50%;
                right: 12px;
                right: max(12px, calc(env(safe-area-inset-right, 0px) + 12px));
                bottom: auto;
                transform: translateY(-50%);
            }
            
            .command-center-button {
                width: 48px; /* Optimized for two-handed landscape use */
                height: 48px;
                font-size: 20px;
                box-shadow: 0 4px 16px rgba(100, 100, 180, 0.4);
            }
            
            .command-center-popup {
                bottom: auto;
                top: -10px; /* Above button */
                right: 0;
                gap: 8px;
                transform: translateY(-100%);
            }
            
            .command-center-icon {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            /* ── Phone Landscape: Hide elements not needed ──── */
            .portrait-clock {
                display: none !important;
            }
            
            .title-overlay {
                display: none !important; /* No space in landscape */
            }
            
            /* ── Phone Landscape: Image control panel ──── */
            .image-control-panel {
                top: 20px;
                right: 12px;
                right: max(12px, calc(env(safe-area-inset-right, 0px) + 12px));
                bottom: auto;
                min-width: 200px;
                max-width: 220px;
                border-radius: 16px;
                padding: 16px;
            }
            
            .image-control-btn {
                padding: 10px 12px;
                border-radius: 10px;
                font-size: 13px;
                min-height: 40px; /* Smaller for landscape */
            }
            
            .image-control-btn-icon {
                font-size: 18px;
            }
            
            /* ── Phone Landscape: Fullscreen button ──── */
            .fullscreen-btn {
                bottom: 12px;
                bottom: max(12px, calc(env(safe-area-inset-bottom, 0px) + 8px));
                right: 70px; /* Left of landscape clock */
                right: max(70px, calc(env(safe-area-inset-right, 0px) + 70px));
                top: auto;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════
           IPAD PORTRAIT LAYOUT
           On iPad portrait, we have generous screen space to create
           an elegant layout with large touch targets. Weather widget
           in top-left, clock in top-right, centered image, status bar
           at bottom-left, command center at bottom-right.
           
           Detection: 481px-1024px width AND portrait orientation.
           ═══════════════════════════════════════════════════════════ */
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: portrait) {
            /* ── iPad Portrait: Premium experience with generous spacing ──── */
            .display-container {
                background: #1a1a2e;
                padding: 20px;
            }
            
            /* ── iPad Portrait: Image positioning with elegant margins ──── */
            .image-layer {
                /* Reserve space for top and bottom UI bars */
                padding-top: 100px; /* Space for top widgets */
                padding-bottom: 100px; /* Space for bottom widgets */
                padding-left: 20px;
                padding-right: 20px;
                box-sizing: border-box;
            }
            
            .image-layer img {
                /* Optimize for iPad portrait viewing */
                max-width: 85vw;
                max-height: calc(100vh - 220px); /* Account for top/bottom UI */
                width: auto;
                height: auto;
                border-radius: 16px;
                box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            }
            
            /* ── iPad Portrait: Weather widget - top-left, expandable ──── */
            .weather-widget {
                top: 30px;
                left: 30px;
                bottom: auto;
                right: auto;
                transform: none;
                
                /* Full vertical layout for iPad */
                min-width: 280px;
                max-width: 320px;
                width: auto;
                padding: 24px;
                border-radius: 20px;
                
                /* Vertical flex layout */
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            /* iPad weather widget styling */
            .weather-widget-header {
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 0;
            }
            
            .weather-widget-icon {
                font-size: 48px;
                flex-shrink: 0;
            }
            
            .weather-widget-temp {
                font-size: 36px;
                font-weight: 300;
            }
            
            .weather-widget-temp .unit {
                font-size: 20px;
            }
            
            .weather-widget-condition {
                font-size: 18px;
                font-weight: 500;
                margin-bottom: 4px;
            }
            
            .weather-widget-description {
                font-size: 14px;
                opacity: 0.7;
                display: block; /* Show full description on iPad */
            }
            
            .weather-widget-divider {
                height: 1px;
                background: rgba(255,255,255,0.1);
                margin: 16px 0;
                display: block;
            }
            
            .weather-widget-details {
                display: flex;
                justify-content: space-between;
                font-size: 14px;
            }
            
            .weather-widget-detail-value {
                font-weight: 600;
                font-size: 16px;
            }
            
            .weather-widget-detail-label {
                opacity: 0.6;
                font-size: 12px;
            }
            
            .weather-widget-time {
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid rgba(255,255,255,0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .weather-widget-clock {
                font-size: 28px;
                font-weight: 300;
                font-variant-numeric: tabular-nums;
            }
            
            .weather-widget-period {
                font-size: 16px;
                opacity: 0.9;
                background: rgba(255,255,255,0.1);
                padding: 6px 12px;
                border-radius: 12px;
            }
            
            /* ── iPad Portrait: Status overlay - bottom-left ──── */
            .status-overlay {
                bottom: 30px;
                left: 30px;
                top: auto;
                right: auto;
                transform: none;
                
                /* Horizontal bar layout optimized for iPad */
                padding: 16px 24px;
                border-radius: 24px;
                font-size: 16px;
                gap: 24px;
                min-height: 60px; /* Generous touch target */
            }
            
            .status-overlay.collapsed {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                padding: 0;
                min-height: 60px;
            }
            
            .status-item {
                gap: 10px;
            }
            
            .status-item .icon {
                font-size: 22px;
            }
            
            .status-item .value {
                font-size: 16px;
                font-weight: 600;
            }
            
            .status-item .label {
                font-size: 14px;
                opacity: 0.8;
            }
            
            /* ── iPad Portrait: Command center - bottom-right ──── */
            .command-center {
                bottom: 30px;
                right: 30px;
            }
            
            .command-center-button {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 50%;
                /* Enhanced shadow for iPad */
                box-shadow: 0 6px 30px rgba(100, 100, 180, 0.4);
            }
            
            .command-center-button:hover {
                transform: scale(1.1);
            }
            
            /* Command center popup positioning for iPad */
            .command-center-popup {
                bottom: 80px;
                right: 0;
                gap: 16px;
            }
            
            .command-center-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
                border-radius: 50%;
            }
            
            .command-center-icon:hover {
                transform: scale(1.15);
                box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
            }
            
            /* ── iPad Portrait: Image control panel ──── */
            .image-control-panel {
                bottom: 120px;
                right: 30px;
                min-width: 280px;
                border-radius: 24px;
                padding: 20px;
            }
            
            .image-control-btn {
                padding: 18px 20px;
                border-radius: 16px;
                font-size: 16px;
                min-height: 60px; /* iPad-optimized touch targets */
            }
            
            .image-control-btn-icon {
                font-size: 24px;
            }
            
            /* ── iPad Portrait: Hide elements not needed ──── */
            .portrait-clock {
                display: none !important; /* Weather widget includes time */
            }
            
            .title-overlay {
                /* Show title overlay on iPad with larger text */
                display: block !important;
                top: 30px;
                font-size: 18px;
                padding: 12px 24px;
                border-radius: 16px;
                max-width: 70%;
            }
            
            /* ── iPad Portrait: Fullscreen button positioning ──── */
            .fullscreen-btn {
                bottom: 30px;
                right: 120px; /* Position left of command center */
                width: 52px;
                height: 52px;
                font-size: 24px;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                opacity: 0.6;
            }
            
            .fullscreen-btn:hover {
                opacity: 1;
                transform: scale(1.1);
                background: rgba(255, 255, 255, 0.2);
            }
            
            /* ── iPad Portrait: Enhanced safe area handling ──── */
            .weather-widget {
                top: max(30px, calc(env(safe-area-inset-top, 0px) + 20px));
            }
            
            .status-overlay,
            .command-center,
            .fullscreen-btn {
                bottom: max(30px, calc(env(safe-area-inset-bottom, 0px) + 20px));
            }
        }
        
        /* ═══════════════════════════════════════════════════════════
           IPAD LANDSCAPE LAYOUT
           On iPad landscape, we use a multi-column layout with the
           weather widget as a left sidebar, image in the center-right
           area, and other controls distributed horizontally across
           the top and bottom.
           
           Detection: 769px-1199px width AND landscape orientation.
           ═══════════════════════════════════════════════════════════ */
        @media (min-width: 769px) and (max-width: 1199px) and (orientation: landscape) {
            /* ── iPad Landscape: Multi-column layout foundation ──── */
            .display-container {
                background: #1a1a2e;
                display: flex;
                flex-direction: row;
                align-items: stretch;
                padding: 0;
            }
            
            /* ── iPad Landscape: Image positioning - center-right ──── */
            .image-layer {
                /* Flex item that takes remaining space after sidebar */
                flex: 1;
                padding: 20px 30px 20px 0; /* No left padding - sidebar provides space */
                box-sizing: border-box;
                position: relative;
                
                /* Center image in available area */
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .image-layer img {
                /* Optimize for landscape viewing */
                max-width: 100%;
                max-height: calc(100vh - 40px); /* Account for padding */
                width: auto;
                height: auto;
                border-radius: 16px;
                box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            }
            
            /* ── iPad Landscape: Weather widget - left sidebar ──── */
            .weather-widget {
                /* Fixed sidebar positioning */
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: none;
                
                /* Sidebar layout */
                width: 280px;
                height: 100vh;
                padding: 30px 24px;
                border-radius: 0 24px 24px 0; /* Rounded right side only */
                
                /* Vertical flex layout for sidebar */
                display: flex;
                flex-direction: column;
                gap: 20px;
                
                /* Enhanced background for sidebar prominence */
                background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(30,30,50,0.95) 100%);
                backdrop-filter: blur(20px);
                border-right: 1px solid rgba(255,255,255,0.1);
                box-shadow: 4px 0 20px rgba(0,0,0,0.3);
            }
            
            /* iPad landscape weather widget content */
            .weather-widget-header {
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 0;
            }
            
            .weather-widget-icon {
                font-size: 52px;
                flex-shrink: 0;
            }
            
            .weather-widget-temp {
                font-size: 40px;
                font-weight: 300;
                line-height: 1.2;
            }
            
            .weather-widget-temp .unit {
                font-size: 22px;
                opacity: 0.8;
            }
            
            .weather-widget-condition {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 6px;
                color: rgba(255,255,255,0.95);
            }
            
            .weather-widget-description {
                font-size: 16px;
                opacity: 0.7;
                display: block;
                text-transform: capitalize;
            }
            
            .weather-widget-divider {
                height: 2px;
                background: linear-gradient(90deg, rgba(255,255,255,0.2) 0%, transparent 100%);
                margin: 20px 0;
                display: block;
                border-radius: 1px;
            }
            
            .weather-widget-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px 12px;
                font-size: 14px;
            }
            
            .weather-widget-detail {
                text-align: center;
                padding: 12px 8px;
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
                transition: background 0.2s ease;
            }
            
            .weather-widget-detail:hover {
                background: rgba(255,255,255,0.1);
            }
            
            .weather-widget-detail-value {
                font-weight: 700;
                font-size: 18px;
                display: block;
                margin-bottom: 4px;
            }
            
            .weather-widget-detail-label {
                opacity: 0.6;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .weather-widget-time {
                margin-top: auto; /* Push to bottom of sidebar */
                padding-top: 24px;
                border-top: 1px solid rgba(255,255,255,0.1);
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .weather-widget-clock {
                font-size: 32px;
                font-weight: 200;
                font-variant-numeric: tabular-nums;
                text-align: center;
            }
            
            .weather-widget-period {
                font-size: 18px;
                opacity: 0.9;
                background: rgba(255,255,255,0.1);
                padding: 8px 16px;
                border-radius: 16px;
                text-align: center;
                font-weight: 500;
            }
            
            /* ── iPad Landscape: Adjust image container for sidebar ──── */
            .image-layer {
                /* Account for sidebar width */
                margin-left: 280px;
                width: calc(100vw - 280px);
                flex: none; /* Override flex: 1 */
            }
            
            /* ── iPad Landscape: Status overlay - bottom distributed ──── */
            .status-overlay {
                position: fixed;
                bottom: 30px;
                left: 320px; /* After sidebar + margin */
                right: 30px;
                top: auto;
                transform: none;
                
                /* Wide horizontal layout */
                padding: 16px 32px;
                border-radius: 24px;
                font-size: 16px;
                gap: 32px;
                min-height: 64px;
                
                /* Distribute items across width */
                display: flex;
                justify-content: space-between;
                align-items: center;
                
                /* Enhanced styling for landscape prominence */
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            }
            
            .status-overlay.collapsed {
                width: 64px;
                height: 64px;
                left: auto;
                right: 160px; /* Position near command center */
                justify-content: center;
                gap: 0;
            }
            
            .status-item {
                gap: 12px;
                flex: 1;
                justify-content: center;
            }
            
            .status-item .icon {
                font-size: 24px;
            }
            
            .status-item .value {
                font-size: 18px;
                font-weight: 700;
            }
            
            .status-item .label {
                font-size: 14px;
                opacity: 0.8;
            }
            
            /* ── iPad Landscape: Command center - top-right ──── */
            .command-center {
                position: fixed;
                top: 30px;
                right: 30px;
                bottom: auto;
            }
            
            .command-center-button {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 50%;
                box-shadow: 0 6px 30px rgba(100, 100, 180, 0.4);
            }
            
            .command-center-button:hover {
                transform: scale(1.1);
            }
            
            /* Command center popup positioning for landscape */
            .command-center-popup {
                bottom: auto;
                top: 80px;
                right: 0;
                gap: 16px;
            }
            
            .command-center-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
                border-radius: 50%;
            }
            
            /* ── iPad Landscape: Image control panel ──── */
            .image-control-panel {
                position: fixed;
                top: 120px;
                right: 30px;
                bottom: auto;
                min-width: 280px;
                border-radius: 24px;
                padding: 20px;
            }
            
            /* ── iPad Landscape: Additional elements ──── */
            .portrait-clock {
                display: none !important; /* Sidebar clock takes precedence */
            }
            
            .title-overlay {
                /* Position in top center area */
                display: block !important;
                top: 30px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 18px;
                padding: 12px 24px;
                border-radius: 16px;
                max-width: 60%;
                margin-left: 140px; /* Offset for sidebar */
            }
            
            .fullscreen-btn {
                position: fixed;
                top: 30px;
                right: 120px; /* Left of command center */
                bottom: auto;
                width: 52px;
                height: 52px;
                font-size: 24px;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                opacity: 0.6;
            }
            
            .fullscreen-btn:hover {
                opacity: 1;
                transform: scale(1.1);
                background: rgba(255, 255, 255, 0.2);
            }
            
            /* ── iPad Landscape: Enhanced safe area handling ──── */
            .weather-widget {
                left: max(0px, env(safe-area-inset-left, 0px));
                padding-left: max(24px, calc(env(safe-area-inset-left, 0px) + 24px));
                padding-right: max(24px, calc(env(safe-area-inset-right, 0px) + 24px));
            }
            
            .status-overlay {
                left: max(320px, calc(280px + env(safe-area-inset-left, 0px) + 40px));
                right: max(30px, calc(env(safe-area-inset-right, 0px) + 30px));
                bottom: max(30px, calc(env(safe-area-inset-bottom, 0px) + 20px));
            }
            
            .command-center,
            .fullscreen-btn {
                top: max(30px, calc(env(safe-area-inset-top, 0px) + 20px));
                right: max(30px, calc(env(safe-area-inset-right, 0px) + 30px));
            }
        }
        
        /* ═══════════════════════════════════════════════════════════
           DESKTOP LAYOUT
           On desktop screens, we create a rich multi-column layout
           with sidebars for information density and advanced features.
           Left sidebar has weather and additional widgets, center has
           the image, and right sidebar has metadata and controls.
           
           Detection: 1200px+ width (any orientation).
           ═══════════════════════════════════════════════════════════ */
        @media (min-width: 1200px) {
            /* ── Desktop: Three-column layout foundation ──── */
            body {
                overflow-y: auto; /* Allow vertical scrolling on desktop */
                height: auto;
            }
            
            .display-container {
                background: #1a1a2e;
                display: grid;
                grid-template-columns: 320px 1fr 300px; /* Left sidebar | Main | Right sidebar */
                grid-template-rows: auto 1fr auto; /* Header | Content | Footer */
                grid-template-areas:
                    "header header header"
                    "sidebar-left main sidebar-right"
                    "footer footer footer";
                min-height: 100vh;
                padding: 0;
                overflow: visible;
            }
            
            /* ── Desktop: Left sidebar - weather and additional widgets ──── */
            .weather-widget {
                position: static;
                transform: none;
                grid-area: sidebar-left;
                width: 100%;
                height: fit-content;
                max-height: none;
                padding: 30px 24px;
                margin: 20px 0 0 20px;
                border-radius: 0 20px 20px 0;
                
                /* Enhanced desktop styling */
                background: linear-gradient(145deg, rgba(0,0,0,0.95) 0%, rgba(30,30,60,0.98) 100%);
                backdrop-filter: blur(25px);
                border-right: 2px solid rgba(255,255,255,0.1);
                border-top: 1px solid rgba(255,255,255,0.05);
                box-shadow: 4px 0 30px rgba(0,0,0,0.4);
                
                /* Full vertical layout for desktop */
                display: flex;
                flex-direction: column;
                gap: 24px;
            }
            
            /* Desktop weather widget content */
            .weather-widget-header {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 0;
                padding-bottom: 20px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            
            .weather-widget-icon {
                font-size: 64px;
                flex-shrink: 0;
                filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            }
            
            .weather-widget-temp {
                font-size: 48px;
                font-weight: 100;
                line-height: 1;
                color: rgba(255,255,255,0.95);
            }
            
            .weather-widget-temp .unit {
                font-size: 24px;
                opacity: 0.7;
                vertical-align: top;
            }
            
            .weather-widget-condition {
                font-size: 22px;
                font-weight: 600;
                margin-bottom: 8px;
                color: rgba(255,255,255,0.9);
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .weather-widget-description {
                font-size: 16px;
                opacity: 0.7;
                display: block;
                text-transform: capitalize;
                line-height: 1.4;
            }
            
            .weather-widget-divider {
                height: 2px;
                background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
                margin: 20px 0;
                display: block;
                border-radius: 1px;
            }
            
            .weather-widget-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                font-size: 14px;
            }
            
            .weather-widget-detail {
                text-align: center;
                padding: 16px 12px;
                background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
                border-radius: 16px;
                border: 1px solid rgba(255,255,255,0.05);
                transition: all 0.3s ease;
                cursor: default;
            }
            
            .weather-widget-detail:hover {
                background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
                border-color: rgba(255,255,255,0.2);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            }
            
            .weather-widget-detail-value {
                font-weight: 700;
                font-size: 20px;
                display: block;
                margin-bottom: 6px;
                color: rgba(255,255,255,0.95);
            }
            
            .weather-widget-detail-label {
                opacity: 0.6;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                font-weight: 600;
            }
            
            .weather-widget-time {
                margin-top: 24px;
                padding: 24px 20px;
                background: linear-gradient(135deg, rgba(100,100,180,0.15) 0%, rgba(80,80,140,0.05) 100%);
                border-radius: 20px;
                border: 1px solid rgba(100,100,180,0.2);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .weather-widget-clock {
                font-size: 36px;
                font-weight: 200;
                font-variant-numeric: tabular-nums;
                text-align: center;
                color: rgba(255,255,255,0.95);
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .weather-widget-period {
                font-size: 16px;
                opacity: 0.8;
                background: rgba(255,255,255,0.1);
                padding: 8px 20px;
                border-radius: 20px;
                text-align: center;
                font-weight: 600;
                letter-spacing: 1px;
            }
            
            /* ── Desktop: Main image area - center column ──── */
            .image-layer {
                grid-area: main;
                padding: 40px;
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 600px;
            }
            
            .image-layer img {
                /* High resolution display for desktop */
                max-width: 100%;
                max-height: calc(100vh - 120px);
                width: auto;
                height: auto;
                border-radius: 20px;
                box-shadow: 
                    0 25px 60px rgba(0,0,0,0.5),
                    0 8px 30px rgba(0,0,0,0.3),
                    inset 0 1px 0 rgba(255,255,255,0.1);
                transition: all 0.3s ease;
            }
            
            .image-layer img:hover {
                transform: scale(1.02);
                box-shadow: 
                    0 35px 80px rgba(0,0,0,0.6),
                    0 12px 40px rgba(0,0,0,0.4),
                    inset 0 1px 0 rgba(255,255,255,0.1);
            }
            
            /* ── Desktop: Right sidebar - metadata and controls ──── */
            .desktop-info-panel {
                grid-area: sidebar-right;
                padding: 30px 20px;
                margin: 20px 20px 0 0;
                background: linear-gradient(145deg, rgba(20,20,40,0.95) 0%, rgba(40,40,70,0.9) 100%);
                backdrop-filter: blur(20px);
                border-radius: 20px 0 0 20px;
                border-left: 2px solid rgba(255,255,255,0.1);
                border-top: 1px solid rgba(255,255,255,0.05);
                box-shadow: -4px 0 30px rgba(0,0,0,0.3);
                color: white;
                overflow-y: auto;
                max-height: calc(100vh - 40px);
            }
            
            .desktop-info-title {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 20px;
                padding-bottom: 16px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                color: rgba(255,255,255,0.95);
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .desktop-info-section {
                margin-bottom: 24px;
            }
            
            .desktop-info-section-title {
                font-size: 14px;
                font-weight: 600;
                color: rgba(255,255,255,0.8);
                margin-bottom: 12px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .desktop-info-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                font-size: 14px;
            }
            
            .desktop-info-item:last-child {
                border-bottom: none;
            }
            
            .desktop-info-label {
                opacity: 0.7;
                font-weight: 500;
            }
            
            .desktop-info-value {
                font-weight: 600;
                color: rgba(255,255,255,0.95);
                text-align: right;
                word-break: break-word;
                max-width: 60%;
            }
            
            /* ── Desktop: Status bar - full width footer ──── */
            .status-overlay {
                position: static;
                grid-area: footer;
                transform: none;
                bottom: auto;
                left: auto;
                right: auto;
                
                /* Full width horizontal layout */
                width: 100%;
                padding: 16px 40px;
                border-radius: 0;
                border-top: 2px solid rgba(255,255,255,0.1);
                font-size: 14px;
                gap: 40px;
                min-height: 60px;
                margin: 20px 0 0 0;
                
                /* Enhanced footer styling */
                background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(20,20,40,0.95) 100%);
                backdrop-filter: blur(15px);
                
                /* Distribute items across full width */
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .status-overlay.collapsed {
                /* Disable collapsed state on desktop */
                width: 100%;
                height: auto;
                min-height: 60px;
                border-radius: 0;
                padding: 16px 40px;
                justify-content: space-between;
            }
            
            .status-item {
                gap: 12px;
                font-size: 14px;
                padding: 8px 16px;
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
                transition: all 0.3s ease;
                cursor: default;
                border: 1px solid rgba(255,255,255,0.1);
            }
            
            .status-item:hover {
                background: rgba(255,255,255,0.1);
                border-color: rgba(255,255,255,0.2);
                transform: translateY(-2px);
            }
            
            .status-item .icon {
                font-size: 18px;
            }
            
            .status-item .value {
                font-size: 16px;
                font-weight: 700;
            }
            
            .status-item .label {
                font-size: 12px;
                opacity: 0.8;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            /* ── Desktop: Command center - bottom-right with hover states ──── */
            .command-center {
                position: fixed;
                bottom: 30px;
                right: 30px;
                top: auto;
            }
            
            .command-center-button {
                width: 72px;
                height: 72px;
                font-size: 32px;
                border-radius: 50%;
                box-shadow: 0 8px 32px rgba(100, 100, 180, 0.4);
                transition: all 0.3s ease;
            }
            
            .command-center-button:hover {
                transform: scale(1.15);
                box-shadow: 0 12px 40px rgba(100, 100, 180, 0.6);
                background: linear-gradient(135deg, rgba(120, 120, 200, 0.9) 0%, rgba(100, 100, 160, 0.95) 100%);
            }
            
            /* Command center popup positioning for desktop */
            .command-center-popup {
                bottom: 88px;
                right: 0;
                gap: 12px;
            }
            
            .command-center-icon {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 50%;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .command-center-icon:hover {
                transform: scale(1.2);
                box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
            }
            
            /* Hover tooltips for desktop */
            .command-center-icon::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%) translateY(-8px);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease, transform 0.3s ease;
                z-index: 100;
            }
            
            .command-center-icon:hover::after {
                opacity: 1;
                transform: translateX(-50%) translateY(-4px);
            }
            
            /* ── Desktop: Hide elements not needed ──── */
            .portrait-clock,
            .landscape-clock {
                display: none !important; /* Weather widget has integrated clock */
            }
            
            .title-overlay {
                /* Position in top center, above main area */
                display: block !important;
                position: static;
                grid-area: header;
                transform: none;
                top: auto;
                left: auto;
                margin: 20px 40px 0;
                font-size: 24px;
                font-weight: 700;
                padding: 20px 32px;
                border-radius: 16px;
                text-align: center;
                max-width: none;
                background: linear-gradient(135deg, rgba(100,100,180,0.2) 0%, rgba(80,80,140,0.1) 100%);
                border: 1px solid rgba(100,100,180,0.3);
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            /* ── Desktop: Image control panel ──── */
            .image-control-panel {
                position: relative;
                top: auto;
                right: auto;
                bottom: auto;
                grid-area: sidebar-right;
                margin-top: 24px;
                min-width: auto;
                border-radius: 16px;
                padding: 20px;
                background: linear-gradient(145deg, rgba(60,60,100,0.2) 0%, rgba(40,40,80,0.1) 100%);
                border: 1px solid rgba(255,255,255,0.1);
            }
            
            .image-control-btn {
                padding: 14px 18px;
                border-radius: 12px;
                font-size: 15px;
                min-height: auto;
                transition: all 0.3s ease;
            }
            
            .image-control-btn:hover {
                transform: translateX(4px);
                box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            }
            
            /* ── Desktop: Additional sidebar widgets space ──── */
            .desktop-additional-widgets {
                margin-top: 30px;
                padding-top: 24px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .desktop-widget {
                margin-bottom: 20px;
                padding: 20px;
                background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
                border-radius: 16px;
                border: 1px solid rgba(255,255,255,0.1);
                transition: all 0.3s ease;
            }
            
            .desktop-widget:hover {
                background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%);
                border-color: rgba(255,255,255,0.2);
            }
            
            .desktop-widget-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 12px;
                color: rgba(255,255,255,0.9);
            }
            
            /* ── Desktop: Responsive adjustments ──── */
            @media (max-width: 1400px) {
                .display-container {
                    grid-template-columns: 280px 1fr 260px;
                }
                
                .weather-widget {
                    padding: 24px 20px;
                }
                
                .weather-widget-temp {
                    font-size: 40px;
                }
                
                .weather-widget-icon {
                    font-size: 56px;
                }
            }
            
            @media (min-width: 1600px) {
                .display-container {
                    grid-template-columns: 360px 1fr 320px;
                }
                
                .weather-widget {
                    padding: 36px 28px;
                }
            }
        }
        
        /* Update indicator */
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 200, 100, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 10;
        }
        
        .update-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Loading spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 5;
        }
        
        .loading-spinner.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Image title overlay */
        .title-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
            max-width: 80%;
            z-index: 10;
        }
        
        .title-overlay.visible {
            opacity: 1;
        }
        
        /* Hide title overlay on ALL mobile devices (< 768px) */
        @media (max-width: 768px) {
            .title-overlay,
            .title-overlay.visible {
                display: none !important;
                opacity: 0 !important;
            }
        }
        
        /* Debug panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            display: none;
            max-width: 300px;
            z-index: 20;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Fullscreen button */
        .fullscreen-btn {
            position: fixed;
            bottom: max(20px, calc(10px + env(safe-area-inset-bottom, 10px)));
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            opacity: 0.3;
            transition: opacity 0.3s, transform 0.2s;
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* Error state */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(255, 100, 100, 0.3);
            color: white;
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            display: none;
            z-index: 15;
            backdrop-filter: blur(10px);
            max-width: 85vw;
            width: auto;
            min-width: 280px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .error-message.show {
            display: block;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .error-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .error-detail {
            font-size: 13px;
            opacity: 0.7;
            margin-bottom: 15px;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .error-retry-counter {
            font-size: 13px;
            font-weight: 600;
            color: #ff7043;
            margin-bottom: 10px;
            padding: 4px 12px;
            background: rgba(255, 112, 67, 0.15);
            border-radius: 12px;
            display: inline-block;
        }
        
        .error-retry {
            font-size: 12px;
            opacity: 0.5;
        }
        
        .error-retry .countdown {
            font-weight: 600;
            color: #64b5f6;
        }
        
        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .connection-status.visible {
            opacity: 1;
        }
        
        .connection-status.error {
            background: rgba(255, 80, 80, 0.8);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .connection-status.error .connection-dot {
            background: #fff;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Fallback image styling */
        .fallback-active .image-layer img {
            filter: grayscale(30%) brightness(0.8);
        }
        
        .fallback-badge {
            position: fixed;
            bottom: max(80px, calc(60px + env(safe-area-inset-bottom, 20px)));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 150, 0, 0.9);
            color: white;
            padding: 6px 16px;
            border-radius: 15px;
            font-size: 11px;
            display: none;
            z-index: 10;
        }
        
        .fallback-badge.show {
            display: block;
        }
        
        /* Next update countdown */
        .countdown {
            position: fixed;
            bottom: max(70px, calc(50px + env(safe-area-inset-bottom, 20px)));
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.3);
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .countdown.visible {
            opacity: 1;
        }
        
        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .install-banner.show {
            transform: translateY(0);
        }
        
        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .install-banner-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .install-banner-text {
            color: white;
        }
        
        .install-banner-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .install-banner-subtitle {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .install-banner-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .install-btn:active {
            transform: scale(0.98);
        }
        
        .dismiss-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        
        .dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* iOS Install Instructions Modal */
        .ios-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .ios-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .ios-modal-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 24px;
            padding: 32px 28px;
            max-width: 340px;
            text-align: center;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .ios-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .ios-modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ios-modal-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 24px;
        }
        
        .ios-modal-steps {
            text-align: left;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .ios-modal-step {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: background 0.2s;
        }
        
        .ios-modal-step:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .ios-step-number {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .ios-step-content {
            flex: 1;
        }
        
        .ios-step-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .ios-step-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .ios-share-icon {
            display: inline-block;
            background: #007AFF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            vertical-align: middle;
        }
        
        .ios-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .ios-modal-close {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .ios-modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .ios-modal-close:active {
            transform: translateY(0);
        }
        
        .ios-modal-dismiss {
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            border: none;
            padding: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .ios-modal-dismiss:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .ios-safari-note {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ios-safari-note strong {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .install-banner {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .install-banner-content {
                flex-direction: column;
            }
            
            .install-banner-actions {
                width: 100%;
            }
            
            .install-btn, .dismiss-btn {
                flex: 1;
            }
        }
        
        /* Help overlay */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .help-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .help-content {
            background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 30px 40px;
            max-width: 500px;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .help-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-shortcuts {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px 20px;
        }
        
        .help-key {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            text-align: center;
            min-width: 60px;
        }
        
        .help-desc {
            font-size: 14px;
            opacity: 0.8;
            display: flex;
            align-items: center;
        }
        
        .help-close {
            margin-top: 24px;
            text-align: center;
            font-size: 12px;
            opacity: 0.5;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 300;
            pointer-events: none;
        }
        
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Pause indicator */
        .pause-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 150, 0, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: none;
            z-index: 15;
        }
        
        .pause-indicator.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Image info panel */
        .image-info {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            color: white;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 50;
        }
        
        .image-info.show {
            opacity: 1;
            visibility: visible;
        }
        
        .image-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }
        
        .image-info-row:last-child {
            border-bottom: none;
        }
        
        .image-info-label {
            opacity: 0.6;
        }
        
        .image-info-value {
            font-weight: 500;
        }
        
        /* ═══════════════════════════════════════════════════════════
           COMMAND CENTER
           Bottom-right button that expands to show 3 feature icons:
           Report (🚩), Vacuum (🤖), Lights (💡)
           ═══════════════════════════════════════════════════════════ */
        
        .command-center {
            position: fixed;
            bottom: 24px;
            bottom: max(24px, calc(10px + env(safe-area-inset-bottom, 14px)));
            right: 24px;
            z-index: 60;
        }
        
        /* Mobile Safari toolbar takes ~80px at bottom - position buttons in dark bar below image */
        @media (max-width: 480px) and (orientation: portrait) {
            .command-center {
                top: auto !important;
                bottom: 140px !important;
                right: 20px !important;
                position: fixed !important;
            }
            
            .command-center-button {
                /* Smaller gear button for phone portrait */
                width: 44px;
                height: 44px;
                font-size: 18px;
                box-shadow: 0 3px 12px rgba(100, 100, 180, 0.4);
            }
            
            .command-center-popup {
                /* Expand horizontally to the left instead of vertically */
                bottom: 0;
                right: 52px; /* To the left of 44px button + 8px margin */
                flex-direction: row;
                gap: 8px;
            }
            
            .command-center-icon {
                width: 42px;
                height: 42px;
                font-size: 18px;
            }
            
            .status-overlay {
                bottom: 20px;
                bottom: max(20px, calc(env(safe-area-inset-bottom, 0px) + 10px));
                left: 20px;
                /* Ensure 44px minimum touch target height */
                min-height: 44px;
                padding: 12px 20px;
                font-size: 14px;
                gap: 16px;
            }
            
            .status-overlay.collapsed {
                width: 50px;
                height: 50px;
                min-height: 50px;
                border-radius: 50%;
                padding: 0;
                justify-content: center;
                align-items: center;
            }
            
            .status-item .icon {
                font-size: 18px;
            }
            
            .status-item .value {
                font-size: 14px;
                font-weight: 600;
            }
            
            .status-item .label {
                font-size: 12px;
            }
            
            /* Enhanced weather widget collapsed state for phone portrait */
            .weather-widget.collapsed {
                width: 50px;
                height: 50px;
                min-width: 50px;
                max-width: 50px;
                padding: 8px;
                border-radius: 50%;
            }
            
            .weather-widget.collapsed .weather-widget-icon {
                font-size: 26px;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0;
            }
            
            /* Optimize portrait clock for phone */
            .portrait-clock-time {
                font-size: 32px; /* Slightly smaller for phone screens */
                font-weight: 300;
            }
            
            .portrait-clock-period {
                font-size: 10px;
                padding: 2px 6px;
            }
            
            .fallback-badge {
                bottom: 70px;
            }
            
            .countdown {
                bottom: 60px;
            }
            
            .fullscreen-btn {
                bottom: 20px;
                bottom: max(20px, calc(env(safe-area-inset-bottom, 0px) + 10px));
                width: 44px; /* Ensure 44px minimum touch target */
                height: 44px;
                font-size: 18px;
            }
        }
        
        .command-center-button {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(100, 100, 180, 0.9) 0%, rgba(80, 80, 140, 0.95) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: opacity 0.3s, transform 0.3s, background 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(100, 100, 180, 0.3);
            
            /* Performance optimizations */
            will-change: transform, box-shadow, background;
            contain: layout paint;
            backface-visibility: hidden;
            transform: translate3d(0, 0, 0);
        }
        
        .command-center-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .command-center-button:active {
            transform: scale(0.95);
        }
        
        .command-center.open .command-center-button {
            opacity: 1;
            transform: rotate(45deg);
            background: linear-gradient(135deg, rgba(180, 100, 100, 0.9) 0%, rgba(140, 80, 80, 0.95) 100%);
        }
        
        /* Feature icons popup */
        .command-center-popup {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.8);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
        }
        
        .command-center.open .command-center-popup {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .command-center-icon {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .command-center-icon:hover {
            transform: scale(1.15);
        }
        
        .command-center-icon:active {
            transform: scale(0.95);
        }
        
        .command-center-icon.report {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.9) 0%, rgba(200, 80, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(255, 100, 100, 0.4);
        }
        
        .command-center-icon.vacuum {
            background: linear-gradient(135deg, rgba(100, 180, 100, 0.9) 0%, rgba(80, 140, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(100, 180, 100, 0.4);
        }
        
        .command-center-icon.lights {
            background: linear-gradient(135deg, rgba(255, 200, 100, 0.9) 0%, rgba(200, 160, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(255, 200, 100, 0.4);
        }
        
        /* Staggered animation for icons */
        .command-center.open .command-center-icon:nth-child(1) {
            transition-delay: 0.05s;
        }
        .command-center.open .command-center-icon:nth-child(2) {
            transition-delay: 0.1s;
        }
        .command-center.open .command-center-icon:nth-child(3) {
            transition-delay: 0.15s;
        }
        .command-center.open .command-center-icon:nth-child(4) {
            transition-delay: 0.2s;
        }
        
        /* Image Control button in Command Center */
        .command-center-icon.image {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(109, 40, 217, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        /* ═══════════════════════════════════════════════════════════
           IMAGE CONTROL PANEL
           Submenu that appears when image button is clicked
           Contains: Change (🔄), Report (🚩), Like (👍), Dislike (👎)
           ═══════════════════════════════════════════════════════════ */
        
        .image-control-panel {
            position: fixed;
            bottom: 100px;
            bottom: max(100px, calc(86px + env(safe-area-inset-bottom, 14px)));
            right: 24px;
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95) 0%, rgba(20, 20, 35, 0.98) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 16px;
            z-index: 65;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            min-width: 240px;
        }
        
        .image-control-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .image-control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .image-control-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-control-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
        }
        
        .image-control-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .image-control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .image-control-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .image-control-btn:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }
        
        .image-control-btn:active {
            transform: scale(0.98);
        }
        
        .image-control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .image-control-btn-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .image-control-btn-text {
            flex: 1;
            text-align: left;
        }
        
        /* Loading spinner for buttons */
        .image-control-btn.loading .image-control-btn-icon {
            animation: spin 0.8s linear infinite;
        }
        
        .image-control-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }
        
        /* Change Image button - Green */
        .image-control-btn.change {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
        }
        
        /* Report Image button - Red */
        .image-control-btn.report {
            background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
            box-shadow: 0 4px 15px rgba(255, 82, 82, 0.3);
        }
        
        /* Rating buttons row */
        .image-control-rating-row {
            display: flex;
            gap: 10px;
        }
        
        .image-control-btn.like,
        .image-control-btn.dislike {
            flex: 1;
            justify-content: center;
            padding: 12px 16px;
        }
        
        /* Like button - Green */
        .image-control-btn.like {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .image-control-btn.like.active {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.5);
        }
        
        /* Dislike button - Red */
        .image-control-btn.dislike {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .image-control-btn.dislike.active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
        }
        
        /* Success/error flash animation */
        @keyframes flash-success {
            0%, 100% { box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 25px rgba(34, 197, 94, 0.8); }
        }
        
        @keyframes flash-error {
            0%, 100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
        }
        
        .image-control-btn.success {
            animation: flash-success 0.5s ease;
        }
        
        .image-control-btn.error {
            animation: flash-error 0.5s ease;
        }
        
        /* Image control panel backdrop */
        .image-control-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 62;
            display: none;
        }
        
        .image-control-backdrop.show {
            display: block;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 480px) and (orientation: portrait) {
            .image-control-panel {
                right: 16px;
                left: 16px;
                min-width: auto;
                bottom: 90px;
            }
        }
        
        /* Command Center backdrop for tap-outside-to-close */
        .command-center-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 55;
            display: none;
        }
        
        .command-center.open + .command-center-backdrop {
            display: block;
        }
        
        /* Legacy: Keep report-button class for backwards compatibility during transition */
        .report-button {
            display: none; /* Hidden - replaced by Command Center */
        }
        
        /* Vacuum Control Panel */
        .vacuum-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .vacuum-panel.show {
            opacity: 1;
            visibility: visible;
        }
        
        .vacuum-panel-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            text-align: center;
        }
        
        .vacuum-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .vacuum-panel-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .vacuum-panel-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .vacuum-panel-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .vacuum-battery {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        
        .vacuum-battery:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .vacuum-battery:active {
            transform: scale(0.98);
        }
        
        .vacuum-battery-icon {
            font-size: 32px;
        }
        
        .vacuum-battery-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .vacuum-battery-loading {
            font-size: 16px;
            opacity: 0.7;
        }
        
        .vacuum-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .vacuum-status-icon {
            font-size: 20px;
        }
        
        .vacuum-status-text {
            font-size: 16px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .vacuum-status.cleaning .vacuum-status-text {
            color: #4ade80;
        }
        
        .vacuum-status.charging .vacuum-status-text {
            color: #60a5fa;
        }
        
        .vacuum-status.idle .vacuum-status-text {
            color: #fbbf24;
        }
        
        .vacuum-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .vacuum-btn {
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 56px;
        }
        
        .vacuum-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .vacuum-btn.loading {
            position: relative;
            pointer-events: none;
        }
        
        .vacuum-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 16px;
            width: 18px;
            height: 18px;
            margin-top: -9px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: vacuum-spin 0.8s linear infinite;
        }
        
        @keyframes vacuum-spin {
            to { transform: rotate(360deg); }
        }
        
        .vacuum-btn.loading .vacuum-btn-icon {
            animation: vacuum-pulse 1s ease-in-out infinite;
        }
        
        @keyframes vacuum-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .vacuum-btn-start {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }
        
        .vacuum-btn-start:hover:not(:disabled) {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        
        .vacuum-btn-stop {
            background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
            color: white;
        }
        
        .vacuum-btn-stop:hover:not(:disabled) {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.4);
        }
        
        .vacuum-btn-home {
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
            color: white;
        }
        
        .vacuum-btn-home:hover:not(:disabled) {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .vacuum-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .vacuum-btn-icon {
            font-size: 20px;
        }
        
        @media (max-width: 480px) {
            .vacuum-panel-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
            }
            
            .vacuum-actions {
                gap: 12px;
            }
            
            .vacuum-btn {
                padding: 14px 20px;
                min-height: 50px;
            }
        }

        /* Lights Control Panel */
        .lights-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .lights-panel.show {
            opacity: 1;
            visibility: visible;
        }
        
        .lights-panel-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            text-align: center;
        }
        
        .lights-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }
        
        .lights-panel-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .lights-panel-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .lights-panel-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .lights-presets {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .lights-preset-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .lights-preset-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .lights-preset-btn:active {
            transform: translateY(0);
        }
        
        .lights-preset-btn.bedtime {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 4px 20px rgba(147, 51, 234, 0.2);
        }
        
        .lights-preset-btn.bedtime:hover {
            border-color: rgba(147, 51, 234, 0.7);
            box-shadow: 0 6px 25px rgba(147, 51, 234, 0.3);
        }
        
        .lights-preset-btn.daytime {
            border-color: rgba(245, 158, 11, 0.5);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
        }
        
        .lights-preset-btn.daytime:hover {
            border-color: rgba(245, 158, 11, 0.7);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.3);
        }
        
        .lights-preset-btn.movie {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }
        
        .lights-preset-btn.movie:hover {
            border-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.3);
        }
        
        .lights-preset-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .lights-preset-text {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        
        .lights-preset-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            display: block;
        }
        
        @media (max-width: 480px) {
            .lights-panel-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
            }
            
            .lights-preset-btn {
                padding: 16px;
                gap: 12px;
            }
            
            .lights-preset-icon {
                font-size: 28px;
            }
            
            .lights-preset-text {
                font-size: 16px;
            }
        }

        /* Report Modal */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            /* Prevent body scroll when modal is open */
            overflow: hidden;
        }
        
        .report-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .report-modal-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            position: relative;
        }
        
        .report-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .report-modal-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .report-modal-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .report-modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .report-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .report-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .report-form-label {
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .report-form-select,
        .report-form-textarea {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            color: white;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s, background 0.2s;
        }
        
        .report-form-select:focus,
        .report-form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.12);
        }
        
        .report-form-select {
            cursor: pointer;
        }
        
        .report-checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .report-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .report-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .report-checkbox-label:has(input:checked) {
            background: rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.5);
        }
        
        .report-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
            cursor: pointer;
        }
        
        .report-checkbox-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        @media (max-width: 480px) {
            .report-checkbox-group {
                grid-template-columns: 1fr;
            }
        }
        
        .report-form-textarea {
            resize: vertical;
            min-height: 100px;
            max-height: 200px;
        }
        
        .report-form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .report-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        .report-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .report-btn-cancel {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .report-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .report-btn-submit {
            background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
            color: white;
        }
        
        .report-btn-submit:hover {
            background: linear-gradient(135deg, #ff1744 0%, #d50000 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.4);
        }
        
        .report-btn-submit:active {
            transform: translateY(0);
        }
        
        .report-btn-submit:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .report-feedback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            padding: 24px;
            border-radius: 20px;
            text-align: center;
            display: none;
            box-sizing: border-box;
            z-index: 10;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .report-feedback.show {
            display: flex;
        }
        
        .report-feedback-icon {
            font-size: 56px;
            margin-bottom: 20px;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .report-feedback-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.3;
            flex-shrink: 0;
        }
        
        .report-feedback-message {
            font-size: 16px;
            opacity: 0.85;
            line-height: 1.5;
            flex-shrink: 0;
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .report-button {
                bottom: 18px;
                right: 18px;
                width: 52px;
                height: 52px;
                font-size: 22px;
            }
            
            .report-modal-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }
            
            .report-form-actions {
                flex-direction: column;
            }
            
            .report-btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Feedback overlay on mobile - ensure content fits */
            .report-feedback {
                padding: 20px;
                min-height: 200px;
            }
            
            .report-feedback-icon {
                font-size: 48px;
                margin-bottom: 16px;
            }
            
            .report-feedback-title {
                font-size: 20px;
                margin-bottom: 8px;
            }
            
            .report-feedback-message {
                font-size: 14px;
            }
        }
        
        /* ===========================================
           BROWSER-SPECIFIC STYLES
           =========================================== */
        
        /* Safari - iOS Safe Area Handling */
        .browser-safari.platform-ios .weather-widget {
            top: max(20px, env(safe-area-inset-top, 20px));
        }
        
        .browser-safari.platform-ios .command-center {
            bottom: max(140px, calc(env(safe-area-inset-bottom, 0px) + 130px)) !important;
        }
        
        /* Extra specificity for iPhone portrait */
        @media (max-width: 480px) and (orientation: portrait) {
            .browser-safari.platform-ios .command-center {
                bottom: max(140px, calc(env(safe-area-inset-bottom, 0px) + 130px)) !important;
            }
        }
        
        .browser-safari.platform-ios .clock-display {
            top: max(20px, env(safe-area-inset-top, 20px));
        }
        
        /* Safari - Viewport Height Fix */
        .browser-safari .display-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        /* Safari - Touch Handling */
        .browser-safari button,
        .browser-safari .touch-target,
        .browser-safari .command-btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Safari - Backdrop Filter */
        .browser-safari .weather-widget,
        .browser-safari .clock-display,
        .browser-safari .command-panel {
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Safari - Scroll Behavior on Modals */
        .browser-safari.platform-ios .report-modal,
        .browser-safari.platform-ios .command-panel {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* iOS Chrome - Safe Area (uses WebKit) */
        .browser-ios-chrome .weather-widget {
            top: max(20px, env(safe-area-inset-top, 20px));
        }
        
        .browser-ios-chrome .command-center {
            bottom: max(140px, calc(env(safe-area-inset-bottom, 0px) + 130px));
        }
        
        /* Chrome Desktop - Custom Scrollbars */
        .browser-chrome.platform-desktop ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .browser-chrome.platform-desktop ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        
        .browser-chrome.platform-desktop ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .browser-chrome.platform-desktop ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Chrome - Font Smoothing */
        .browser-chrome {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Chrome - Animation Performance */
        .browser-chrome .weather-widget,
        .browser-chrome .clock-display,
        .browser-chrome .command-panel {
            transform: translateZ(0);
        }
        
        /* Desktop-specific hover states (both browsers) */
        .platform-desktop .command-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        
        .platform-desktop .image-control-btn:hover {
            filter: brightness(1.15);
        }
    </style>
</head>
<body>
    <div class="display-container">
        <div class="image-layer active" id="layer-a">
            <img src="" alt="Alice">
        </div>
        <div class="image-layer inactive" id="layer-b">
            <img src="" alt="Alice">
        </div>
    </div>
    
    <div class="title-overlay" id="title-overlay"></div>
    
    <!-- Weather Widget Overlay -->
    <div class="weather-widget" id="weather-widget">
        <div class="weather-widget-header">
            <span class="weather-widget-icon" id="widget-weather-icon">☀️</span>
            <div>
                <div class="weather-widget-temp">
                    <span id="widget-temp">--</span><span class="unit">°C</span>
                </div>
            </div>
        </div>
        <div class="weather-widget-condition" id="widget-condition">Loading...</div>
        <div class="weather-widget-description" id="widget-description">--</div>
        <div class="weather-widget-divider"></div>
        <div class="weather-widget-details">
            <div class="weather-widget-detail">
                <div class="weather-widget-detail-value" id="widget-humidity">--%</div>
                <div class="weather-widget-detail-label">Humidity</div>
            </div>
            <div class="weather-widget-detail">
                <div class="weather-widget-detail-value" id="widget-activity">--</div>
                <div class="weather-widget-detail-label">Activity</div>
            </div>
        </div>
        <div class="weather-widget-time">
            <span class="weather-widget-clock" id="widget-clock">--:--</span>
            <span class="weather-widget-period" id="widget-period">--</span>
        </div>
    </div>
    
    <!-- Standalone clock for mobile portrait — fills the top-right dead space -->
    <div class="portrait-clock" id="portrait-clock">
        <span class="portrait-clock-time" id="portrait-clock-time">--:--</span>
        <span class="portrait-clock-period" id="portrait-clock-period">--</span>
    </div>
    
    <!-- Standalone clock for mobile landscape — small format bottom-right -->
    <div class="landscape-clock" id="landscape-clock" style="display: none;">
        <span class="landscape-clock-time" id="landscape-clock-time">--:--</span>
        <span class="landscape-clock-period" id="landscape-clock-period">--</span>
    </div>
    
    <div class="status-overlay" id="status-overlay">
        <div class="status-item">
            <span class="icon" id="weather-icon">☀️</span>
            <div>
                <div class="value" id="weather-condition">Loading...</div>
                <div class="label" id="temperature">--°C</div>
            </div>
        </div>
        <div class="status-item">
            <span class="icon">🕐</span>
            <div>
                <div class="value" id="time-period">--</div>
                <div class="label" id="current-time">--:--</div>
            </div>
        </div>
        <div class="status-item" id="activity-item">
            <span class="icon">🎨</span>
            <div>
                <div class="value" id="activity">--</div>
            </div>
        </div>
        <div class="copy-toast" id="copy-toast">📋 Copied!</div>
    </div>
    
    <div class="countdown" id="countdown"></div>
    
    <div class="update-indicator" id="update-indicator">✨ Updated!</div>
    
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner"></div>
    </div>
    
    <div class="error-message" id="error-message">
        <div class="error-icon">🦜</div>
        <div class="error-title" id="error-title">Connection Issue</div>
        <div class="error-detail" id="error-detail">Unable to load display data</div>
        <div class="error-retry-counter" id="error-retry-counter">Retry 0/10</div>
        <div class="error-retry">Retrying in <span class="countdown" id="error-countdown">10</span>s</div>
    </div>
    
    <div class="connection-status" id="connection-status">
        <div class="connection-dot"></div>
        <span id="connection-text">Connected</span>
    </div>
    
    <div class="fallback-badge" id="fallback-badge">⚠️ Showing cached image</div>
    
    <div class="debug-panel" id="debug-panel">
        <pre id="debug-content"></pre>
    </div>
    
    <button class="fullscreen-btn" id="fullscreen-btn" title="Toggle Fullscreen">⛶</button>
    
    <!-- PWA Install Banner -->
    <div class="install-banner" id="install-banner">
        <div class="install-banner-content">
            <div class="install-banner-icon">🦜</div>
            <div class="install-banner-text">
                <div class="install-banner-title">Install Alice Display</div>
                <div class="install-banner-subtitle">Add to home screen for fullscreen experience</div>
            </div>
        </div>
        <div class="install-banner-actions">
            <button class="dismiss-btn" id="install-dismiss">Maybe Later</button>
            <button class="install-btn" id="install-btn">Install</button>
        </div>
    </div>
    
    <!-- iOS Install Instructions -->
    <div class="ios-modal" id="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-icon">🦜</div>
            <div class="ios-modal-title">Install Alice Display</div>
            <div class="ios-modal-subtitle">Add to your home screen for the best experience</div>
            
            <div class="ios-modal-steps">
                <div class="ios-modal-step">
                    <span class="ios-step-number">1</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Tap <span class="ios-share-icon">⬆️ Share</span></div>
                        <div class="ios-step-desc">Find it at the bottom of Safari</div>
                    </div>
                </div>
                <div class="ios-modal-step">
                    <span class="ios-step-number">2</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Add to Home Screen</div>
                        <div class="ios-step-desc">Scroll down in the share menu</div>
                    </div>
                </div>
                <div class="ios-modal-step">
                    <span class="ios-step-number">3</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Tap "Add"</div>
                        <div class="ios-step-desc">Confirm in the top right corner</div>
                    </div>
                </div>
            </div>
            
            <div class="ios-modal-buttons">
                <button class="ios-modal-close" id="ios-modal-close">Got it!</button>
                <button class="ios-modal-dismiss" id="ios-modal-dismiss">Don't show again</button>
            </div>
            
            <div class="ios-safari-note">
                <strong>Note:</strong> Must be opened in Safari. Other browsers don't support home screen apps.
            </div>
        </div>
    </div>
    
    <!-- Help Overlay -->
    <div class="help-overlay" id="help-overlay">
        <div class="help-content">
            <div class="help-title">⌨️ Keyboard Shortcuts</div>
            <div class="help-shortcuts">
                <span class="help-key">R</span>
                <span class="help-desc">Refresh display</span>
                
                <span class="help-key">F</span>
                <span class="help-desc">Toggle fullscreen</span>
                
                <span class="help-key">S</span>
                <span class="help-desc">Toggle status overlay</span>
                
                <span class="help-key">Space</span>
                <span class="help-desc">Pause/resume auto-refresh</span>
                
                <span class="help-key">I</span>
                <span class="help-desc">Show image info</span>
                
                <span class="help-key">W</span>
                <span class="help-desc">Toggle status overlay</span>
                
                <span class="help-key">Ctrl+D</span>
                <span class="help-desc">Toggle debug panel</span>
                
                <span class="help-key">H / ?</span>
                <span class="help-desc">Show this help</span>
                
                <span class="help-key">Shift+R</span>
                <span class="help-desc">Report issue with image</span>
                
                <span class="help-key">Esc</span>
                <span class="help-desc">Close panels</span>
            </div>
            <div class="help-close">Press any key to close</div>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Pause indicator -->
    <div class="pause-indicator" id="pause-indicator">
        ⏸️ Auto-refresh paused — Press Space to resume
    </div>
    
    <!-- Image info panel -->
    <div class="image-info" id="image-info">
        <h3>🖼️ Image Info</h3>
        <div class="image-info-row">
            <span class="image-info-label">Title</span>
            <span class="image-info-value" id="info-title">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Weather</span>
            <span class="image-info-value" id="info-weather">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Time</span>
            <span class="image-info-value" id="info-time">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Activity</span>
            <span class="image-info-value" id="info-activity">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Updated</span>
            <span class="image-info-value" id="info-updated">--</span>
        </div>
    </div>
    
    <!-- Report Issue Button -->
    <!-- Command Center -->
    <div class="command-center" id="command-center">
        <div class="command-center-popup">
            <button class="command-center-icon lights" id="cmd-lights" title="Lights">💡</button>
            <button class="command-center-icon vacuum" id="cmd-vacuum" title="Vacuum">🤖</button>
            <button class="command-center-icon report" id="cmd-report" title="Report Issue">🚩</button>
            <button class="command-center-icon image" id="cmd-image" title="Image Controls">🖼️</button>
        </div>
        <button class="command-center-button" id="command-center-button" title="Command Center">⚙️</button>
    </div>
    <div class="command-center-backdrop" id="command-center-backdrop"></div>
    
    <!-- Image Control Panel -->
    <div class="image-control-panel" id="image-control-panel">
        <div class="image-control-header">
            <span class="image-control-title">🖼️ Image Controls</span>
            <button class="image-control-close" id="image-control-close" title="Close">✕</button>
        </div>
        <div class="image-control-buttons">
            <button class="image-control-btn change" id="img-change">
                <span class="image-control-btn-icon">🔄</span>
                <span class="image-control-btn-text">Change Image</span>
            </button>
            <button class="image-control-btn report" id="img-report">
                <span class="image-control-btn-icon">🚩</span>
                <span class="image-control-btn-text">Report Issue</span>
            </button>
            <div class="image-control-rating-row">
                <button class="image-control-btn like" id="img-like">
                    <span class="image-control-btn-icon">👍</span>
                    <span class="image-control-btn-text">Like</span>
                </button>
                <button class="image-control-btn dislike" id="img-dislike">
                    <span class="image-control-btn-icon">👎</span>
                    <span class="image-control-btn-text">Dislike</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Desktop Info Panel (Right Sidebar) -->
    <div class="desktop-info-panel" id="desktop-info-panel" style="display: none;">
        <div class="desktop-info-title">
            📊 Image Information
        </div>
        
        <div class="desktop-info-section">
            <div class="desktop-info-section-title">Current Image</div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Title:</span>
                <span class="desktop-info-value" id="desktop-info-title">--</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Updated:</span>
                <span class="desktop-info-value" id="desktop-info-updated">--</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Source:</span>
                <span class="desktop-info-value" id="desktop-info-source">Gallery</span>
            </div>
        </div>
        
        <div class="desktop-info-section">
            <div class="desktop-info-section-title">Context</div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Time:</span>
                <span class="desktop-info-value" id="desktop-info-time">--</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Activity:</span>
                <span class="desktop-info-value" id="desktop-info-activity">--</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Weather:</span>
                <span class="desktop-info-value" id="desktop-info-weather">--</span>
            </div>
        </div>
        
        <div class="desktop-info-section">
            <div class="desktop-info-section-title">System</div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Layout:</span>
                <span class="desktop-info-value" id="desktop-info-layout">Desktop</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Screen:</span>
                <span class="desktop-info-value" id="desktop-info-screen">--</span>
            </div>
            <div class="desktop-info-item">
                <span class="desktop-info-label">Connection:</span>
                <span class="desktop-info-value" id="desktop-info-connection">Online</span>
            </div>
        </div>
    </div>
    <div class="image-control-backdrop" id="image-control-backdrop"></div>
    
    <!-- Vacuum Control Panel -->
    <div class="vacuum-panel" id="vacuum-panel">
        <div class="vacuum-panel-content">
            <div class="vacuum-panel-header">
                <h2 class="vacuum-panel-title">🤖 Yiko Vacuum</h2>
                <button class="vacuum-panel-close" id="vacuum-panel-close" title="Close">✕</button>
            </div>
            
            <div class="vacuum-battery" id="vacuum-battery">
                <span class="vacuum-battery-icon" id="vacuum-battery-icon">🔋</span>
                <span class="vacuum-battery-text" id="vacuum-battery-text">Loading...</span>
            </div>
            
            <div class="vacuum-status" id="vacuum-status">
                <span class="vacuum-status-icon" id="vacuum-status-icon">📍</span>
                <span class="vacuum-status-text" id="vacuum-status-text">--</span>
            </div>
            
            <div class="vacuum-actions">
                <button class="vacuum-btn vacuum-btn-start" id="vacuum-btn-start">
                    <span class="vacuum-btn-icon">▶️</span>
                    <span>Start Cleaning</span>
                </button>
                <button class="vacuum-btn vacuum-btn-stop" id="vacuum-btn-stop">
                    <span class="vacuum-btn-icon">⏹️</span>
                    <span>Stop</span>
                </button>
                <button class="vacuum-btn vacuum-btn-home" id="vacuum-btn-home">
                    <span class="vacuum-btn-icon">🏠</span>
                    <span>Go Home</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Lights Control Panel -->
    <div class="lights-panel" id="lights-panel">
        <div class="lights-panel-content">
            <div class="lights-panel-header">
                <h2 class="lights-panel-title">💡 Lights Control</h2>
                <button class="lights-panel-close" id="lights-panel-close" title="Close">✕</button>
            </div>
            
            <div class="lights-presets">
                <button class="lights-preset-btn bedtime" id="lights-bedtime">
                    <span class="lights-preset-icon">🌙</span>
                    <span class="lights-preset-text">Bedtime</span>
                    <span class="lights-preset-desc">All lights to 1%</span>
                </button>
                <button class="lights-preset-btn daytime" id="lights-daytime">
                    <span class="lights-preset-icon">☀️</span>
                    <span class="lights-preset-text">Daytime</span>
                    <span class="lights-preset-desc">All lights to 100%</span>
                </button>
                <button class="lights-preset-btn movie" id="lights-movie">
                    <span class="lights-preset-icon">🎬</span>
                    <span class="lights-preset-text">Movie Mode</span>
                    <span class="lights-preset-desc">30% + Blue</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report Issue Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h2 class="report-modal-title">🚩 Report Issue</h2>
                <button class="report-modal-close" id="report-modal-close" title="Close">✕</button>
            </div>
            
            <form class="report-form" id="report-form">
                <div class="report-form-group">
                    <label class="report-form-label">Issue Type * <span style="font-weight: normal; font-size: 0.85em; opacity: 0.7;">(select all that apply)</span></label>
                    <div class="report-checkbox-group" id="report-category">
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="wrong-content">
                            <span class="report-checkbox-text">Wrong Content</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="poor-quality">
                            <span class="report-checkbox-text">Poor Quality</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="duplicate">
                            <span class="report-checkbox-text">Duplicate</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="inappropriate">
                            <span class="report-checkbox-text">Inappropriate</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="weather-mismatch">
                            <span class="report-checkbox-text">Weather Mismatch</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="time-mismatch">
                            <span class="report-checkbox-text">Time Mismatch</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="technical-issue">
                            <span class="report-checkbox-text">Technical Issue</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="other">
                            <span class="report-checkbox-text">Other</span>
                        </label>
                    </div>
                </div>
                
                <div class="report-form-group">
                    <label class="report-form-label" for="report-description">Description (optional)</label>
                    <textarea class="report-form-textarea" id="report-description" placeholder="Please describe the issue in more detail..."></textarea>
                </div>
                
                <input type="hidden" id="report-image-id" value="">
                
                <div class="report-form-actions">
                    <button type="submit" class="report-btn report-btn-submit" id="report-submit">Submit Report</button>
                </div>
            </form>
            
            <div class="report-feedback" id="report-feedback">
                <div class="report-feedback-icon" id="report-feedback-icon">✅</div>
                <div class="report-feedback-title" id="report-feedback-title">Report Submitted</div>
                <div class="report-feedback-message" id="report-feedback-message">Thank you for your feedback!</div>
            </div>
        </div>
    </div>
    
    <script>
        class AliceDisplay {
            constructor() {
                this.controlFile = 'display-control.json';
                this.pollInterval = 5 * 60 * 1000;  // Poll every 5 minutes
                this.baseRetryInterval = 10 * 1000;  // Base retry interval
                this.maxRetryInterval = 5 * 60 * 1000;  // Max 5 minutes between retries
                this.retryCount = 0;
                this.maxRetries = 10;
                this.lastUpdated = null;
                this.currentData = null;
                this.lastGoodData = null;  // Cache last successful data
                this.activeLayer = 'a';
                this.isDebugMode = new URLSearchParams(window.location.search).has('debug');
                this.isOnline = navigator.onLine;
                this.errorCountdownInterval = null;
                this.usingFallback = false;
                this.isPaused = false;  // For pause/resume functionality
                
                // Fallback image (base64 placeholder or default)
                this.fallbackImageUrl = 'images/generated/morning-sunny.png';
                
                // DOM elements
                this.layerA = document.getElementById('layer-a');
                this.layerB = document.getElementById('layer-b');
                this.titleEl = document.getElementById('title-overlay');
                this.statusEl = document.getElementById('status-overlay');
                this.spinnerEl = document.getElementById('loading-spinner');
                this.errorEl = document.getElementById('error-message');
                this.errorTitleEl = document.getElementById('error-title');
                this.errorDetailEl = document.getElementById('error-detail');
                this.errorCountdownEl = document.getElementById('error-countdown');
                this.debugEl = document.getElementById('debug-panel');
                this.debugContent = document.getElementById('debug-content');
                this.updateIndicator = document.getElementById('update-indicator');
                this.countdownEl = document.getElementById('countdown');
                this.connectionStatusEl = document.getElementById('connection-status');
                this.connectionTextEl = document.getElementById('connection-text');
                this.fallbackBadgeEl = document.getElementById('fallback-badge');
                
                // Weather icons mapping
                this.weatherIcons = {
                    'Sunny': '☀️',
                    'Partly Cloudy': '⛅',
                    'Cloudy': '☁️',
                    'Overcast': '🌥️',
                    'Rainy': '🌧️',
                    'Stormy': '⛈️',
                    'Snowy': '❄️',
                    'Foggy': '🌫️',
                    'Clear Night': '🌙',
                    'Windy': '💨'
                };
                
                this.init();
            }
            
            async init() {
                if (this.isDebugMode) {
                    this.debugEl.classList.add('show');
                }
                
                this.setupEventListeners();
                this.setupNetworkListeners();
                this.initializeStatusOverlay();
                this.initializeReportModal();
                this.preventMobileScroll();  // Prevent iOS Safari scroll
                this.spinnerEl.classList.add('active');
                await this.loadDisplay(true);  // Initial load
                this.startPolling();
                
                // Show status bar briefly on load
                this.statusEl.classList.add('visible');
                setTimeout(() => {
                    this.statusEl.classList.remove('visible');
                }, 5000);
            }
            
            preventMobileScroll() {
                // Prevent scroll on iOS Safari except in modal content
                document.addEventListener('touchmove', (e) => {
                    const modal = document.getElementById('report-modal');
                    const modalContent = document.querySelector('.report-modal-content');
                    
                    // Allow scroll only inside the report modal content
                    if (modal.classList.contains('show') && modalContent && modalContent.contains(e.target)) {
                        return; // Allow scrolling in modal
                    }
                    
                    // Prevent scroll everywhere else
                    e.preventDefault();
                }, { passive: false });
            }
            
            initializeStatusOverlay() {
                // Start collapsed on mobile portrait to avoid overlap
                const isMobilePortrait = window.innerWidth <= 480 && window.innerHeight > window.innerWidth;
                if (isMobilePortrait) {
                    const statusOverlay = document.getElementById('status-overlay');
                    const displayContainer = document.querySelector('.display-container');
                    
                    statusOverlay.classList.add('collapsed');
                    displayContainer.classList.add('status-collapsed');
                }
            }
            
            handleOrientationChange() {
                const statusOverlay = document.getElementById('status-overlay');
                const displayContainer = document.querySelector('.display-container');
                const landscapeClock = document.getElementById('landscape-clock');
                const portraitClock = document.getElementById('portrait-clock');
                const desktopInfoPanel = document.getElementById('desktop-info-panel');
                
                const isMobilePortrait = window.innerWidth <= 480 && window.innerHeight > window.innerWidth;
                const isMobileLandscape = window.innerHeight <= 480 && window.innerWidth > window.innerHeight;
                const isDesktop = window.innerWidth >= 1200;
                
                if (isMobilePortrait) {
                    // Mobile portrait mode
                    if (!statusOverlay.classList.contains('collapsed')) {
                        statusOverlay.classList.add('collapsed');
                        displayContainer.classList.add('status-collapsed');
                    }
                    // Hide landscape clock, show portrait clock
                    if (landscapeClock) landscapeClock.style.display = 'none';
                    if (portraitClock) portraitClock.style.display = 'flex';
                    // Hide desktop info panel
                    if (desktopInfoPanel) desktopInfoPanel.style.display = 'none';
                    
                } else if (isMobileLandscape) {
                    // Mobile landscape mode
                    statusOverlay.classList.remove('collapsed');
                    displayContainer.classList.remove('status-collapsed');
                    // Show landscape clock, hide portrait clock
                    if (landscapeClock) landscapeClock.style.display = 'flex';
                    if (portraitClock) portraitClock.style.display = 'none';
                    // Hide desktop info panel
                    if (desktopInfoPanel) desktopInfoPanel.style.display = 'none';
                    
                } else if (isDesktop) {
                    // Desktop mode
                    statusOverlay.classList.remove('collapsed');
                    displayContainer.classList.remove('status-collapsed');
                    // Hide both standalone clocks (weather widget has integrated clock)
                    if (landscapeClock) landscapeClock.style.display = 'none';
                    if (portraitClock) portraitClock.style.display = 'none';
                    // Show desktop info panel
                    if (desktopInfoPanel) desktopInfoPanel.style.display = 'block';
                    // Update desktop info
                    this.updateDesktopInfo();
                    
                } else {
                    // Tablet mode
                    statusOverlay.classList.remove('collapsed');
                    displayContainer.classList.remove('status-collapsed');
                    // Hide both standalone clocks (weather widget has integrated clock)
                    if (landscapeClock) landscapeClock.style.display = 'none';
                    if (portraitClock) portraitClock.style.display = 'none';
                    // Hide desktop info panel
                    if (desktopInfoPanel) desktopInfoPanel.style.display = 'none';
                }
            }
            
            updateDesktopInfo() {
                // Update desktop info panel with current data
                if (this.currentData) {
                    const titleEl = document.getElementById('desktop-info-title');
                    const updatedEl = document.getElementById('desktop-info-updated');
                    const timeEl = document.getElementById('desktop-info-time');
                    const activityEl = document.getElementById('desktop-info-activity');
                    const weatherEl = document.getElementById('desktop-info-weather');
                    const screenEl = document.getElementById('desktop-info-screen');
                    
                    if (titleEl) titleEl.textContent = this.currentData.title || '--';
                    if (updatedEl) updatedEl.textContent = this.currentData.updated || '--';
                    if (timeEl) timeEl.textContent = this.currentData.time || '--';
                    if (activityEl) activityEl.textContent = this.currentData.activity || '--';
                    if (weatherEl) weatherEl.textContent = this.currentData.weather || '--';
                    if (screenEl) screenEl.textContent = `${window.innerWidth}×${window.innerHeight}`;
                }
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showConnectionStatus('Back online', false);
                    this.retryCount = 0;  // Reset retry count
                    this.loadDisplay(true);  // Immediately try to load
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showConnectionStatus('Offline', true);
                    this.showFallbackImage();
                });
            }
            
            showConnectionStatus(text, isError) {
                this.connectionTextEl.textContent = text;
                this.connectionStatusEl.classList.toggle('error', isError);
                this.connectionStatusEl.classList.add('visible');
                
                // Auto-hide success messages
                if (!isError) {
                    setTimeout(() => {
                        this.connectionStatusEl.classList.remove('visible');
                    }, 3000);
                }
            }
            
            showFallbackImage() {
                if (this.lastGoodData) {
                    // Show last known good image
                    this.updateDisplay(this.lastGoodData, true);
                    this.usingFallback = true;
                    this.fallbackBadgeEl.classList.add('show');
                    document.body.classList.add('fallback-active');
                } else if (this.fallbackImageUrl) {
                    // Show default fallback
                    this.crossfadeImage(this.fallbackImageUrl, 'Alice (Fallback)', true);
                    this.usingFallback = true;
                    this.fallbackBadgeEl.classList.add('show');
                    document.body.classList.add('fallback-active');
                }
            }
            
            clearFallbackState() {
                this.usingFallback = false;
                this.fallbackBadgeEl.classList.remove('show');
                document.body.classList.remove('fallback-active');
                this.connectionStatusEl.classList.remove('visible');
            }
            
            setupEventListeners() {
                // Fullscreen button
                document.getElementById('fullscreen-btn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                // Status overlay click to toggle
                document.getElementById('status-overlay').addEventListener('click', () => {
                    this.toggleStatusOverlay();
                });
                
                // Weather widget click to toggle visibility
                document.getElementById('weather-widget').addEventListener('click', () => {
                    this.toggleWeatherWidget();
                });
                
                // Show status on mouse move / touch
                let hideTimeout;
                const showOverlays = () => {
                    this.statusEl.classList.add('visible');
                    this.titleEl.classList.add('visible');
                    this.countdownEl.classList.add('visible');
                    clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        this.statusEl.classList.remove('visible');
                        this.titleEl.classList.remove('visible');
                        this.countdownEl.classList.remove('visible');
                    }, 4000);
                };
                document.addEventListener('mousemove', showOverlays);
                document.addEventListener('touchstart', showOverlays);
                
                // Tap-to-copy: tapping the activity area copies the current image's
                // Cloudinary URL to the clipboard. Shows a brief green toast confirmation.
                document.getElementById('activity-item').addEventListener('click', (e) => {
                    e.stopPropagation();  // Don't trigger the show/hide overlays
                    
                    // Get the current image URL from the last loaded data
                    const url = this.currentData?.currentImage?.url;
                    if (!url) {
                        this.showCopyToast('⚠️ No image URL');
                        return;
                    }
                    
                    // Copy to clipboard using the modern API with fallback
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(() => {
                            this.showCopyToast('📋 Link copied!');
                        }).catch(() => {
                            this.fallbackCopy(url);
                        });
                    } else {
                        this.fallbackCopy(url);
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ignore if typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'd':
                            if (e.ctrlKey) {
                                e.preventDefault();
                                this.debugEl.classList.toggle('show');
                            }
                            break;
                        case 'r':
                            if (e.shiftKey) {
                                // Shift+R for report modal
                                e.preventDefault();
                                this.showReportModal();
                            } else if (!e.ctrlKey) {
                                // R for refresh
                                e.preventDefault();
                                this.loadDisplay(true);
                                this.showToast('🔄 Refreshing...');
                            }
                            break;
                        case 'f':
                            e.preventDefault();
                            this.toggleFullscreen();
                            break;
                        case 's':
                            e.preventDefault();
                            this.statusEl.classList.toggle('visible');
                            this.titleEl.classList.toggle('visible');
                            break;
                        case 'w':
                            e.preventDefault();
                            this.toggleStatusOverlay();
                            break;
                        case ' ':
                            e.preventDefault();
                            this.togglePause();
                            break;
                        case 'h':
                        case '?':
                            e.preventDefault();
                            this.toggleHelp();
                            break;
                        case 'i':
                            e.preventDefault();
                            this.showImageInfo();
                            break;
                        case 'escape':
                            this.closeAllPanels();
                            break;
                        case 'c':
                            // Copy current image URL to clipboard
                            if (!e.ctrlKey && !e.metaKey) {
                                e.preventDefault();
                                const copyUrl = this.currentData?.currentImage?.url;
                                if (copyUrl) {
                                    navigator.clipboard?.writeText(copyUrl).then(() => {
                                        this.showCopyToast('📋 Link copied!');
                                    }).catch(() => this.fallbackCopy(copyUrl));
                                }
                            }
                            break;
                        case 'arrowleft':
                            e.preventDefault();
                            this.showToast('⏮️ Previous (not implemented)');
                            break;
                        case 'arrowright':
                            e.preventDefault();
                            this.showToast('⏭️ Next (not implemented)');
                            break;
                    }
                });
                
                // Check for updates when page becomes visible again
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.loadDisplay();
                    }
                });
                
                // Handle orientation changes for weather widget positioning
                window.addEventListener('orientationchange', () => {
                    // Delay to allow orientation change to complete
                    setTimeout(() => {
                        this.handleOrientationChange();
                    }, 100);
                });
                
                // Also handle window resize for responsive behavior
                window.addEventListener('resize', () => {
                    this.handleOrientationChange();
                });
            }
            
            async loadDisplay(forceUpdate = false) {
                // Check if offline
                if (!navigator.onLine) {
                    this.handleError('offline', 'You appear to be offline');
                    return;
                }
                
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 15000);  // 15s timeout
                    
                    const response = await fetch(`${this.controlFile}?t=${Date.now()}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeout);
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Validate data structure
                    if (!data || !data.currentImage) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Success! Reset error state
                    this.retryCount = 0;
                    this.clearError();
                    this.clearFallbackState();
                    
                    // Check if data has changed
                    const newLastUpdated = data.lastUpdated;
                    const hasChanged = forceUpdate || (newLastUpdated !== this.lastUpdated);
                    
                    if (hasChanged && newLastUpdated) {
                        console.log('🦜 Update detected:', newLastUpdated);
                        this.lastUpdated = newLastUpdated;
                        this.currentData = data;
                        this.lastGoodData = data;  // Cache for fallback
                        await this.updateDisplay(data, !forceUpdate);
                        this.updateDebug(data);
                        this.updateWeatherWidget();
                        this.startWidgetClock();
                        
                        // Show update indicator (not on initial load)
                        if (!forceUpdate && this.lastUpdated) {
                            this.showUpdateIndicator();
                        }
                    } else {
                        this.updateDebug({ ...data, _status: 'No changes detected' });
                    }
                    
                } catch (error) {
                    console.error('Error loading display:', error);
                    
                    // Categorize the error
                    let errorType = 'unknown';
                    let errorMessage = error.message;
                    
                    if (error.name === 'AbortError') {
                        errorType = 'timeout';
                        errorMessage = 'Request timed out';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorType = 'network';
                        errorMessage = 'Network connection failed';
                    } else if (error.message.includes('Server returned')) {
                        errorType = 'server';
                    } else if (error.message.includes('Invalid data')) {
                        errorType = 'data';
                        errorMessage = 'Received invalid data';
                    }
                    
                    this.handleError(errorType, errorMessage);
                }
            }
            
            handleError(type, message) {
                // Cap the retry counter at maxRetries to prevent runaway display
                if (this.retryCount <= this.maxRetries) {
                    this.retryCount++;
                }
                this.updateDebug({ error: message, type, retryCount: Math.min(this.retryCount, this.maxRetries) });
                
                // Calculate retry interval with exponential backoff
                const retryInterval = Math.min(
                    this.baseRetryInterval * Math.pow(1.5, this.retryCount - 1),
                    this.maxRetryInterval
                );
                
                // Set error message based on type
                const errorMessages = {
                    offline: { title: 'You\'re Offline', icon: '📡' },
                    timeout: { title: 'Connection Slow', icon: '⏱️' },
                    network: { title: 'Connection Failed', icon: '🔌' },
                    server: { title: 'Server Issue', icon: '🖥️' },
                    data: { title: 'Data Error', icon: '⚠️' },
                    image: { title: 'Image Load Failed', icon: '🖼️' },
                    unknown: { title: 'Something Went Wrong', icon: '🦜' }
                };
                
                const errorInfo = errorMessages[type] || errorMessages.unknown;
                
                // Show fallback if we have one and this isn't the first load
                if (this.lastGoodData || this.currentData) {
                    this.showFallbackImage();
                }
                
                // Show error UI
                this.showError(errorInfo.title, message, retryInterval);
                
                // Schedule retry (unless we've exceeded max retries)
                if (this.retryCount <= this.maxRetries) {
                    setTimeout(() => this.loadDisplay(), retryInterval);
                } else {
                    this.errorDetailEl.textContent = 'Max retries exceeded. Tap to retry.';
                    this.errorEl.onclick = () => {
                        this.retryCount = 0;
                        this.loadDisplay(true);
                    };
                }
            }
            
            showError(title = 'Connection Issue', detail = 'Unable to load display', retryIn = 10000) {
                this.spinnerEl.classList.remove('active');
                this.errorTitleEl.textContent = title;
                this.errorDetailEl.textContent = detail;
                this.errorEl.classList.add('show');
                
                // Update retry counter inside modal (capped at maxRetries)
                const retryCounterEl = document.getElementById('error-retry-counter');
                if (retryCounterEl) {
                    const displayCount = Math.min(this.retryCount, this.maxRetries);
                    retryCounterEl.textContent = `Retry ${displayCount}/${this.maxRetries}`;
                }
                
                // Hide connection status when error modal is shown
                this.connectionStatusEl.classList.remove('show');
                
                // Update countdown
                if (this.errorCountdownInterval) {
                    clearInterval(this.errorCountdownInterval);
                }
                
                let remaining = Math.ceil(retryIn / 1000);
                this.errorCountdownEl.textContent = remaining;
                
                this.errorCountdownInterval = setInterval(() => {
                    remaining--;
                    if (remaining > 0) {
                        this.errorCountdownEl.textContent = remaining;
                    } else {
                        clearInterval(this.errorCountdownInterval);
                    }
                }, 1000);
            }
            
            clearError() {
                this.errorEl.classList.remove('show');
                this.errorEl.onclick = null;
                if (this.errorCountdownInterval) {
                    clearInterval(this.errorCountdownInterval);
                }
            }
            
            async updateDisplay(data, animate = true) {
                const { currentImage, weather, time } = data;
                
                // Update image with crossfade
                if (currentImage && currentImage.url) {
                    await this.crossfadeImage(currentImage.url, currentImage.title, animate);
                }
                
                // Update title
                if (currentImage && currentImage.title) {
                    this.titleEl.textContent = currentImage.title;
                }
                
                // Update weather
                if (weather) {
                    document.getElementById('weather-icon').textContent = 
                        this.weatherIcons[weather.condition] || '🌡️';
                    document.getElementById('weather-condition').textContent = 
                        weather.condition || 'Unknown';
                    document.getElementById('temperature').textContent = 
                        weather.temperature ? `${Math.round(weather.temperature)}°C` : '';
                }
                
                // Update time
                if (time) {
                    document.getElementById('time-period').textContent = 
                        time.period || 'Unknown';
                    const now = new Date();
                    document.getElementById('current-time').textContent = 
                        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                // Update activity
                if (currentImage && currentImage.activity) {
                    document.getElementById('activity').textContent = currentImage.activity;
                }
                
                this.spinnerEl.classList.remove('active');
            }
            
            crossfadeImage(url, title, animate = true) {
                return new Promise((resolve) => {
                    // Determine which layer to load into
                    const nextLayer = this.activeLayer === 'a' ? 'b' : 'a';
                    const nextLayerEl = nextLayer === 'a' ? this.layerA : this.layerB;
                    const currentLayerEl = this.activeLayer === 'a' ? this.layerA : this.layerB;
                    const nextImg = nextLayerEl.querySelector('img');
                    
                    // Preload the image with timeout
                    const preloader = new Image();
                    const loadTimeout = setTimeout(() => {
                        console.warn('Image load timeout:', url);
                        this.handleImageError(url, 'timeout');
                        resolve();
                    }, 30000);  // 30s timeout for image load
                    
                    preloader.onload = () => {
                        clearTimeout(loadTimeout);
                        nextImg.src = url;
                        nextImg.alt = title || 'Alice';
                        
                        // Apply random Ken Burns effect
                        const kbVariants = ['kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4'];
                        const randomKB = kbVariants[Math.floor(Math.random() * kbVariants.length)];
                        
                        // Remove old Ken Burns classes and add new one
                        nextImg.classList.remove('kenburns', 'kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4');
                        nextImg.classList.add('kenburns', randomKB);
                        
                        // Also remove from the old layer's image to reset it
                        const currentImg = currentLayerEl.querySelector('img');
                        currentImg.classList.remove('kenburns', 'kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4');
                        
                        // Crossfade: show new layer, hide old
                        nextLayerEl.classList.remove('inactive');
                        nextLayerEl.classList.add('active');
                        currentLayerEl.classList.remove('active');
                        currentLayerEl.classList.add('inactive');
                        
                        this.activeLayer = nextLayer;
                        this.spinnerEl.classList.remove('active');
                        resolve();
                    };
                    
                    preloader.onerror = () => {
                        clearTimeout(loadTimeout);
                        console.error('Failed to load image:', url);
                        this.handleImageError(url, 'load');
                        resolve();
                    };
                    
                    preloader.src = url;
                });
            }
            
            handleImageError(url, reason) {
                console.warn(`Image error (${reason}):`, url);
                
                // Try fallback image if main image fails
                if (!this.usingFallback && url !== this.fallbackImageUrl) {
                    console.log('Attempting fallback image...');
                    this.usingFallback = true;
                    this.fallbackBadgeEl.textContent = '⚠️ Image unavailable';
                    this.fallbackBadgeEl.classList.add('show');
                    
                    // Try fallback
                    if (this.lastGoodData && this.lastGoodData.currentImage) {
                        this.crossfadeImage(
                            this.lastGoodData.currentImage.url,
                            this.lastGoodData.currentImage.title + ' (cached)',
                            true
                        );
                    } else {
                        this.crossfadeImage(this.fallbackImageUrl, 'Alice (Fallback)', true);
                    }
                } else {
                    // Even fallback failed - show error state
                    this.handleError('image', 'Unable to load images');
                }
            }
            
            showUpdateIndicator() {
                this.updateIndicator.classList.add('show');
                setTimeout(() => {
                    this.updateIndicator.classList.remove('show');
                }, 3000);
            }
            
            updateDebug(data) {
                if (!this.isDebugMode) return;
                const debugInfo = {
                    ...data,
                    _pollInterval: `${this.pollInterval / 1000}s`,
                    _lastChecked: new Date().toISOString()
                };
                this.debugContent.textContent = JSON.stringify(debugInfo, null, 2);
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Fullscreen error:', err);
                    });
                    this.showToast('🖥️ Fullscreen');
                } else {
                    document.exitFullscreen();
                    this.showToast('🪟 Windowed');
                }
            }
            
            /**
             * Show the green "Link copied!" toast above the status bar.
             * Auto-hides after 1.5 seconds.
             */
            showCopyToast(message) {
                const toast = document.getElementById('copy-toast');
                toast.textContent = message;
                toast.classList.add('show');
                clearTimeout(this._copyToastTimer);
                this._copyToastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                }, 1500);
            }
            
            /**
             * Fallback for copying text on older browsers / non-HTTPS contexts.
             * Creates a temporary textarea, selects the text, and uses execCommand.
             */
            fallbackCopy(text) {
                // Use a hidden textarea to copy text to clipboard.
                // We set readOnly and move the textarea offscreen to prevent
                // the iOS keyboard from appearing when we call select().
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');  // Prevent keyboard on iOS
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';  // Move offscreen
                textarea.style.top = '-9999px';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showCopyToast('📋 Link copied!');
                } catch (err) {
                    this.showCopyToast('⚠️ Copy failed');
                }
                document.body.removeChild(textarea);
            }
            
            togglePause() {
                this.isPaused = !this.isPaused;
                const pauseIndicator = document.getElementById('pause-indicator');
                if (this.isPaused) {
                    pauseIndicator.classList.add('show');
                    this.showToast('⏸️ Paused');
                } else {
                    pauseIndicator.classList.remove('show');
                    this.showToast('▶️ Resumed');
                    this.loadDisplay();  // Refresh immediately when unpausing
                }
            }
            
            toggleHelp() {
                const helpOverlay = document.getElementById('help-overlay');
                helpOverlay.classList.toggle('show');
            }
            
            toggleStatusOverlay() {
                const statusOverlay = document.getElementById('status-overlay');
                const displayContainer = document.querySelector('.display-container');
                
                // Toggle between expanded and collapsed states
                statusOverlay.classList.toggle('collapsed');
                
                // Update display container class for image spacing
                displayContainer.classList.toggle('status-collapsed', statusOverlay.classList.contains('collapsed'));
                
                if (statusOverlay.classList.contains('collapsed')) {
                    this.showToast('📍 Status minimized');
                } else {
                    this.showToast('📍 Status expanded');
                }
            }
            
            toggleWeatherWidget() {
                const weatherWidget = document.getElementById('weather-widget');
                const displayContainer = document.querySelector('.display-container');
                
                // Toggle visibility
                weatherWidget.classList.toggle('hidden');
                
                // Update display container class for image spacing
                displayContainer.classList.toggle('widget-hidden', weatherWidget.classList.contains('hidden'));
                
                if (weatherWidget.classList.contains('hidden')) {
                    this.showToast('🌤️ Tap icon to expand');
                } else {
                    this.showToast('🌤️ Tap to collapse');
                }
            }
            
            updateWeatherWidget() {
                if (!this.currentData) return;
                
                const data = this.currentData;
                document.getElementById('widget-weather-icon').textContent = 
                    this.weatherIcons[data.weather?.condition] || '🌡️';
                document.getElementById('widget-temp').textContent = 
                    data.weather?.temperature ?? '--';
                document.getElementById('widget-condition').textContent = 
                    data.weather?.condition || 'Unknown';
                document.getElementById('widget-description').textContent = 
                    data.weather?.description || '';
                document.getElementById('widget-humidity').textContent = 
                    (data.weather?.humidity ?? '--') + '%';
                const periodText = data.time?.period || '--';
                document.getElementById('widget-period').textContent = periodText;
                // Also update the portrait standalone clock period
                const portraitPeriod = document.getElementById('portrait-clock-period');
                if (portraitPeriod) portraitPeriod.textContent = periodText;
                
                document.getElementById('widget-activity').textContent = 
                    data.currentImage?.activity || data.activity || '--';
            }
            
            startWidgetClock() {
                // Update both the widget clock and the portrait standalone clock
                const updateClock = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Hebron'
                    });
                    const period = now.getHours() < 12 ? 'AM' : 'PM';
                    
                    // Update the in-widget clock (visible on desktop/landscape)
                    document.getElementById('widget-clock').textContent = timeStr;
                    
                    // Update the portrait standalone clock (visible on mobile portrait)
                    const portraitClock = document.getElementById('portrait-clock-time');
                    if (portraitClock) portraitClock.textContent = timeStr;
                    
                    // Update the landscape standalone clock (visible on mobile landscape)
                    const landscapeClock = document.getElementById('landscape-clock-time');
                    const landscapePeriod = document.getElementById('landscape-clock-period');
                    if (landscapeClock) landscapeClock.textContent = timeStr;
                    if (landscapePeriod) landscapePeriod.textContent = period;
                };
                updateClock();
                
                // Only set interval if not already running
                if (!this.clockInterval) {
                    this.clockInterval = setInterval(updateClock, 1000);
                }
            }
            
            showImageInfo() {
                const infoPanel = document.getElementById('image-info');
                if (this.currentData) {
                    document.getElementById('info-title').textContent = this.currentData.title || '--';
                    document.getElementById('info-weather').textContent = this.currentData.weather || '--';
                    document.getElementById('info-time').textContent = this.currentData.time || '--';
                    document.getElementById('info-activity').textContent = this.currentData.activity || '--';
                    document.getElementById('info-updated').textContent = this.currentData.updated || '--';
                }
                infoPanel.classList.toggle('show');
            }
            
            initializeCommandCenter() {
                const commandCenter = document.getElementById('command-center');
                const commandButton = document.getElementById('command-center-button');
                const backdrop = document.getElementById('command-center-backdrop');
                const cmdReport = document.getElementById('cmd-report');
                const cmdVacuum = document.getElementById('cmd-vacuum');
                const cmdLights = document.getElementById('cmd-lights');
                const cmdImage = document.getElementById('cmd-image');
                
                // Toggle Command Center popup
                commandButton.addEventListener('click', () => {
                    commandCenter.classList.toggle('open');
                });
                
                // Close on backdrop tap
                backdrop.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                });
                
                // Report button → show report modal
                cmdReport.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showReportModal();
                });
                
                // Vacuum button → show vacuum panel
                cmdVacuum.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showVacuumPanel();
                });
                
                // Lights button → show lights panel
                cmdLights.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showLightsPanel();
                });
                
                // Image button → show image control panel
                cmdImage.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showImageControlPanel();
                });
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && commandCenter.classList.contains('open')) {
                        commandCenter.classList.remove('open');
                    }
                });
            }
            
            initializeReportModal() {
                const reportModal = document.getElementById('report-modal');
                const reportClose = document.getElementById('report-modal-close');
                const reportForm = document.getElementById('report-form');
                
                // Initialize Command Center (which includes report button)
                this.initializeCommandCenter();
                
                // Initialize Vacuum Panel
                this.initializeVacuumPanel();
                
                // Initialize Lights Panel
                this.initializeLightsPanel();
                
                // Initialize Image Control Panel
                this.initializeImageControlPanel();
                
                // Close modal when close button clicked
                reportClose.addEventListener('click', () => {
                    this.hideReportModal();
                });
                
                // Close modal when clicking outside
                reportModal.addEventListener('click', (e) => {
                    if (e.target === reportModal) {
                        this.hideReportModal();
                    }
                });
                
                // Handle form submission
                reportForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitReport();
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && reportModal.classList.contains('show')) {
                        this.hideReportModal();
                    }
                });
            }
            
            showReportModal() {
                const modal = document.getElementById('report-modal');
                const form = document.getElementById('report-form');
                const feedback = document.getElementById('report-feedback');
                
                // Reset form
                form.reset();
                form.style.display = 'flex';
                feedback.style.display = 'none';
                
                // Populate current image info if available
                if (this.currentData && this.currentData.currentImage) {
                    document.getElementById('report-image-id').value = this.currentData.currentImage.notion_id || this.currentData.currentImage.id || '';
                }
                
                // Lock body scroll when modal is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                modal.classList.add('show');
                
                // Focus on category select
                setTimeout(() => {
                    document.getElementById('report-category').focus();
                }, 100);
            }
            
            hideReportModal() {
                const modal = document.getElementById('report-modal');
                modal.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async submitReport() {
                const submitButton = document.getElementById('report-submit');
                const checkboxes = document.querySelectorAll('input[name="issue-type"]:checked');
                const selectedCategories = Array.from(checkboxes).map(cb => cb.value);
                const description = document.getElementById('report-description').value;
                const imageId = document.getElementById('report-image-id').value;
                
                if (selectedCategories.length === 0) {
                    this.showToast('⚠️ Please select at least one issue type');
                    return;
                }
                
                // Disable submit button
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                try {
                    // Gather context data for the report
                    const reportData = {
                        image_data: {
                            notion_id: imageId,
                            title: this.currentData?.currentImage?.title || '',
                            url: this.currentData?.currentImage?.url || '',
                            style: this.currentData?.currentImage?.style || '',
                            row_number: this.currentData?.currentImage?.row_number || 0
                        },
                        categories: selectedCategories,
                        notes: description,
                        context_data: {
                            time_of_day: this.currentData?.time?.period || '',
                            weather_shown: this.currentData?.weather?.condition || '',
                            actual_weather: this.currentData?.weather?.condition || '',
                            weather_mismatch: false, // Would need more logic to detect this
                            hebrew_date: '', // Would need Hebrew calendar integration
                            sunrise: '',
                            sunset: '',
                            holiday: null,
                            user_agent: navigator.userAgent,
                            screen_resolution: `${screen.width}x${screen.height}`,
                            platform: navigator.platform
                        }
                    };
                    
                    // Try to submit to server endpoint
                    let success = await this.submitReportToServer(reportData);
                    
                    // Fallback to localStorage if server fails
                    if (!success) {
                        success = this.submitReportToLocalStorage(reportData);
                    }
                    
                    this.showReportFeedback(success);
                    
                } catch (error) {
                    console.error('Error submitting report:', error);
                    // Fallback to localStorage
                    const success = this.submitReportToLocalStorage({
                        category,
                        description,
                        imageId,
                        timestamp: new Date().toISOString(),
                        imageTitle: this.currentData?.currentImage?.title || ''
                    });
                    this.showReportFeedback(success);
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Report';
                }
            }
            
            async submitReportToServer(reportData) {
                // Production API endpoint for image reports (deployed on Vercel)
                const API_ENDPOINT = 'https://alice-report-api.vercel.app/api/report';
                
                try {
                    console.log('Submitting report to API:', API_ENDPOINT);
                    console.log('Report data:', reportData);
                    
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(reportData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Report submitted to server successfully:', result);
                        return true;
                    } else {
                        console.warn('Server report submission failed:', response.status);
                        const errorText = await response.text();
                        console.warn('Error details:', errorText);
                        return false;
                    }
                } catch (error) {
                    console.warn('Network error submitting report:', error);
                    return false;
                }
            }
            
            submitReportToLocalStorage(reportData) {
                try {
                    const reportId = 'RPT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    const report = {
                        id: reportId,
                        ...reportData,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Get existing reports
                    const existingReports = JSON.parse(localStorage.getItem('aliceDisplayReports') || '[]');
                    existingReports.push(report);
                    
                    // Keep only last 50 reports to avoid storage bloat
                    if (existingReports.length > 50) {
                        existingReports.splice(0, existingReports.length - 50);
                    }
                    
                    localStorage.setItem('aliceDisplayReports', JSON.stringify(existingReports));
                    console.log('Report saved to localStorage:', reportId);
                    return true;
                } catch (error) {
                    console.error('Error saving report to localStorage:', error);
                    return false;
                }
            }
            
            showReportFeedback(success) {
                const form = document.getElementById('report-form');
                const feedback = document.getElementById('report-feedback');
                const icon = document.getElementById('report-feedback-icon');
                const title = document.getElementById('report-feedback-title');
                const message = document.getElementById('report-feedback-message');
                
                form.style.display = 'none';
                feedback.style.display = 'block';
                
                if (success) {
                    icon.textContent = '✅';
                    title.textContent = 'Report Submitted';
                    message.textContent = 'Thank you for your feedback! We\'ll review this issue.';
                } else {
                    icon.textContent = '❌';
                    title.textContent = 'Submission Failed';
                    message.textContent = 'Unable to submit report. Please try again later.';
                }
                
                // Auto-close modal after 3 seconds
                setTimeout(() => {
                    this.hideReportModal();
                }, 3000);
            }
            
            initializeVacuumPanel() {
                const vacuumPanel = document.getElementById('vacuum-panel');
                const vacuumClose = document.getElementById('vacuum-panel-close');
                const vacuumBtnStart = document.getElementById('vacuum-btn-start');
                const vacuumBtnStop = document.getElementById('vacuum-btn-stop');
                const vacuumBtnHome = document.getElementById('vacuum-btn-home');
                
                // Close panel when close button clicked
                vacuumClose.addEventListener('click', () => {
                    this.hideVacuumPanel();
                });
                
                // Close panel when clicking outside
                vacuumPanel.addEventListener('click', (e) => {
                    if (e.target === vacuumPanel) {
                        this.hideVacuumPanel();
                    }
                });
                
                // Vacuum control buttons
                vacuumBtnStart.addEventListener('click', () => this.vacuumStart());
                vacuumBtnStop.addEventListener('click', () => this.vacuumStop());
                vacuumBtnHome.addEventListener('click', () => this.vacuumGoHome());
                
                // Tap battery display to refresh
                const vacuumBattery = document.getElementById('vacuum-battery');
                vacuumBattery.style.cursor = 'pointer';
                vacuumBattery.addEventListener('click', () => {
                    this.showToast('🔄 Refreshing battery...');
                    this.loadVacuumStatus();
                });
                
                // Close panel with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && vacuumPanel.classList.contains('show')) {
                        this.hideVacuumPanel();
                    }
                });
            }
            
            async showVacuumPanel() {
                const panel = document.getElementById('vacuum-panel');
                
                // Lock body scroll when panel is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                panel.classList.add('show');
                
                // Load battery status when panel opens
                await this.loadVacuumStatus();
            }
            
            hideVacuumPanel() {
                const panel = document.getElementById('vacuum-panel');
                panel.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async loadVacuumStatus() {
                const batteryIcon = document.getElementById('vacuum-battery-icon');
                const batteryText = document.getElementById('vacuum-battery-text');
                
                // Show loading state
                batteryIcon.textContent = '⏳';
                batteryText.textContent = 'Loading...';
                
                try {
                    // First, try the local API server
                    const apiUrl = 'https://alice-vacuum-api.vercel.app';
                    const response = await fetch(`${apiUrl}/api/vacuum?action=status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device: 1 }),
                        signal: AbortSignal.timeout(15000)  // 15 second timeout (Ecovacs API is slow)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const isCharging = data.chargeState === 'charging' || data.charging;
                        this.updateVacuumBattery(data.battery, isCharging);
                        this.updateVacuumStatus(data.cleanState || data.clean_status, isCharging);
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.warn('API server not available, trying direct execution:', error.message);
                    
                    // Fallback: Try executing the command directly via browser (if possible)
                    // This won't work in a browser context, so we'll show a helpful message
                    batteryIcon.textContent = '🤖';
                    batteryText.textContent = 'Yiko Ready';
                    this.updateVacuumStatus('unknown', false);
                    
                    // Show a note about starting the API server
                    this.showToast('💡 Tip: Start vacuum API server for full functionality');
                }
            }
            
            updateVacuumBattery(batteryLevel, isCharging = false) {
                const batteryIcon = document.getElementById('vacuum-battery-icon');
                const batteryText = document.getElementById('vacuum-battery-text');
                
                // Determine battery icon based on level and charging state
                if (isCharging) {
                    batteryIcon.textContent = '🔌';
                    batteryText.textContent = `${batteryLevel}% (Charging)`;
                } else if (batteryLevel >= 80) {
                    batteryIcon.textContent = '🔋';
                    batteryText.textContent = `${batteryLevel}% (Full)`;
                } else if (batteryLevel >= 50) {
                    batteryIcon.textContent = '🔋';
                    batteryText.textContent = `${batteryLevel}% (Good)`;
                } else if (batteryLevel >= 20) {
                    batteryIcon.textContent = '🪫';
                    batteryText.textContent = `${batteryLevel}% (Low)`;
                } else {
                    batteryIcon.textContent = '🪫';
                    batteryText.textContent = `${batteryLevel}% (Very Low)`;
                }
            }
            
            updateVacuumStatus(cleanStatus, isCharging = false) {
                const statusDiv = document.getElementById('vacuum-status');
                const statusIcon = document.getElementById('vacuum-status-icon');
                const statusText = document.getElementById('vacuum-status-text');
                
                // Remove previous status classes
                statusDiv.classList.remove('cleaning', 'charging', 'idle');
                
                // Determine status display
                if (isCharging) {
                    statusIcon.textContent = '🔌';
                    statusText.textContent = 'Charging';
                    statusDiv.classList.add('charging');
                } else if (cleanStatus === 'cleaning' || cleanStatus === 'working') {
                    statusIcon.textContent = '🧹';
                    statusText.textContent = 'Cleaning';
                    statusDiv.classList.add('cleaning');
                } else if (cleanStatus === 'idle' || cleanStatus === 'stop' || cleanStatus === 'auto') {
                    statusIcon.textContent = '✅';
                    statusText.textContent = 'Ready';
                    statusDiv.classList.add('idle');
                } else if (cleanStatus === 'paused') {
                    statusIcon.textContent = '⏸️';
                    statusText.textContent = 'Paused';
                    statusDiv.classList.add('idle');
                } else if (cleanStatus === 'returning') {
                    statusIcon.textContent = '🏠';
                    statusText.textContent = 'Returning Home';
                    statusDiv.classList.add('charging');
                } else if (cleanStatus === 'unknown') {
                    statusIcon.textContent = '❓';
                    statusText.textContent = 'Unknown';
                } else {
                    statusIcon.textContent = '📍';
                    statusText.textContent = cleanStatus || 'Unknown';
                }
            }
            
            async vacuumStart() {
                await this.executeVacuumCommand('clean', 'Starting vacuum...', '✅ Vacuum started!');
            }
            
            async vacuumStop() {
                await this.executeVacuumCommand('stop', 'Stopping vacuum...', '⏹️ Vacuum stopped');
            }
            
            async vacuumGoHome() {
                await this.executeVacuumCommand('charge', 'Sending home...', '🏠 Going home');
            }
            
            async executeVacuumCommand(command, loadingMessage, successMessage) {
                const buttons = document.querySelectorAll('.vacuum-btn');
                const clickedBtn = document.querySelector(`.vacuum-btn-${command === 'clean' ? 'start' : command === 'charge' ? 'home' : 'stop'}`);
                
                // Disable all buttons and add loading state to clicked button
                buttons.forEach(btn => {
                    btn.disabled = true;
                });
                
                if (clickedBtn) {
                    clickedBtn.classList.add('loading');
                    const btnText = clickedBtn.querySelector('span:last-child');
                    if (btnText) btnText.textContent = 'Working...';
                }
                
                this.showToast(`⏳ ${loadingMessage}`);
                
                try {
                    // Use Vercel-hosted vacuum API
                    const apiUrl = 'https://alice-vacuum-api.vercel.app';
                    const response = await fetch(`${apiUrl}/api/vacuum?action=${command}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            device: 1,
                            command: command
                        }),
                        signal: AbortSignal.timeout(30000)  // 30 second timeout for commands
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.showToast(successMessage);
                            
                            // Auto-collapse Command Center after successful action (CMD-3-4)
                            this.hideVacuumPanel();
                            const commandCenter = document.getElementById('command-center');
                            commandCenter.classList.remove('open');
                        } else {
                            throw new Error(data.error || 'Command failed');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Vacuum ${command} failed:`, error.message);
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        // API server not available
                        this.showToast('🔧 API server needed - check setup instructions');
                        
                        // Show helpful information
                        const helpText = `To control Yiko:
1. cd /Users/agentcaras/.openclaw/workspace/alice-display-website
2. npm install && npm start
3. Refresh this page`;
                        
                        console.info(helpText);
                    } else {
                        this.showToast(`❌ ${error.message}`);
                    }
                } finally {
                    // Re-enable buttons and remove loading state
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('loading');
                    });
                    
                    // Reset button text
                    const startBtn = document.querySelector('.vacuum-btn-start span:last-child');
                    const stopBtn = document.querySelector('.vacuum-btn-stop span:last-child');
                    const homeBtn = document.querySelector('.vacuum-btn-home span:last-child');
                    
                    if (startBtn) startBtn.textContent = 'Start Cleaning';
                    if (stopBtn) stopBtn.textContent = 'Stop';
                    if (homeBtn) homeBtn.textContent = 'Go Home';
                }
            }
            
            initializeLightsPanel() {
                const lightsPanel = document.getElementById('lights-panel');
                const lightsClose = document.getElementById('lights-panel-close');
                const bedtimeBtn = document.getElementById('lights-bedtime');
                const daytimeBtn = document.getElementById('lights-daytime');
                const movieBtn = document.getElementById('lights-movie');
                
                // Close panel when close button clicked
                lightsClose.addEventListener('click', () => {
                    this.hideLightsPanel();
                });
                
                // Close panel when clicking outside
                lightsPanel.addEventListener('click', (e) => {
                    if (e.target === lightsPanel) {
                        this.hideLightsPanel();
                    }
                });
                
                // Bedtime preset
                bedtimeBtn.addEventListener('click', () => {
                    this.activateLightsPreset('bedtime');
                });
                
                // Daytime preset
                daytimeBtn.addEventListener('click', () => {
                    this.activateLightsPreset('daytime');
                });
                
                // Movie preset
                movieBtn.addEventListener('click', () => {
                    this.activateLightsPreset('movie');
                });
            }
            
            async showLightsPanel() {
                const panel = document.getElementById('lights-panel');
                
                // Lock body scroll when panel is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                panel.classList.add('show');
            }
            
            hideLightsPanel() {
                const panel = document.getElementById('lights-panel');
                panel.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async activateLightsPreset(preset) {
                // Disable all buttons temporarily
                const buttons = document.querySelectorAll('.lights-preset-btn');
                buttons.forEach(btn => btn.disabled = true);
                
                try {
                    let message = '';
                    let icon = '';
                    
                    switch (preset) {
                        case 'bedtime':
                            message = 'Setting bedtime mode...';
                            icon = '🌙';
                            break;
                        case 'daytime':
                            message = 'Setting daytime mode...';
                            icon = '☀️';
                            break;
                        case 'movie':
                            message = 'Setting movie mode...';
                            icon = '🎬';
                            break;
                    }
                    
                    this.showToast(message);
                    
                    // Send lights control request
                    const result = await this.sendLightsCommand(preset);
                    
                    if (result.success) {
                        // Auto-collapse Command Center and hide lights panel
                        this.hideLightsPanel();
                        document.getElementById('command-center').classList.remove('open');
                        
                        // Show success toast
                        this.showToast(`${icon} ${preset.charAt(0).toUpperCase() + preset.slice(1)} mode activated`);
                    } else {
                        this.showToast(`❌ Failed to set ${preset} mode: ${result.error}`);
                    }
                    
                } catch (error) {
                    console.error(`Error activating ${preset} preset:`, error);
                    this.showToast(`❌ Error: ${error.message}`);
                } finally {
                    // Re-enable buttons
                    buttons.forEach(btn => btn.disabled = false);
                }
            }
            
            async sendLightsCommand(preset) {
                try {
                    // Try to connect to local lights API server
                    // Run `npm start` in the alice-display-website directory to start the server
                    const response = await fetch('http://localhost:3001/api/lights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            preset: preset,
                            timestamp: Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                    
                } catch (error) {
                    // Fallback: log the command for manual execution
                    console.warn('Could not reach lights API, logging command for manual execution:', error);
                    
                    // Generate the OpenHue commands for manual execution
                    const commands = this.generateOpenHueCommands(preset);
                    console.info('OpenHue commands to run manually:', commands);
                    
                    // For demo purposes, simulate success
                    return { 
                        success: true, 
                        message: 'Commands logged to console',
                        commands: commands
                    };
                }
            }
            
            // ═══════════════════════════════════════════════════════════
            // IMAGE CONTROL PANEL METHODS
            // ═══════════════════════════════════════════════════════════
            
            initializeImageControlPanel() {
                const panel = document.getElementById('image-control-panel');
                const closeBtn = document.getElementById('image-control-close');
                const backdrop = document.getElementById('image-control-backdrop');
                const changeBtn = document.getElementById('img-change');
                const reportBtn = document.getElementById('img-report');
                const likeBtn = document.getElementById('img-like');
                const dislikeBtn = document.getElementById('img-dislike');
                
                // Track current image rating state
                this.currentImageRating = null; // null, 'liked', or 'disliked'
                
                // Close panel
                closeBtn.addEventListener('click', () => this.hideImageControlPanel());
                backdrop.addEventListener('click', () => this.hideImageControlPanel());
                
                // Button actions
                changeBtn.addEventListener('click', () => this.handleChangeImage());
                reportBtn.addEventListener('click', () => {
                    this.hideImageControlPanel();
                    this.showReportModal();
                });
                likeBtn.addEventListener('click', () => this.handleRateImage(1));
                dislikeBtn.addEventListener('click', () => this.handleRateImage(-1));
                
                // Close with Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && panel.classList.contains('show')) {
                        this.hideImageControlPanel();
                    }
                });
            }
            
            showImageControlPanel() {
                const panel = document.getElementById('image-control-panel');
                const backdrop = document.getElementById('image-control-backdrop');
                
                // Update rating button states based on current image
                this.updateRatingButtonStates();
                
                panel.classList.add('show');
                backdrop.classList.add('show');
            }
            
            hideImageControlPanel() {
                const panel = document.getElementById('image-control-panel');
                const backdrop = document.getElementById('image-control-backdrop');
                
                panel.classList.remove('show');
                backdrop.classList.remove('show');
            }
            
            updateRatingButtonStates() {
                const likeBtn = document.getElementById('img-like');
                const dislikeBtn = document.getElementById('img-dislike');
                
                // Check localStorage for existing rating on this image
                const imageId = this.currentData?.currentImage?.notion_id || this.currentData?.currentImage?.id;
                if (imageId) {
                    const ratings = JSON.parse(localStorage.getItem('aliceImageRatings') || '{}');
                    const rating = ratings[imageId];
                    
                    likeBtn.classList.toggle('active', rating === 1);
                    dislikeBtn.classList.toggle('active', rating === -1);
                    this.currentImageRating = rating || null;
                } else {
                    likeBtn.classList.remove('active');
                    dislikeBtn.classList.remove('active');
                    this.currentImageRating = null;
                }
            }
            
            async handleChangeImage() {
                const changeBtn = document.getElementById('img-change');
                const originalIcon = changeBtn.querySelector('.image-control-btn-icon').textContent;
                const originalText = changeBtn.querySelector('.image-control-btn-text').textContent;
                
                // Set loading state
                changeBtn.disabled = true;
                changeBtn.classList.add('loading');
                changeBtn.querySelector('.image-control-btn-text').textContent = 'Changing...';
                
                try {
                    // Get current image ID and context
                    const currentImageId = this.currentData?.currentImage?.notion_id || this.currentData?.currentImage?.id;
                    const context = {
                        weather: this.currentData?.weather?.condition || 'Sunny',
                        time_period: this.currentData?.time?.period || 'Afternoon',
                        hour: new Date().getHours()
                    };
                    
                    // Call the change image API (Vercel serverless function)
                    const API_BASE = 'https://alice-image-api.vercel.app';
                    const response = await fetch(`${API_BASE}/api/image/change`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            current_image_id: currentImageId,
                            context: context
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.image) {
                        // Update display with new image
                        const newImageData = {
                            ...this.currentData,
                            currentImage: {
                                ...this.currentData?.currentImage,
                                url: result.image.cloudinary_url || result.image.url,
                                title: result.image.title,
                                notion_id: result.image.id,
                                activity: result.image.activity
                            }
                        };
                        
                        this.currentData = newImageData;
                        await this.updateDisplay(newImageData, true);
                        
                        // Success feedback
                        changeBtn.classList.add('success');
                        setTimeout(() => changeBtn.classList.remove('success'), 500);
                        this.showToast('🔄 Image changed!');
                        
                        // Update rating buttons for new image
                        this.updateRatingButtonStates();
                        
                        // Auto-close after success
                        setTimeout(() => this.hideImageControlPanel(), 800);
                    } else {
                        throw new Error(result.message || 'No alternative images found');
                    }
                } catch (error) {
                    console.error('Change image error:', error);
                    changeBtn.classList.add('error');
                    setTimeout(() => changeBtn.classList.remove('error'), 500);
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        this.showToast('🔧 API not available - deploying soon!');
                    } else {
                        this.showToast(`❌ ${error.message}`);
                    }
                } finally {
                    // Reset button state
                    changeBtn.disabled = false;
                    changeBtn.classList.remove('loading');
                    changeBtn.querySelector('.image-control-btn-icon').textContent = originalIcon;
                    changeBtn.querySelector('.image-control-btn-text').textContent = originalText;
                }
            }
            
            async handleRateImage(rating) {
                const likeBtn = document.getElementById('img-like');
                const dislikeBtn = document.getElementById('img-dislike');
                const activeBtn = rating === 1 ? likeBtn : dislikeBtn;
                
                // If already rated same way, this is an "unrate"
                const imageId = this.currentData?.currentImage?.notion_id || this.currentData?.currentImage?.id;
                if (!imageId) {
                    this.showToast('⚠️ No image to rate');
                    return;
                }
                
                // Check if clicking same rating (toggle off)
                if (this.currentImageRating === rating) {
                    // Remove rating
                    this.saveRatingLocally(imageId, null);
                    this.currentImageRating = null;
                    likeBtn.classList.remove('active');
                    dislikeBtn.classList.remove('active');
                    this.showToast('Rating removed');
                    return;
                }
                
                // Set loading state
                activeBtn.disabled = true;
                activeBtn.classList.add('loading');
                
                try {
                    // Save locally first (optimistic update)
                    this.saveRatingLocally(imageId, rating);
                    this.currentImageRating = rating;
                    
                    // Update UI immediately
                    likeBtn.classList.toggle('active', rating === 1);
                    dislikeBtn.classList.toggle('active', rating === -1);
                    
                    // Try to submit to server (Vercel serverless function)
                    const API_BASE_RATE = 'https://alice-image-api.vercel.app';
                    const response = await fetch(`${API_BASE_RATE}/api/image/rate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_id: imageId,
                            rating: rating,
                            context: {
                                timestamp: new Date().toISOString(),
                                weather: this.currentData?.weather?.condition,
                                time_period: this.currentData?.time?.period,
                                user_agent: navigator.userAgent,
                                session_id: this.getSessionId()
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Rating submitted:', result);
                    } else {
                        console.warn('Server rating failed, but saved locally');
                    }
                    
                    // Success feedback
                    activeBtn.classList.add('success');
                    setTimeout(() => activeBtn.classList.remove('success'), 500);
                    this.showToast(rating === 1 ? '👍 Liked!' : '👎 Disliked');
                    
                } catch (error) {
                    console.warn('Rating API error (saved locally):', error);
                    // Still show success since we saved locally
                    activeBtn.classList.add('success');
                    setTimeout(() => activeBtn.classList.remove('success'), 500);
                    this.showToast(rating === 1 ? '👍 Liked! (saved locally)' : '👎 Disliked (saved locally)');
                } finally {
                    activeBtn.disabled = false;
                    activeBtn.classList.remove('loading');
                }
            }
            
            saveRatingLocally(imageId, rating) {
                const ratings = JSON.parse(localStorage.getItem('aliceImageRatings') || '{}');
                if (rating === null) {
                    delete ratings[imageId];
                } else {
                    ratings[imageId] = rating;
                }
                localStorage.setItem('aliceImageRatings', JSON.stringify(ratings));
            }
            
            getSessionId() {
                let sessionId = sessionStorage.getItem('aliceSessionId');
                if (!sessionId) {
                    sessionId = 'sess_' + Math.random().toString(36).substring(2, 15);
                    sessionStorage.setItem('aliceSessionId', sessionId);
                }
                return sessionId;
            }
            
            generateOpenHueCommands(preset) {
                const lightIds = [
                    "6a704bb0-d201-4343-8939-3cd98ee80643", // Kitchen fan 3-24
                    "2923d843-cf08-4ed8-aa79-27c722c08bbe", // Kitchen BW fan
                    "24da2926-210d-4b34-af37-7ecbf613b576", // Kitchen fan 2- 3/24
                    "1c124fbc-0d5f-4d3d-b84c-35fe208cff84", // Kitchen high lamp
                    "aa86140d-999d-465e-8c90-ba4d64664e72", // Zahava lamp
                    "a02ac2d6-482e-48c9-9f39-397008b6670a", // Outside Flood
                    "f0390f66-031a-4131-83de-b31b3fa9a05b", // Hue color lamp 2
                    "741900cf-413a-43e3-be6c-6a3f49c23cfb", // Hue color lamp 1
                    "9376f857-21b9-4a96-9cf4-92cd50cf987d", // Dining room fan - 4/24
                    "9993b466-9fcd-436e-8d78-1e7d835f7b80", // Living room lamp 3/24
                    "0dc211bd-b00a-42b6-b484-e49dbe79d05e", // Living room fan 3-24 #2
                    "9bd2567a-1683-4eeb-83c7-c66f2b214873", // Downstairs entrance 2
                    "fd64c7ac-4a70-4015-87d4-48264e7a9631", // fan above table
                    "c3edaddf-d9a0-4277-ad19-9a5ad8b3085c", // Dinning room March 23
                    "ebf4d80f-5b73-4a08-84a2-0250808f5533", // Living Room Fan 2
                    "ca5e5869-8b91-4135-94e7-69277f8d4beb", // Downstairs entrance 1
                    "9f2037a2-116c-4147-96a1-d6098fc44a03", // dinning room strip
                    "4122d13e-0c3e-4a06-b752-4b90add03a6f", // Living room tv strip
                    "dfc85340-54aa-44e1-82a4-4b6d2d46a8b4", // living room piano
                    "7e629fd1-c5c3-4e59-b650-b7d0f342ce7c", // Master bedroom left July 22
                    "5c0681a9-d2f9-4716-8844-4d91e996deac", // master bed left
                    "346c7450-096e-4857-b0a0-887ef98c3e8b"  // master bed right
                ];
                
                let commands = [];
                
                switch (preset) {
                    case 'bedtime':
                        // Set all lights to 1% brightness
                        lightIds.forEach(lightId => {
                            commands.push(`openhue set light "${lightId}" --on --brightness 1`);
                        });
                        break;
                        
                    case 'daytime':
                        // Set all lights to 100% brightness
                        lightIds.forEach(lightId => {
                            commands.push(`openhue set light "${lightId}" --on --brightness 100`);
                        });
                        break;
                        
                    case 'movie':
                        // Set all lights to 30% brightness, add blue color for color-capable lights
                        const colorCapableLights = [
                            "6a704bb0-d201-4343-8939-3cd98ee80643", // Kitchen fan 3-24
                            "24da2926-210d-4b34-af37-7ecbf613b576", // Kitchen fan 2- 3/24
                            "1c124fbc-0d5f-4d3d-b84c-35fe208cff84", // Kitchen high lamp
                            "aa86140d-999d-465e-8c90-ba4d64664e72", // Zahava lamp
                            "a02ac2d6-482e-48c9-9f39-397008b6670a", // Outside Flood
                            "f0390f66-031a-4131-83de-b31b3fa9a05b", // Hue color lamp 2
                            "741900cf-413a-43e3-be6c-6a3f49c23cfb", // Hue color lamp 1
                            "9376f857-21b9-4a96-9cf4-92cd50cf987d", // Dining room fan - 4/24
                            "9993b466-9fcd-436e-8d78-1e7d835f7b80", // Living room lamp 3/24
                            "0dc211bd-b00a-42b6-b484-e49dbe79d05e", // Living room fan 3-24 #2
                            "fd64c7ac-4a70-4015-87d4-48264e7a9631", // fan above table
                            "c3edaddf-d9a0-4277-ad19-9a5ad8b3085c", // Dinning room March 23
                            "ebf4d80f-5b73-4a08-84a2-0250808f5533", // Living Room Fan 2
                            "9f2037a2-116c-4147-96a1-d6098fc44a03", // dinning room strip
                            "4122d13e-0c3e-4a06-b752-4b90add03a6f", // Living room tv strip
                            "dfc85340-54aa-44e1-82a4-4b6d2d46a8b4", // living room piano
                            "7e629fd1-c5c3-4e59-b650-b7d0f342ce7c", // Master bedroom left July 22
                            "5c0681a9-d2f9-4716-8844-4d91e996deac", // master bed left
                            "346c7450-096e-4857-b0a0-887ef98c3e8b"  // master bed right
                        ];
                        
                        lightIds.forEach(lightId => {
                            if (colorCapableLights.includes(lightId)) {
                                commands.push(`openhue set light "${lightId}" --on --brightness 30 --color blue`);
                            } else {
                                commands.push(`openhue set light "${lightId}" --on --brightness 30`);
                            }
                        });
                        break;
                }
                
                return commands;
            }
            
            closeAllPanels() {
                document.getElementById('help-overlay').classList.remove('show');
                document.getElementById('image-info').classList.remove('show');
                document.getElementById('report-modal').classList.remove('show');
                document.getElementById('vacuum-panel').classList.remove('show');
                document.getElementById('lights-panel').classList.remove('show');
                document.getElementById('image-control-panel').classList.remove('show');
                document.getElementById('image-control-backdrop').classList.remove('show');
                // Note: status overlay toggle is separate - not included in close all panels
                this.debugEl.classList.remove('show');
            }
            
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 1500);
            }
            
            startPolling() {
                // Update countdown display
                let nextPoll = Date.now() + this.pollInterval;
                
                const updateCountdown = () => {
                    const remaining = Math.max(0, Math.ceil((nextPoll - Date.now()) / 1000));
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    this.countdownEl.textContent = `Next check in ${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                setInterval(updateCountdown, 1000);
                
                // Main polling loop
                setInterval(() => {
                    if (!this.isPaused) {
                        this.loadDisplay();
                    }
                    nextPoll = Date.now() + this.pollInterval;
                }, this.pollInterval);
                
                console.log('🦜 Alice Display initialized');
                console.log(`📡 Auto-refresh every ${this.pollInterval / 1000 / 60} minutes`);
            }
        }
        
        // Browser Detection Utility
        const BrowserDetect = {
            // Detect Safari (including iOS Safari)
            isSafari: () => {
                const ua = navigator.userAgent;
                const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
                const isIOSSafari = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
                return isSafari || isIOSSafari;
            },
            
            // Detect Chrome (including iOS Chrome)
            isChrome: () => {
                const ua = navigator.userAgent;
                return /chrome/i.test(ua) && !/edge/i.test(ua);
            },
            
            // Detect iOS (any browser)
            isIOS: () => {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            },
            
            // Detect iOS Chrome (uses Safari WebKit underneath)
            isIOSChrome: () => {
                return /CriOS/.test(navigator.userAgent);
            },
            
            // Detect Android
            isAndroid: () => {
                return /android/i.test(navigator.userAgent);
            },
            
            // Get browser name
            getBrowser: () => {
                if (BrowserDetect.isIOSChrome()) return 'ios-chrome';
                if (BrowserDetect.isSafari()) return 'safari';
                if (BrowserDetect.isChrome()) return 'chrome';
                return 'other';
            },
            
            // Get platform
            getPlatform: () => {
                if (BrowserDetect.isIOS()) return 'ios';
                if (BrowserDetect.isAndroid()) return 'android';
                return 'desktop';
            },
            
            // Apply classes to body
            applyClasses: () => {
                const browser = BrowserDetect.getBrowser();
                const platform = BrowserDetect.getPlatform();
                
                document.body.classList.add(`browser-${browser}`);
                document.body.classList.add(`platform-${platform}`);
                
                // Log for debugging
                console.log(`🌐 Browser: ${browser}, Platform: ${platform}`);
            }
        };
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Apply browser detection classes first
            BrowserDetect.applyClasses();
            
            // DIRECT FIX: Force command center position on iOS Safari portrait
            if (BrowserDetect.isIOS() && window.innerWidth <= 480 && window.innerHeight > window.innerWidth) {
                const commandCenter = document.getElementById('command-center');
                if (commandCenter) {
                    commandCenter.style.cssText = 'position: fixed !important; bottom: 140px !important; top: auto !important; right: 20px !important;';
                    console.log('📱 iOS Safari portrait fix applied: bottom=140px, top=auto');
                }
            }
            
            // Initialize display
            new AliceDisplay();
        });
        
        // PWA Install Prompt Handler
        class InstallPrompt {
            constructor() {
                this.deferredPrompt = null;
                this.banner = document.getElementById('install-banner');
                this.installBtn = document.getElementById('install-btn');
                this.dismissBtn = document.getElementById('install-dismiss');
                this.iosModal = document.getElementById('ios-modal');
                this.iosModalClose = document.getElementById('ios-modal-close');
                
                this.init();
            }
            
            init() {
                // Check if already installed or dismissed
                if (this.isInstalled() || this.isDismissed()) {
                    return;
                }
                
                // Check for iOS
                if (this.isIOS()) {
                    this.setupIOSPrompt();
                    return;
                }
                
                // Listen for beforeinstallprompt (Chrome/Edge)
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showBanner();
                });
                
                // Handle install button click
                this.installBtn.addEventListener('click', () => this.handleInstall());
                this.dismissBtn.addEventListener('click', () => this.handleDismiss());
                
                // Listen for successful install
                window.addEventListener('appinstalled', () => {
                    console.log('🦜 App installed successfully!');
                    this.hideBanner();
                    this.deferredPrompt = null;
                });
            }
            
            isInstalled() {
                // Check if running as installed PWA
                return window.matchMedia('(display-mode: standalone)').matches ||
                       window.navigator.standalone === true;
            }
            
            isDismissed() {
                const dismissed = localStorage.getItem('installDismissed');
                if (!dismissed) return false;
                
                // Allow re-prompting after 7 days
                const dismissedTime = parseInt(dismissed, 10);
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                return (Date.now() - dismissedTime) < sevenDays;
            }
            
            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            }
            
            isIPad() {
                return /iPad/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }
            
            isIOSSafari() {
                const ua = navigator.userAgent;
                const iOS = /iPad|iPhone|iPod/.test(ua);
                const webkit = /WebKit/.test(ua);
                const notChrome = !/CriOS/.test(ua);
                const notFirefox = !/FxiOS/.test(ua);
                const notEdge = !/EdgiOS/.test(ua);
                return iOS && webkit && notChrome && notFirefox && notEdge;
            }
            
            setupIOSPrompt() {
                // Get additional iOS modal elements
                const iosModalDismiss = document.getElementById('ios-modal-dismiss');
                const safariNote = this.iosModal.querySelector('.ios-safari-note');
                
                // Update note if not in Safari
                if (!this.isIOSSafari() && safariNote) {
                    safariNote.innerHTML = `
                        <strong>⚠️ Open in Safari</strong><br>
                        You're not in Safari. Copy this link and open it in Safari to install:
                        <div id="safari-url-copy" style="margin-top:8px;padding:10px;background:rgba(255,255,255,0.1);border-radius:6px;font-size:11px;word-break:break-all;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.15s ease;position:relative;">
                            ${window.location.href}
                            <div id="url-copy-toast" style="position:absolute;top:-30px;left:50%;transform:translateX(-50%);background:rgba(34,197,94,0.9);color:white;padding:4px 12px;border-radius:8px;font-size:11px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.25s ease;">📋 Copied!</div>
                        </div>
                    `;
                    safariNote.style.color = 'rgba(255, 200, 100, 0.8)';
                    
                    // Make the URL text tappable to copy to clipboard
                    const urlCopyEl = document.getElementById('safari-url-copy');
                    if (urlCopyEl) {
                        urlCopyEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const siteUrl = window.location.href;
                            const toast = document.getElementById('url-copy-toast');
                            
                            // Flash the background to show tap feedback
                            urlCopyEl.style.background = 'rgba(255,255,255,0.25)';
                            setTimeout(() => { urlCopyEl.style.background = 'rgba(255,255,255,0.1)'; }, 200);
                            
                            // Copy to clipboard
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(siteUrl).then(() => {
                                    if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                                }).catch(() => {
                                    // Fallback for non-HTTPS or permission denied
                                    const ta = document.createElement('textarea');
                                    ta.value = siteUrl;
                                    ta.style.cssText = 'position:fixed;opacity:0';
                                    document.body.appendChild(ta);
                                    ta.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(ta);
                                    if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                                });
                            } else {
                                // Fallback
                                const ta = document.createElement('textarea');
                                ta.value = siteUrl;
                                ta.style.cssText = 'position:fixed;opacity:0';
                                document.body.appendChild(ta);
                                ta.select();
                                document.execCommand('copy');
                                document.body.removeChild(ta);
                                if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                            }
                        });
                    }
                }
                
                // Update text for iPad
                if (this.isIPad()) {
                    const stepDesc = this.iosModal.querySelector('.ios-step-desc');
                    if (stepDesc) {
                        stepDesc.textContent = 'Find it at the top of Safari';
                    }
                }
                
                // Show banner after a short delay on iOS
                setTimeout(() => {
                    this.showBanner();
                }, 3000);
                
                this.installBtn.addEventListener('click', () => {
                    this.iosModal.classList.add('show');
                    this.hideBanner();
                });
                
                this.dismissBtn.addEventListener('click', () => this.handleDismiss());
                
                // "Got it" button - just closes modal
                this.iosModalClose.addEventListener('click', () => {
                    this.iosModal.classList.remove('show');
                });
                
                // "Don't show again" button - closes and permanently dismisses
                if (iosModalDismiss) {
                    iosModalDismiss.addEventListener('click', () => {
                        this.iosModal.classList.remove('show');
                        // Set a very long dismissal (365 days)
                        const oneYear = 365 * 24 * 60 * 60 * 1000;
                        localStorage.setItem('installDismissed', (Date.now() + oneYear).toString());
                    });
                }
                
                // Close modal on backdrop click
                this.iosModal.addEventListener('click', (e) => {
                    if (e.target === this.iosModal) {
                        this.iosModal.classList.remove('show');
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.iosModal.classList.contains('show')) {
                        this.iosModal.classList.remove('show');
                    }
                });
            }
            
            showBanner() {
                // Delay showing to not interrupt initial experience
                setTimeout(() => {
                    this.banner.classList.add('show');
                }, 5000);
            }
            
            hideBanner() {
                this.banner.classList.remove('show');
            }
            
            async handleInstall() {
                if (!this.deferredPrompt) {
                    console.log('No install prompt available');
                    return;
                }
                
                // Show the install prompt
                this.deferredPrompt.prompt();
                
                // Wait for user response
                const { outcome } = await this.deferredPrompt.userChoice;
                console.log(`Install prompt outcome: ${outcome}`);
                
                this.deferredPrompt = null;
                this.hideBanner();
            }
            
            handleDismiss() {
                localStorage.setItem('installDismissed', Date.now().toString());
                this.hideBanner();
            }
        }
        
        // Initialize install prompt
        new InstallPrompt();
        
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('🦜 Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);  // Check hourly
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('🦜 New version available');
                                    // Optionally notify user or auto-update
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('Service Worker registration failed:', error);
                    });
                
                // Listen for controller changes (new SW activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('🦜 Service Worker updated, reloading...');
                    window.location.reload();
                });
            });
        }
    </script>
</body>
</html>
