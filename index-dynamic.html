<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Alice Display</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        
        .display-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height - better on mobile Safari */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        /* Dual image layers for crossfade */
        .image-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease-in-out;
        }
        
        .image-layer img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            /* Ken Burns base - slightly larger to allow movement */
            transform-origin: center center;
        }
        
        /* Ken Burns effect animations */
        @keyframes kenburns-1 {
            0% { transform: scale(1.0) translate(0, 0); }
            100% { transform: scale(1.08) translate(-1%, -1%); }
        }
        
        @keyframes kenburns-2 {
            0% { transform: scale(1.0) translate(0, 0); }
            100% { transform: scale(1.08) translate(1%, -0.5%); }
        }
        
        @keyframes kenburns-3 {
            0% { transform: scale(1.05) translate(-0.5%, 0.5%); }
            100% { transform: scale(1.0) translate(0, 0); }
        }
        
        @keyframes kenburns-4 {
            0% { transform: scale(1.08) translate(0.5%, -1%); }
            100% { transform: scale(1.02) translate(-0.5%, 0.5%); }
        }
        
        .image-layer.active img.kenburns {
            animation-duration: 20s;
            animation-timing-function: ease-in-out;
            animation-fill-mode: forwards;
        }
        
        .image-layer.active img.kenburns-1 { animation-name: kenburns-1; }
        .image-layer.active img.kenburns-2 { animation-name: kenburns-2; }
        .image-layer.active img.kenburns-3 { animation-name: kenburns-3; }
        .image-layer.active img.kenburns-4 { animation-name: kenburns-4; }
        
        /* Pause Ken Burns when user prefers reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .image-layer.active img.kenburns {
                animation: none;
            }
        }
        
        .image-layer.active {
            opacity: 1;
            z-index: 2;
        }
        
        .image-layer.inactive {
            opacity: 0;
            z-index: 1;
        }
        
        /* Weather/Time overlay (bottom bar) - now toggleable at bottom-LEFT */
        .status-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            transform: none;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.4s ease, width 0.4s ease, padding 0.4s ease, border-radius 0.4s ease;
            z-index: 10;
            cursor: pointer;
        }
        
        .status-overlay.visible {
            opacity: 1;
        }
        
        /* Collapsed state - small circular indicator */
        .status-overlay.collapsed {
            width: 50px;
            height: 50px;
            padding: 0 !important;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            gap: 0 !important;
            opacity: 0.8;
            overflow: hidden;
        }
        
        /* Hide all items except first one when collapsed */
        .status-overlay.collapsed .status-item:not(:first-child) {
            display: none !important;
        }
        
        /* First status item takes full container in collapsed state */
        .status-overlay.collapsed .status-item:first-child {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            margin: 0;
            padding: 0;
        }
        
        /* Hide text elements completely in collapsed state */
        .status-overlay.collapsed .status-item:first-child > div {
            display: none !important;
        }
        
        /* Weather icon: flex container for perfect centering */
        .status-overlay.collapsed .status-item:first-child .icon {
            font-size: 24px;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            line-height: 1;
            text-align: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item .icon {
            font-size: 18px;
        }
        
        .status-item .label {
            opacity: 0.7;
            font-size: 12px;
        }
        
        .status-item .value {
            font-weight: 500;
        }
        
        /* Tap-to-copy: makes the activity item tappable */
        .tap-to-copy {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.15s ease;
        }
        
        .tap-to-copy:active {
            opacity: 0.6;
        }
        
        /* Copy confirmation toast â€” floats above the status bar */
        .copy-toast {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            margin-bottom: 8px;
        }
        
        .copy-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Weather widget overlay (corner) - reverted to original */
        .weather-widget {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(30,30,50,0.9) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            color: white;
            min-width: 180px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.4s ease, transform 0.4s ease;
            z-index: 15;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .weather-widget.hidden {
            /* Collapsed state: small icon only */
            width: 50px;
            height: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 8px;
            border-radius: 25px;
            overflow: hidden;
        }
        
        /* Hide all content except icon when collapsed */
        .weather-widget.hidden .weather-widget-temp,
        .weather-widget.hidden .weather-widget-condition,
        .weather-widget.hidden .weather-widget-description,
        .weather-widget.hidden .weather-widget-divider,
        .weather-widget.hidden .weather-widget-details,
        .weather-widget.hidden .weather-widget-time {
            display: none;
        }
        
        .weather-widget.hidden .weather-widget-icon {
            font-size: 28px;
        }
        
        .weather-widget.hidden .weather-widget-header {
            margin: 0;
            justify-content: center;
        }
        
        .weather-widget-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .weather-widget-icon {
            font-size: 42px;
            line-height: 1;
        }
        
        .weather-widget-temp {
            font-size: 32px;
            font-weight: 300;
        }
        
        .weather-widget-temp .unit {
            font-size: 18px;
            opacity: 0.7;
        }
        
        .weather-widget-condition {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .weather-widget-description {
            font-size: 12px;
            opacity: 0.6;
            text-transform: capitalize;
        }
        
        .weather-widget-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 12px 0;
        }
        
        .weather-widget-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .weather-widget-detail {
            text-align: center;
        }
        
        .weather-widget-detail-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .weather-widget-detail-label {
            opacity: 0.5;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .weather-widget-time {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .weather-widget-clock {
            font-size: 24px;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }
        
        .weather-widget-period {
            font-size: 14px;
            opacity: 0.8;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PORTRAIT CLOCK â€” Large standalone clock for mobile portrait.
           Sits in the top-right dead space, hidden on desktop/landscape.
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .portrait-clock {
            display: none;  /* Hidden by default â€” only shown on mobile portrait */
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE PORTRAIT LAYOUT
           On portrait phones, we position the weather widget in the
           top-left corner where it can toggle on/off smoothly.
           When expanded, the image gets slightly shrunk to avoid overlap.
           When collapsed, image uses full space.
           
           Detection: max-width 480px AND portrait orientation.
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 480px) and (orientation: portrait) {
            /* â”€â”€ Portrait: ensure dark background for any visible areas â”€â”€â”€â”€ */
            .display-container {
                background: #1a1a2e;
            }
            
            /* â”€â”€ Portrait: constrain image to fit viewport with space for UI elements â”€â”€â”€â”€ */
            .image-layer {
                /* Center image in the available space, accounting for notch */
                /* Fallbacks for Chrome which doesn't support env() */
                padding-top: 100px;
                padding-top: max(100px, calc(env(safe-area-inset-top, 0px) + 50px));
                padding-bottom: 60px;
                padding-bottom: max(60px, calc(env(safe-area-inset-bottom, 0px) + 40px));
                box-sizing: border-box;
            }
            
            .image-layer img {
                /* Constrain to fit within padded area */
                max-height: calc(100dvh - 140px);
                max-width: 100vw;
                width: auto;
                height: auto;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }
            
            .weather-widget {
                /* Reposition to top-left corner, accounting for notch */
                /* Use max() for Chrome fallback (doesn't support env() properly) */
                top: 55px; /* Fallback for browsers without env() support */
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                bottom: auto;
                left: 20px;
                right: auto;
                transform: none;
                
                /* More compact for mobile */
                min-width: auto;
                max-width: 200px;
                width: auto;
                padding: 12px;
                border-radius: 12px;
            }
            
            /* Collapsed state positioning */
            .weather-widget.collapsed {
                top: 55px;
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                left: 20px;
            }
            
            /* Horizontal layout for the header (icon + temp side by side with condition) */
            .weather-widget-header {
                margin-bottom: 6px;
                gap: 8px;
            }
            
            .weather-widget-icon {
                font-size: 28px;
            }
            
            .weather-widget-temp {
                font-size: 22px;
            }
            
            .weather-widget-temp .unit {
                font-size: 14px;
            }
            
            .weather-widget-condition {
                font-size: 13px;
                margin-bottom: 2px;
            }
            
            .weather-widget-description {
                font-size: 10px;
            }
            
            .weather-widget-divider {
                margin: 6px 0;
            }
            
            .weather-widget-details {
                font-size: 11px;
            }
            
            .weather-widget-detail-value {
                font-size: 13px;
            }
            
            .weather-widget-detail-label {
                font-size: 9px;
            }
            
            .weather-widget-time {
                margin-top: 6px;
                padding-top: 6px;
            }
            
            .weather-widget-clock {
                font-size: 18px;
            }
            
            .weather-widget-period {
                font-size: 12px;
                padding: 3px 8px;
            }
            
            /* Hide the clock row inside the weather widget on portrait */
            .weather-widget-time {
                display: none;
            }
            
            /* Portrait clock - top right with proper padding */
            .portrait-clock {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                position: fixed;
                top: 55px; /* Fallback for Chrome */
                top: max(55px, calc(env(safe-area-inset-top, 0px) + 8px));
                right: 15px;
                z-index: 15;
                color: white;
                text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            }
            
            .portrait-clock-time {
                font-size: 36px;
                font-weight: 200;
                letter-spacing: 1px;
                font-variant-numeric: tabular-nums;
                line-height: 1;
            }
            
            .portrait-clock-period {
                font-size: 11px;
                font-weight: 500;
                opacity: 0.9;
                margin-top: 4px;
                background: rgba(0,0,0,0.4);
                padding: 3px 8px;
                border-radius: 6px;
            }
            
            /* End portrait clock */
            /* Hide title overlay on mobile - it clutters the display */
            .title-overlay {
                display: none !important;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE LANDSCAPE LAYOUT
           On landscape phones, the square image fills the viewport
           height, leaving dead space on left and right. We shift
           the image to the right and dock the weather widget in
           the left dead space so they don't overlap.
           
           Detection: max-height 480px AND landscape orientation.
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-height: 480px) and (orientation: landscape) {
            /* Shift image container to use a right-biased layout */
            .display-container {
                justify-content: flex-end;
                padding-right: 5vw;
            }
            
            /* CRITICAL: Constrain image to viewport height in landscape */
            .image-layer img {
                max-height: calc(100vh - 24px); /* Small padding for breathing room */
                max-width: calc(100vw - 240px); /* Leave space for weather widget on left */
                width: auto;
                height: auto;
            }
            
            /* Weather widget docks to the left dead space */
            .weather-widget {
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                right: auto;
                min-width: auto;
                width: auto;
                max-width: 200px;
                padding: 14px 16px;
                border-radius: 16px;
            }
            
            /* Slightly compact widget for landscape */
            .weather-widget-header {
                gap: 8px;
                margin-bottom: 8px;
            }
            
            .weather-widget-icon {
                font-size: 30px;
            }
            
            .weather-widget-temp {
                font-size: 24px;
            }
            
            .weather-widget-temp .unit {
                font-size: 14px;
            }
            
            .weather-widget-condition {
                font-size: 14px;
            }
            
            .weather-widget-description {
                font-size: 11px;
            }
            
            .weather-widget-divider {
                margin: 8px 0;
            }
            
            .weather-widget-clock {
                font-size: 20px;
            }
            
            .weather-widget-period {
                font-size: 12px;
                padding: 3px 8px;
            }
            
            /* Hide the portrait-only clock in landscape */
            .portrait-clock {
                display: none !important;
            }
        }
        
        /* Update indicator */
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 200, 100, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 10;
        }
        
        .update-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Loading spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 5;
        }
        
        .loading-spinner.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Image title overlay */
        .title-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
            max-width: 80%;
            z-index: 10;
        }
        
        .title-overlay.visible {
            opacity: 1;
        }
        
        /* Hide title overlay on ALL mobile devices (< 768px) */
        @media (max-width: 768px) {
            .title-overlay,
            .title-overlay.visible {
                display: none !important;
                opacity: 0 !important;
            }
        }
        
        /* Debug panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            display: none;
            max-width: 300px;
            z-index: 20;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Fullscreen button */
        .fullscreen-btn {
            position: fixed;
            bottom: max(20px, calc(10px + env(safe-area-inset-bottom, 10px)));
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            opacity: 0.3;
            transition: opacity 0.3s, transform 0.2s;
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* Error state */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(255, 100, 100, 0.3);
            color: white;
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            display: none;
            z-index: 15;
            backdrop-filter: blur(10px);
            max-width: 85vw;
            width: auto;
            min-width: 280px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .error-message.show {
            display: block;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .error-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .error-detail {
            font-size: 13px;
            opacity: 0.7;
            margin-bottom: 15px;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .error-retry-counter {
            font-size: 13px;
            font-weight: 600;
            color: #ff7043;
            margin-bottom: 10px;
            padding: 4px 12px;
            background: rgba(255, 112, 67, 0.15);
            border-radius: 12px;
            display: inline-block;
        }
        
        .error-retry {
            font-size: 12px;
            opacity: 0.5;
        }
        
        .error-retry .countdown {
            font-weight: 600;
            color: #64b5f6;
        }
        
        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .connection-status.visible {
            opacity: 1;
        }
        
        .connection-status.error {
            background: rgba(255, 80, 80, 0.8);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .connection-status.error .connection-dot {
            background: #fff;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Fallback image styling */
        .fallback-active .image-layer img {
            filter: grayscale(30%) brightness(0.8);
        }
        
        .fallback-badge {
            position: fixed;
            bottom: max(80px, calc(60px + env(safe-area-inset-bottom, 20px)));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 150, 0, 0.9);
            color: white;
            padding: 6px 16px;
            border-radius: 15px;
            font-size: 11px;
            display: none;
            z-index: 10;
        }
        
        .fallback-badge.show {
            display: block;
        }
        
        /* Next update countdown */
        .countdown {
            position: fixed;
            bottom: max(70px, calc(50px + env(safe-area-inset-bottom, 20px)));
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.3);
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .countdown.visible {
            opacity: 1;
        }
        
        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .install-banner.show {
            transform: translateY(0);
        }
        
        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .install-banner-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .install-banner-text {
            color: white;
        }
        
        .install-banner-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .install-banner-subtitle {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .install-banner-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .install-btn:active {
            transform: scale(0.98);
        }
        
        .dismiss-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        
        .dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* iOS Install Instructions Modal */
        .ios-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .ios-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .ios-modal-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 24px;
            padding: 32px 28px;
            max-width: 340px;
            text-align: center;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .ios-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .ios-modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ios-modal-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 24px;
        }
        
        .ios-modal-steps {
            text-align: left;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .ios-modal-step {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: background 0.2s;
        }
        
        .ios-modal-step:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .ios-step-number {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .ios-step-content {
            flex: 1;
        }
        
        .ios-step-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .ios-step-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .ios-share-icon {
            display: inline-block;
            background: #007AFF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            vertical-align: middle;
        }
        
        .ios-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .ios-modal-close {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .ios-modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .ios-modal-close:active {
            transform: translateY(0);
        }
        
        .ios-modal-dismiss {
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            border: none;
            padding: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .ios-modal-dismiss:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .ios-safari-note {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ios-safari-note strong {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .install-banner {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .install-banner-content {
                flex-direction: column;
            }
            
            .install-banner-actions {
                width: 100%;
            }
            
            .install-btn, .dismiss-btn {
                flex: 1;
            }
        }
        
        /* Help overlay */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .help-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .help-content {
            background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 30px 40px;
            max-width: 500px;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .help-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-shortcuts {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px 20px;
        }
        
        .help-key {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            text-align: center;
            min-width: 60px;
        }
        
        .help-desc {
            font-size: 14px;
            opacity: 0.8;
            display: flex;
            align-items: center;
        }
        
        .help-close {
            margin-top: 24px;
            text-align: center;
            font-size: 12px;
            opacity: 0.5;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 300;
            pointer-events: none;
        }
        
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Pause indicator */
        .pause-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 150, 0, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: none;
            z-index: 15;
        }
        
        .pause-indicator.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Image info panel */
        .image-info {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            color: white;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 50;
        }
        
        .image-info.show {
            opacity: 1;
            visibility: visible;
        }
        
        .image-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }
        
        .image-info-row:last-child {
            border-bottom: none;
        }
        
        .image-info-label {
            opacity: 0.6;
        }
        
        .image-info-value {
            font-weight: 500;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMMAND CENTER
           Bottom-right button that expands to show 3 feature icons:
           Report (ğŸš©), Vacuum (ğŸ¤–), Lights (ğŸ’¡)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .command-center {
            position: fixed;
            bottom: 24px;
            bottom: max(24px, calc(10px + env(safe-area-inset-bottom, 14px)));
            right: 24px;
            z-index: 60;
        }
        
        /* Mobile Safari toolbar takes ~80px at bottom */
        @media (max-width: 480px) and (orientation: portrait) {
            .command-center {
                bottom: 90px;
                bottom: max(90px, calc(70px + env(safe-area-inset-bottom, 20px)));
            }
            
            .status-overlay {
                bottom: 90px;
                bottom: max(90px, calc(70px + env(safe-area-inset-bottom, 20px)));
            }
            
            .fallback-badge {
                bottom: 130px;
                bottom: max(130px, calc(110px + env(safe-area-inset-bottom, 20px)));
            }
            
            .countdown {
                bottom: 120px;
                bottom: max(120px, calc(100px + env(safe-area-inset-bottom, 20px)));
            }
            
            .fullscreen-btn {
                bottom: 90px;
                bottom: max(90px, calc(70px + env(safe-area-inset-bottom, 20px)));
            }
        }
        
        .command-center-button {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(100, 100, 180, 0.9) 0%, rgba(80, 80, 140, 0.95) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: opacity 0.3s, transform 0.3s, background 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(100, 100, 180, 0.3);
        }
        
        .command-center-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .command-center-button:active {
            transform: scale(0.95);
        }
        
        .command-center.open .command-center-button {
            opacity: 1;
            transform: rotate(45deg);
            background: linear-gradient(135deg, rgba(180, 100, 100, 0.9) 0%, rgba(140, 80, 80, 0.95) 100%);
        }
        
        /* Feature icons popup */
        .command-center-popup {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.8);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
        }
        
        .command-center.open .command-center-popup {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .command-center-icon {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .command-center-icon:hover {
            transform: scale(1.15);
        }
        
        .command-center-icon:active {
            transform: scale(0.95);
        }
        
        .command-center-icon.report {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.9) 0%, rgba(200, 80, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(255, 100, 100, 0.4);
        }
        
        .command-center-icon.vacuum {
            background: linear-gradient(135deg, rgba(100, 180, 100, 0.9) 0%, rgba(80, 140, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(100, 180, 100, 0.4);
        }
        
        .command-center-icon.lights {
            background: linear-gradient(135deg, rgba(255, 200, 100, 0.9) 0%, rgba(200, 160, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(255, 200, 100, 0.4);
        }
        
        /* Staggered animation for icons */
        .command-center.open .command-center-icon:nth-child(1) {
            transition-delay: 0.05s;
        }
        .command-center.open .command-center-icon:nth-child(2) {
            transition-delay: 0.1s;
        }
        .command-center.open .command-center-icon:nth-child(3) {
            transition-delay: 0.15s;
        }
        
        /* Command Center backdrop for tap-outside-to-close */
        .command-center-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 55;
            display: none;
        }
        
        .command-center.open + .command-center-backdrop {
            display: block;
        }
        
        /* Legacy: Keep report-button class for backwards compatibility during transition */
        .report-button {
            display: none; /* Hidden - replaced by Command Center */
        }
        
        /* Vacuum Control Panel */
        .vacuum-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .vacuum-panel.show {
            opacity: 1;
            visibility: visible;
        }
        
        .vacuum-panel-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            text-align: center;
        }
        
        .vacuum-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .vacuum-panel-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .vacuum-panel-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .vacuum-panel-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .vacuum-battery {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        
        .vacuum-battery:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .vacuum-battery:active {
            transform: scale(0.98);
        }
        
        .vacuum-battery-icon {
            font-size: 32px;
        }
        
        .vacuum-battery-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .vacuum-battery-loading {
            font-size: 16px;
            opacity: 0.7;
        }
        
        .vacuum-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .vacuum-status-icon {
            font-size: 20px;
        }
        
        .vacuum-status-text {
            font-size: 16px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .vacuum-status.cleaning .vacuum-status-text {
            color: #4ade80;
        }
        
        .vacuum-status.charging .vacuum-status-text {
            color: #60a5fa;
        }
        
        .vacuum-status.idle .vacuum-status-text {
            color: #fbbf24;
        }
        
        .vacuum-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .vacuum-btn {
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 56px;
        }
        
        .vacuum-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .vacuum-btn.loading {
            position: relative;
            pointer-events: none;
        }
        
        .vacuum-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 16px;
            width: 18px;
            height: 18px;
            margin-top: -9px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: vacuum-spin 0.8s linear infinite;
        }
        
        @keyframes vacuum-spin {
            to { transform: rotate(360deg); }
        }
        
        .vacuum-btn.loading .vacuum-btn-icon {
            animation: vacuum-pulse 1s ease-in-out infinite;
        }
        
        @keyframes vacuum-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .vacuum-btn-start {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }
        
        .vacuum-btn-start:hover:not(:disabled) {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        
        .vacuum-btn-stop {
            background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
            color: white;
        }
        
        .vacuum-btn-stop:hover:not(:disabled) {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.4);
        }
        
        .vacuum-btn-home {
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
            color: white;
        }
        
        .vacuum-btn-home:hover:not(:disabled) {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .vacuum-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .vacuum-btn-icon {
            font-size: 20px;
        }
        
        @media (max-width: 480px) {
            .vacuum-panel-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
            }
            
            .vacuum-actions {
                gap: 12px;
            }
            
            .vacuum-btn {
                padding: 14px 20px;
                min-height: 50px;
            }
        }

        /* Lights Control Panel */
        .lights-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .lights-panel.show {
            opacity: 1;
            visibility: visible;
        }
        
        .lights-panel-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            text-align: center;
        }
        
        .lights-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }
        
        .lights-panel-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .lights-panel-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .lights-panel-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .lights-presets {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .lights-preset-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .lights-preset-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .lights-preset-btn:active {
            transform: translateY(0);
        }
        
        .lights-preset-btn.bedtime {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 4px 20px rgba(147, 51, 234, 0.2);
        }
        
        .lights-preset-btn.bedtime:hover {
            border-color: rgba(147, 51, 234, 0.7);
            box-shadow: 0 6px 25px rgba(147, 51, 234, 0.3);
        }
        
        .lights-preset-btn.daytime {
            border-color: rgba(245, 158, 11, 0.5);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
        }
        
        .lights-preset-btn.daytime:hover {
            border-color: rgba(245, 158, 11, 0.7);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.3);
        }
        
        .lights-preset-btn.movie {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }
        
        .lights-preset-btn.movie:hover {
            border-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.3);
        }
        
        .lights-preset-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .lights-preset-text {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        
        .lights-preset-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            display: block;
        }
        
        @media (max-width: 480px) {
            .lights-panel-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
            }
            
            .lights-preset-btn {
                padding: 16px;
                gap: 12px;
            }
            
            .lights-preset-icon {
                font-size: 28px;
            }
            
            .lights-preset-text {
                font-size: 16px;
            }
        }

        /* Report Modal */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            /* Prevent body scroll when modal is open */
            overflow: hidden;
        }
        
        .report-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .report-modal-content {
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            position: relative;
        }
        
        .report-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .report-modal-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .report-modal-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
        }
        
        .report-modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .report-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .report-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .report-form-label {
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .report-form-select,
        .report-form-textarea {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            color: white;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s, background 0.2s;
        }
        
        .report-form-select:focus,
        .report-form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.12);
        }
        
        .report-form-select {
            cursor: pointer;
        }
        
        .report-checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .report-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .report-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .report-checkbox-label:has(input:checked) {
            background: rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.5);
        }
        
        .report-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
            cursor: pointer;
        }
        
        .report-checkbox-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        @media (max-width: 480px) {
            .report-checkbox-group {
                grid-template-columns: 1fr;
            }
        }
        
        .report-form-textarea {
            resize: vertical;
            min-height: 100px;
            max-height: 200px;
        }
        
        .report-form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .report-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        .report-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .report-btn-cancel {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .report-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .report-btn-submit {
            background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
            color: white;
        }
        
        .report-btn-submit:hover {
            background: linear-gradient(135deg, #ff1744 0%, #d50000 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.4);
        }
        
        .report-btn-submit:active {
            transform: translateY(0);
        }
        
        .report-btn-submit:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .report-feedback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
            padding: 24px;
            border-radius: 20px;
            text-align: center;
            display: none;
            box-sizing: border-box;
            z-index: 10;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .report-feedback.show {
            display: flex;
        }
        
        .report-feedback-icon {
            font-size: 56px;
            margin-bottom: 20px;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .report-feedback-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.3;
            flex-shrink: 0;
        }
        
        .report-feedback-message {
            font-size: 16px;
            opacity: 0.85;
            line-height: 1.5;
            flex-shrink: 0;
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .report-button {
                bottom: 18px;
                right: 18px;
                width: 52px;
                height: 52px;
                font-size: 22px;
            }
            
            .report-modal-content {
                margin: 16px;
                padding: 24px;
                max-width: none;
                width: auto;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }
            
            .report-form-actions {
                flex-direction: column;
            }
            
            .report-btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Feedback overlay on mobile - ensure content fits */
            .report-feedback {
                padding: 20px;
                min-height: 200px;
            }
            
            .report-feedback-icon {
                font-size: 48px;
                margin-bottom: 16px;
            }
            
            .report-feedback-title {
                font-size: 20px;
                margin-bottom: 8px;
            }
            
            .report-feedback-message {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="display-container">
        <div class="image-layer active" id="layer-a">
            <img src="" alt="Alice">
        </div>
        <div class="image-layer inactive" id="layer-b">
            <img src="" alt="Alice">
        </div>
    </div>
    
    <div class="title-overlay" id="title-overlay"></div>
    
    <!-- Weather Widget Overlay -->
    <div class="weather-widget" id="weather-widget">
        <div class="weather-widget-header">
            <span class="weather-widget-icon" id="widget-weather-icon">â˜€ï¸</span>
            <div>
                <div class="weather-widget-temp">
                    <span id="widget-temp">--</span><span class="unit">Â°C</span>
                </div>
            </div>
        </div>
        <div class="weather-widget-condition" id="widget-condition">Loading...</div>
        <div class="weather-widget-description" id="widget-description">--</div>
        <div class="weather-widget-divider"></div>
        <div class="weather-widget-details">
            <div class="weather-widget-detail">
                <div class="weather-widget-detail-value" id="widget-humidity">--%</div>
                <div class="weather-widget-detail-label">Humidity</div>
            </div>
            <div class="weather-widget-detail">
                <div class="weather-widget-detail-value" id="widget-activity">--</div>
                <div class="weather-widget-detail-label">Activity</div>
            </div>
        </div>
        <div class="weather-widget-time">
            <span class="weather-widget-clock" id="widget-clock">--:--</span>
            <span class="weather-widget-period" id="widget-period">--</span>
        </div>
    </div>
    
    <!-- Standalone clock for mobile portrait â€” fills the top-right dead space -->
    <div class="portrait-clock" id="portrait-clock">
        <span class="portrait-clock-time" id="portrait-clock-time">--:--</span>
        <span class="portrait-clock-period" id="portrait-clock-period">--</span>
    </div>
    
    <div class="status-overlay" id="status-overlay">
        <div class="status-item">
            <span class="icon" id="weather-icon">â˜€ï¸</span>
            <div>
                <div class="value" id="weather-condition">Loading...</div>
                <div class="label" id="temperature">--Â°C</div>
            </div>
        </div>
        <div class="status-item">
            <span class="icon">ğŸ•</span>
            <div>
                <div class="value" id="time-period">--</div>
                <div class="label" id="current-time">--:--</div>
            </div>
        </div>
        <div class="status-item" id="activity-item">
            <span class="icon">ğŸ¨</span>
            <div>
                <div class="value" id="activity">--</div>
            </div>
        </div>
        <div class="copy-toast" id="copy-toast">ğŸ“‹ Copied!</div>
    </div>
    
    <div class="countdown" id="countdown"></div>
    
    <div class="update-indicator" id="update-indicator">âœ¨ Updated!</div>
    
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner"></div>
    </div>
    
    <div class="error-message" id="error-message">
        <div class="error-icon">ğŸ¦œ</div>
        <div class="error-title" id="error-title">Connection Issue</div>
        <div class="error-detail" id="error-detail">Unable to load display data</div>
        <div class="error-retry-counter" id="error-retry-counter">Retry 0/10</div>
        <div class="error-retry">Retrying in <span class="countdown" id="error-countdown">10</span>s</div>
    </div>
    
    <div class="connection-status" id="connection-status">
        <div class="connection-dot"></div>
        <span id="connection-text">Connected</span>
    </div>
    
    <div class="fallback-badge" id="fallback-badge">âš ï¸ Showing cached image</div>
    
    <div class="debug-panel" id="debug-panel">
        <pre id="debug-content"></pre>
    </div>
    
    <button class="fullscreen-btn" id="fullscreen-btn" title="Toggle Fullscreen">â›¶</button>
    
    <!-- PWA Install Banner -->
    <div class="install-banner" id="install-banner">
        <div class="install-banner-content">
            <div class="install-banner-icon">ğŸ¦œ</div>
            <div class="install-banner-text">
                <div class="install-banner-title">Install Alice Display</div>
                <div class="install-banner-subtitle">Add to home screen for fullscreen experience</div>
            </div>
        </div>
        <div class="install-banner-actions">
            <button class="dismiss-btn" id="install-dismiss">Maybe Later</button>
            <button class="install-btn" id="install-btn">Install</button>
        </div>
    </div>
    
    <!-- iOS Install Instructions -->
    <div class="ios-modal" id="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-icon">ğŸ¦œ</div>
            <div class="ios-modal-title">Install Alice Display</div>
            <div class="ios-modal-subtitle">Add to your home screen for the best experience</div>
            
            <div class="ios-modal-steps">
                <div class="ios-modal-step">
                    <span class="ios-step-number">1</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Tap <span class="ios-share-icon">â¬†ï¸ Share</span></div>
                        <div class="ios-step-desc">Find it at the bottom of Safari</div>
                    </div>
                </div>
                <div class="ios-modal-step">
                    <span class="ios-step-number">2</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Add to Home Screen</div>
                        <div class="ios-step-desc">Scroll down in the share menu</div>
                    </div>
                </div>
                <div class="ios-modal-step">
                    <span class="ios-step-number">3</span>
                    <div class="ios-step-content">
                        <div class="ios-step-title">Tap "Add"</div>
                        <div class="ios-step-desc">Confirm in the top right corner</div>
                    </div>
                </div>
            </div>
            
            <div class="ios-modal-buttons">
                <button class="ios-modal-close" id="ios-modal-close">Got it!</button>
                <button class="ios-modal-dismiss" id="ios-modal-dismiss">Don't show again</button>
            </div>
            
            <div class="ios-safari-note">
                <strong>Note:</strong> Must be opened in Safari. Other browsers don't support home screen apps.
            </div>
        </div>
    </div>
    
    <!-- Help Overlay -->
    <div class="help-overlay" id="help-overlay">
        <div class="help-content">
            <div class="help-title">âŒ¨ï¸ Keyboard Shortcuts</div>
            <div class="help-shortcuts">
                <span class="help-key">R</span>
                <span class="help-desc">Refresh display</span>
                
                <span class="help-key">F</span>
                <span class="help-desc">Toggle fullscreen</span>
                
                <span class="help-key">S</span>
                <span class="help-desc">Toggle status overlay</span>
                
                <span class="help-key">Space</span>
                <span class="help-desc">Pause/resume auto-refresh</span>
                
                <span class="help-key">I</span>
                <span class="help-desc">Show image info</span>
                
                <span class="help-key">W</span>
                <span class="help-desc">Toggle status overlay</span>
                
                <span class="help-key">Ctrl+D</span>
                <span class="help-desc">Toggle debug panel</span>
                
                <span class="help-key">H / ?</span>
                <span class="help-desc">Show this help</span>
                
                <span class="help-key">Shift+R</span>
                <span class="help-desc">Report issue with image</span>
                
                <span class="help-key">Esc</span>
                <span class="help-desc">Close panels</span>
            </div>
            <div class="help-close">Press any key to close</div>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Pause indicator -->
    <div class="pause-indicator" id="pause-indicator">
        â¸ï¸ Auto-refresh paused â€” Press Space to resume
    </div>
    
    <!-- Image info panel -->
    <div class="image-info" id="image-info">
        <h3>ğŸ–¼ï¸ Image Info</h3>
        <div class="image-info-row">
            <span class="image-info-label">Title</span>
            <span class="image-info-value" id="info-title">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Weather</span>
            <span class="image-info-value" id="info-weather">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Time</span>
            <span class="image-info-value" id="info-time">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Activity</span>
            <span class="image-info-value" id="info-activity">--</span>
        </div>
        <div class="image-info-row">
            <span class="image-info-label">Updated</span>
            <span class="image-info-value" id="info-updated">--</span>
        </div>
    </div>
    
    <!-- Report Issue Button -->
    <!-- Command Center -->
    <div class="command-center" id="command-center">
        <div class="command-center-popup">
            <button class="command-center-icon lights" id="cmd-lights" title="Lights">ğŸ’¡</button>
            <button class="command-center-icon vacuum" id="cmd-vacuum" title="Vacuum">ğŸ¤–</button>
            <button class="command-center-icon report" id="cmd-report" title="Report Issue">ğŸš©</button>
        </div>
        <button class="command-center-button" id="command-center-button" title="Command Center">âš™ï¸</button>
    </div>
    <div class="command-center-backdrop" id="command-center-backdrop"></div>
    
    <!-- Vacuum Control Panel -->
    <div class="vacuum-panel" id="vacuum-panel">
        <div class="vacuum-panel-content">
            <div class="vacuum-panel-header">
                <h2 class="vacuum-panel-title">ğŸ¤– Yiko Vacuum</h2>
                <button class="vacuum-panel-close" id="vacuum-panel-close" title="Close">âœ•</button>
            </div>
            
            <div class="vacuum-battery" id="vacuum-battery">
                <span class="vacuum-battery-icon" id="vacuum-battery-icon">ğŸ”‹</span>
                <span class="vacuum-battery-text" id="vacuum-battery-text">Loading...</span>
            </div>
            
            <div class="vacuum-status" id="vacuum-status">
                <span class="vacuum-status-icon" id="vacuum-status-icon">ğŸ“</span>
                <span class="vacuum-status-text" id="vacuum-status-text">--</span>
            </div>
            
            <div class="vacuum-actions">
                <button class="vacuum-btn vacuum-btn-start" id="vacuum-btn-start">
                    <span class="vacuum-btn-icon">â–¶ï¸</span>
                    <span>Start Cleaning</span>
                </button>
                <button class="vacuum-btn vacuum-btn-stop" id="vacuum-btn-stop">
                    <span class="vacuum-btn-icon">â¹ï¸</span>
                    <span>Stop</span>
                </button>
                <button class="vacuum-btn vacuum-btn-home" id="vacuum-btn-home">
                    <span class="vacuum-btn-icon">ğŸ </span>
                    <span>Go Home</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Lights Control Panel -->
    <div class="lights-panel" id="lights-panel">
        <div class="lights-panel-content">
            <div class="lights-panel-header">
                <h2 class="lights-panel-title">ğŸ’¡ Lights Control</h2>
                <button class="lights-panel-close" id="lights-panel-close" title="Close">âœ•</button>
            </div>
            
            <div class="lights-presets">
                <button class="lights-preset-btn bedtime" id="lights-bedtime">
                    <span class="lights-preset-icon">ğŸŒ™</span>
                    <span class="lights-preset-text">Bedtime</span>
                    <span class="lights-preset-desc">All lights to 1%</span>
                </button>
                <button class="lights-preset-btn daytime" id="lights-daytime">
                    <span class="lights-preset-icon">â˜€ï¸</span>
                    <span class="lights-preset-text">Daytime</span>
                    <span class="lights-preset-desc">All lights to 100%</span>
                </button>
                <button class="lights-preset-btn movie" id="lights-movie">
                    <span class="lights-preset-icon">ğŸ¬</span>
                    <span class="lights-preset-text">Movie Mode</span>
                    <span class="lights-preset-desc">30% + Blue</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report Issue Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h2 class="report-modal-title">ğŸš© Report Issue</h2>
                <button class="report-modal-close" id="report-modal-close" title="Close">âœ•</button>
            </div>
            
            <form class="report-form" id="report-form">
                <div class="report-form-group">
                    <label class="report-form-label">Issue Type * <span style="font-weight: normal; font-size: 0.85em; opacity: 0.7;">(select all that apply)</span></label>
                    <div class="report-checkbox-group" id="report-category">
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="wrong-content">
                            <span class="report-checkbox-text">Wrong Content</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="poor-quality">
                            <span class="report-checkbox-text">Poor Quality</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="duplicate">
                            <span class="report-checkbox-text">Duplicate</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="inappropriate">
                            <span class="report-checkbox-text">Inappropriate</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="weather-mismatch">
                            <span class="report-checkbox-text">Weather Mismatch</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="time-mismatch">
                            <span class="report-checkbox-text">Time Mismatch</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="technical-issue">
                            <span class="report-checkbox-text">Technical Issue</span>
                        </label>
                        <label class="report-checkbox-label">
                            <input type="checkbox" name="issue-type" value="other">
                            <span class="report-checkbox-text">Other</span>
                        </label>
                    </div>
                </div>
                
                <div class="report-form-group">
                    <label class="report-form-label" for="report-description">Description (optional)</label>
                    <textarea class="report-form-textarea" id="report-description" placeholder="Please describe the issue in more detail..."></textarea>
                </div>
                
                <input type="hidden" id="report-image-id" value="">
                
                <div class="report-form-actions">
                    <button type="submit" class="report-btn report-btn-submit" id="report-submit">Submit Report</button>
                </div>
            </form>
            
            <div class="report-feedback" id="report-feedback">
                <div class="report-feedback-icon" id="report-feedback-icon">âœ…</div>
                <div class="report-feedback-title" id="report-feedback-title">Report Submitted</div>
                <div class="report-feedback-message" id="report-feedback-message">Thank you for your feedback!</div>
            </div>
        </div>
    </div>
    
    <script>
        class AliceDisplay {
            constructor() {
                this.controlFile = 'display-control.json';
                this.pollInterval = 5 * 60 * 1000;  // Poll every 5 minutes
                this.baseRetryInterval = 10 * 1000;  // Base retry interval
                this.maxRetryInterval = 5 * 60 * 1000;  // Max 5 minutes between retries
                this.retryCount = 0;
                this.maxRetries = 10;
                this.lastUpdated = null;
                this.currentData = null;
                this.lastGoodData = null;  // Cache last successful data
                this.activeLayer = 'a';
                this.isDebugMode = new URLSearchParams(window.location.search).has('debug');
                this.isOnline = navigator.onLine;
                this.errorCountdownInterval = null;
                this.usingFallback = false;
                this.isPaused = false;  // For pause/resume functionality
                
                // Fallback image (base64 placeholder or default)
                this.fallbackImageUrl = 'images/generated/morning-sunny.png';
                
                // DOM elements
                this.layerA = document.getElementById('layer-a');
                this.layerB = document.getElementById('layer-b');
                this.titleEl = document.getElementById('title-overlay');
                this.statusEl = document.getElementById('status-overlay');
                this.spinnerEl = document.getElementById('loading-spinner');
                this.errorEl = document.getElementById('error-message');
                this.errorTitleEl = document.getElementById('error-title');
                this.errorDetailEl = document.getElementById('error-detail');
                this.errorCountdownEl = document.getElementById('error-countdown');
                this.debugEl = document.getElementById('debug-panel');
                this.debugContent = document.getElementById('debug-content');
                this.updateIndicator = document.getElementById('update-indicator');
                this.countdownEl = document.getElementById('countdown');
                this.connectionStatusEl = document.getElementById('connection-status');
                this.connectionTextEl = document.getElementById('connection-text');
                this.fallbackBadgeEl = document.getElementById('fallback-badge');
                
                // Weather icons mapping
                this.weatherIcons = {
                    'Sunny': 'â˜€ï¸',
                    'Partly Cloudy': 'â›…',
                    'Cloudy': 'â˜ï¸',
                    'Overcast': 'ğŸŒ¥ï¸',
                    'Rainy': 'ğŸŒ§ï¸',
                    'Stormy': 'â›ˆï¸',
                    'Snowy': 'â„ï¸',
                    'Foggy': 'ğŸŒ«ï¸',
                    'Clear Night': 'ğŸŒ™',
                    'Windy': 'ğŸ’¨'
                };
                
                this.init();
            }
            
            async init() {
                if (this.isDebugMode) {
                    this.debugEl.classList.add('show');
                }
                
                this.setupEventListeners();
                this.setupNetworkListeners();
                this.initializeStatusOverlay();
                this.initializeReportModal();
                this.preventMobileScroll();  // Prevent iOS Safari scroll
                this.spinnerEl.classList.add('active');
                await this.loadDisplay(true);  // Initial load
                this.startPolling();
                
                // Show status bar briefly on load
                this.statusEl.classList.add('visible');
                setTimeout(() => {
                    this.statusEl.classList.remove('visible');
                }, 5000);
            }
            
            preventMobileScroll() {
                // Prevent scroll on iOS Safari except in modal content
                document.addEventListener('touchmove', (e) => {
                    const modal = document.getElementById('report-modal');
                    const modalContent = document.querySelector('.report-modal-content');
                    
                    // Allow scroll only inside the report modal content
                    if (modal.classList.contains('show') && modalContent && modalContent.contains(e.target)) {
                        return; // Allow scrolling in modal
                    }
                    
                    // Prevent scroll everywhere else
                    e.preventDefault();
                }, { passive: false });
            }
            
            initializeStatusOverlay() {
                // Start collapsed on mobile portrait to avoid overlap
                const isMobilePortrait = window.innerWidth <= 480 && window.innerHeight > window.innerWidth;
                if (isMobilePortrait) {
                    const statusOverlay = document.getElementById('status-overlay');
                    const displayContainer = document.querySelector('.display-container');
                    
                    statusOverlay.classList.add('collapsed');
                    displayContainer.classList.add('status-collapsed');
                }
            }
            
            handleOrientationChange() {
                const statusOverlay = document.getElementById('status-overlay');
                const displayContainer = document.querySelector('.display-container');
                const isMobilePortrait = window.innerWidth <= 480 && window.innerHeight > window.innerWidth;
                
                if (isMobilePortrait) {
                    // On mobile portrait, ensure proper collapsed state handling
                    if (!statusOverlay.classList.contains('collapsed')) {
                        statusOverlay.classList.add('collapsed');
                        displayContainer.classList.add('status-collapsed');
                    }
                } else {
                    // On desktop/landscape, remove mobile-specific classes and show expanded
                    statusOverlay.classList.remove('collapsed');
                    displayContainer.classList.remove('status-collapsed');
                }
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showConnectionStatus('Back online', false);
                    this.retryCount = 0;  // Reset retry count
                    this.loadDisplay(true);  // Immediately try to load
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showConnectionStatus('Offline', true);
                    this.showFallbackImage();
                });
            }
            
            showConnectionStatus(text, isError) {
                this.connectionTextEl.textContent = text;
                this.connectionStatusEl.classList.toggle('error', isError);
                this.connectionStatusEl.classList.add('visible');
                
                // Auto-hide success messages
                if (!isError) {
                    setTimeout(() => {
                        this.connectionStatusEl.classList.remove('visible');
                    }, 3000);
                }
            }
            
            showFallbackImage() {
                if (this.lastGoodData) {
                    // Show last known good image
                    this.updateDisplay(this.lastGoodData, true);
                    this.usingFallback = true;
                    this.fallbackBadgeEl.classList.add('show');
                    document.body.classList.add('fallback-active');
                } else if (this.fallbackImageUrl) {
                    // Show default fallback
                    this.crossfadeImage(this.fallbackImageUrl, 'Alice (Fallback)', true);
                    this.usingFallback = true;
                    this.fallbackBadgeEl.classList.add('show');
                    document.body.classList.add('fallback-active');
                }
            }
            
            clearFallbackState() {
                this.usingFallback = false;
                this.fallbackBadgeEl.classList.remove('show');
                document.body.classList.remove('fallback-active');
                this.connectionStatusEl.classList.remove('visible');
            }
            
            setupEventListeners() {
                // Fullscreen button
                document.getElementById('fullscreen-btn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                // Status overlay click to toggle
                document.getElementById('status-overlay').addEventListener('click', () => {
                    this.toggleStatusOverlay();
                });
                
                // Weather widget click to toggle visibility
                document.getElementById('weather-widget').addEventListener('click', () => {
                    this.toggleWeatherWidget();
                });
                
                // Show status on mouse move / touch
                let hideTimeout;
                const showOverlays = () => {
                    this.statusEl.classList.add('visible');
                    this.titleEl.classList.add('visible');
                    this.countdownEl.classList.add('visible');
                    clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        this.statusEl.classList.remove('visible');
                        this.titleEl.classList.remove('visible');
                        this.countdownEl.classList.remove('visible');
                    }, 4000);
                };
                document.addEventListener('mousemove', showOverlays);
                document.addEventListener('touchstart', showOverlays);
                
                // Tap-to-copy: tapping the activity area copies the current image's
                // Cloudinary URL to the clipboard. Shows a brief green toast confirmation.
                document.getElementById('activity-item').addEventListener('click', (e) => {
                    e.stopPropagation();  // Don't trigger the show/hide overlays
                    
                    // Get the current image URL from the last loaded data
                    const url = this.currentData?.currentImage?.url;
                    if (!url) {
                        this.showCopyToast('âš ï¸ No image URL');
                        return;
                    }
                    
                    // Copy to clipboard using the modern API with fallback
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(() => {
                            this.showCopyToast('ğŸ“‹ Link copied!');
                        }).catch(() => {
                            this.fallbackCopy(url);
                        });
                    } else {
                        this.fallbackCopy(url);
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ignore if typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'd':
                            if (e.ctrlKey) {
                                e.preventDefault();
                                this.debugEl.classList.toggle('show');
                            }
                            break;
                        case 'r':
                            if (e.shiftKey) {
                                // Shift+R for report modal
                                e.preventDefault();
                                this.showReportModal();
                            } else if (!e.ctrlKey) {
                                // R for refresh
                                e.preventDefault();
                                this.loadDisplay(true);
                                this.showToast('ğŸ”„ Refreshing...');
                            }
                            break;
                        case 'f':
                            e.preventDefault();
                            this.toggleFullscreen();
                            break;
                        case 's':
                            e.preventDefault();
                            this.statusEl.classList.toggle('visible');
                            this.titleEl.classList.toggle('visible');
                            break;
                        case 'w':
                            e.preventDefault();
                            this.toggleStatusOverlay();
                            break;
                        case ' ':
                            e.preventDefault();
                            this.togglePause();
                            break;
                        case 'h':
                        case '?':
                            e.preventDefault();
                            this.toggleHelp();
                            break;
                        case 'i':
                            e.preventDefault();
                            this.showImageInfo();
                            break;
                        case 'escape':
                            this.closeAllPanels();
                            break;
                        case 'c':
                            // Copy current image URL to clipboard
                            if (!e.ctrlKey && !e.metaKey) {
                                e.preventDefault();
                                const copyUrl = this.currentData?.currentImage?.url;
                                if (copyUrl) {
                                    navigator.clipboard?.writeText(copyUrl).then(() => {
                                        this.showCopyToast('ğŸ“‹ Link copied!');
                                    }).catch(() => this.fallbackCopy(copyUrl));
                                }
                            }
                            break;
                        case 'arrowleft':
                            e.preventDefault();
                            this.showToast('â®ï¸ Previous (not implemented)');
                            break;
                        case 'arrowright':
                            e.preventDefault();
                            this.showToast('â­ï¸ Next (not implemented)');
                            break;
                    }
                });
                
                // Check for updates when page becomes visible again
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.loadDisplay();
                    }
                });
                
                // Handle orientation changes for weather widget positioning
                window.addEventListener('orientationchange', () => {
                    // Delay to allow orientation change to complete
                    setTimeout(() => {
                        this.handleOrientationChange();
                    }, 100);
                });
                
                // Also handle window resize for responsive behavior
                window.addEventListener('resize', () => {
                    this.handleOrientationChange();
                });
            }
            
            async loadDisplay(forceUpdate = false) {
                // Check if offline
                if (!navigator.onLine) {
                    this.handleError('offline', 'You appear to be offline');
                    return;
                }
                
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 15000);  // 15s timeout
                    
                    const response = await fetch(`${this.controlFile}?t=${Date.now()}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeout);
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Validate data structure
                    if (!data || !data.currentImage) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Success! Reset error state
                    this.retryCount = 0;
                    this.clearError();
                    this.clearFallbackState();
                    
                    // Check if data has changed
                    const newLastUpdated = data.lastUpdated;
                    const hasChanged = forceUpdate || (newLastUpdated !== this.lastUpdated);
                    
                    if (hasChanged && newLastUpdated) {
                        console.log('ğŸ¦œ Update detected:', newLastUpdated);
                        this.lastUpdated = newLastUpdated;
                        this.currentData = data;
                        this.lastGoodData = data;  // Cache for fallback
                        await this.updateDisplay(data, !forceUpdate);
                        this.updateDebug(data);
                        this.updateWeatherWidget();
                        this.startWidgetClock();
                        
                        // Show update indicator (not on initial load)
                        if (!forceUpdate && this.lastUpdated) {
                            this.showUpdateIndicator();
                        }
                    } else {
                        this.updateDebug({ ...data, _status: 'No changes detected' });
                    }
                    
                } catch (error) {
                    console.error('Error loading display:', error);
                    
                    // Categorize the error
                    let errorType = 'unknown';
                    let errorMessage = error.message;
                    
                    if (error.name === 'AbortError') {
                        errorType = 'timeout';
                        errorMessage = 'Request timed out';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorType = 'network';
                        errorMessage = 'Network connection failed';
                    } else if (error.message.includes('Server returned')) {
                        errorType = 'server';
                    } else if (error.message.includes('Invalid data')) {
                        errorType = 'data';
                        errorMessage = 'Received invalid data';
                    }
                    
                    this.handleError(errorType, errorMessage);
                }
            }
            
            handleError(type, message) {
                // Cap the retry counter at maxRetries to prevent runaway display
                if (this.retryCount <= this.maxRetries) {
                    this.retryCount++;
                }
                this.updateDebug({ error: message, type, retryCount: Math.min(this.retryCount, this.maxRetries) });
                
                // Calculate retry interval with exponential backoff
                const retryInterval = Math.min(
                    this.baseRetryInterval * Math.pow(1.5, this.retryCount - 1),
                    this.maxRetryInterval
                );
                
                // Set error message based on type
                const errorMessages = {
                    offline: { title: 'You\'re Offline', icon: 'ğŸ“¡' },
                    timeout: { title: 'Connection Slow', icon: 'â±ï¸' },
                    network: { title: 'Connection Failed', icon: 'ğŸ”Œ' },
                    server: { title: 'Server Issue', icon: 'ğŸ–¥ï¸' },
                    data: { title: 'Data Error', icon: 'âš ï¸' },
                    image: { title: 'Image Load Failed', icon: 'ğŸ–¼ï¸' },
                    unknown: { title: 'Something Went Wrong', icon: 'ğŸ¦œ' }
                };
                
                const errorInfo = errorMessages[type] || errorMessages.unknown;
                
                // Show fallback if we have one and this isn't the first load
                if (this.lastGoodData || this.currentData) {
                    this.showFallbackImage();
                }
                
                // Show error UI
                this.showError(errorInfo.title, message, retryInterval);
                
                // Schedule retry (unless we've exceeded max retries)
                if (this.retryCount <= this.maxRetries) {
                    setTimeout(() => this.loadDisplay(), retryInterval);
                } else {
                    this.errorDetailEl.textContent = 'Max retries exceeded. Tap to retry.';
                    this.errorEl.onclick = () => {
                        this.retryCount = 0;
                        this.loadDisplay(true);
                    };
                }
            }
            
            showError(title = 'Connection Issue', detail = 'Unable to load display', retryIn = 10000) {
                this.spinnerEl.classList.remove('active');
                this.errorTitleEl.textContent = title;
                this.errorDetailEl.textContent = detail;
                this.errorEl.classList.add('show');
                
                // Update retry counter inside modal (capped at maxRetries)
                const retryCounterEl = document.getElementById('error-retry-counter');
                if (retryCounterEl) {
                    const displayCount = Math.min(this.retryCount, this.maxRetries);
                    retryCounterEl.textContent = `Retry ${displayCount}/${this.maxRetries}`;
                }
                
                // Hide connection status when error modal is shown
                this.connectionStatusEl.classList.remove('show');
                
                // Update countdown
                if (this.errorCountdownInterval) {
                    clearInterval(this.errorCountdownInterval);
                }
                
                let remaining = Math.ceil(retryIn / 1000);
                this.errorCountdownEl.textContent = remaining;
                
                this.errorCountdownInterval = setInterval(() => {
                    remaining--;
                    if (remaining > 0) {
                        this.errorCountdownEl.textContent = remaining;
                    } else {
                        clearInterval(this.errorCountdownInterval);
                    }
                }, 1000);
            }
            
            clearError() {
                this.errorEl.classList.remove('show');
                this.errorEl.onclick = null;
                if (this.errorCountdownInterval) {
                    clearInterval(this.errorCountdownInterval);
                }
            }
            
            async updateDisplay(data, animate = true) {
                const { currentImage, weather, time } = data;
                
                // Update image with crossfade
                if (currentImage && currentImage.url) {
                    await this.crossfadeImage(currentImage.url, currentImage.title, animate);
                }
                
                // Update title
                if (currentImage && currentImage.title) {
                    this.titleEl.textContent = currentImage.title;
                }
                
                // Update weather
                if (weather) {
                    document.getElementById('weather-icon').textContent = 
                        this.weatherIcons[weather.condition] || 'ğŸŒ¡ï¸';
                    document.getElementById('weather-condition').textContent = 
                        weather.condition || 'Unknown';
                    document.getElementById('temperature').textContent = 
                        weather.temperature ? `${Math.round(weather.temperature)}Â°C` : '';
                }
                
                // Update time
                if (time) {
                    document.getElementById('time-period').textContent = 
                        time.period || 'Unknown';
                    const now = new Date();
                    document.getElementById('current-time').textContent = 
                        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                // Update activity
                if (currentImage && currentImage.activity) {
                    document.getElementById('activity').textContent = currentImage.activity;
                }
                
                this.spinnerEl.classList.remove('active');
            }
            
            crossfadeImage(url, title, animate = true) {
                return new Promise((resolve) => {
                    // Determine which layer to load into
                    const nextLayer = this.activeLayer === 'a' ? 'b' : 'a';
                    const nextLayerEl = nextLayer === 'a' ? this.layerA : this.layerB;
                    const currentLayerEl = this.activeLayer === 'a' ? this.layerA : this.layerB;
                    const nextImg = nextLayerEl.querySelector('img');
                    
                    // Preload the image with timeout
                    const preloader = new Image();
                    const loadTimeout = setTimeout(() => {
                        console.warn('Image load timeout:', url);
                        this.handleImageError(url, 'timeout');
                        resolve();
                    }, 30000);  // 30s timeout for image load
                    
                    preloader.onload = () => {
                        clearTimeout(loadTimeout);
                        nextImg.src = url;
                        nextImg.alt = title || 'Alice';
                        
                        // Apply random Ken Burns effect
                        const kbVariants = ['kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4'];
                        const randomKB = kbVariants[Math.floor(Math.random() * kbVariants.length)];
                        
                        // Remove old Ken Burns classes and add new one
                        nextImg.classList.remove('kenburns', 'kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4');
                        nextImg.classList.add('kenburns', randomKB);
                        
                        // Also remove from the old layer's image to reset it
                        const currentImg = currentLayerEl.querySelector('img');
                        currentImg.classList.remove('kenburns', 'kenburns-1', 'kenburns-2', 'kenburns-3', 'kenburns-4');
                        
                        // Crossfade: show new layer, hide old
                        nextLayerEl.classList.remove('inactive');
                        nextLayerEl.classList.add('active');
                        currentLayerEl.classList.remove('active');
                        currentLayerEl.classList.add('inactive');
                        
                        this.activeLayer = nextLayer;
                        this.spinnerEl.classList.remove('active');
                        resolve();
                    };
                    
                    preloader.onerror = () => {
                        clearTimeout(loadTimeout);
                        console.error('Failed to load image:', url);
                        this.handleImageError(url, 'load');
                        resolve();
                    };
                    
                    preloader.src = url;
                });
            }
            
            handleImageError(url, reason) {
                console.warn(`Image error (${reason}):`, url);
                
                // Try fallback image if main image fails
                if (!this.usingFallback && url !== this.fallbackImageUrl) {
                    console.log('Attempting fallback image...');
                    this.usingFallback = true;
                    this.fallbackBadgeEl.textContent = 'âš ï¸ Image unavailable';
                    this.fallbackBadgeEl.classList.add('show');
                    
                    // Try fallback
                    if (this.lastGoodData && this.lastGoodData.currentImage) {
                        this.crossfadeImage(
                            this.lastGoodData.currentImage.url,
                            this.lastGoodData.currentImage.title + ' (cached)',
                            true
                        );
                    } else {
                        this.crossfadeImage(this.fallbackImageUrl, 'Alice (Fallback)', true);
                    }
                } else {
                    // Even fallback failed - show error state
                    this.handleError('image', 'Unable to load images');
                }
            }
            
            showUpdateIndicator() {
                this.updateIndicator.classList.add('show');
                setTimeout(() => {
                    this.updateIndicator.classList.remove('show');
                }, 3000);
            }
            
            updateDebug(data) {
                if (!this.isDebugMode) return;
                const debugInfo = {
                    ...data,
                    _pollInterval: `${this.pollInterval / 1000}s`,
                    _lastChecked: new Date().toISOString()
                };
                this.debugContent.textContent = JSON.stringify(debugInfo, null, 2);
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Fullscreen error:', err);
                    });
                    this.showToast('ğŸ–¥ï¸ Fullscreen');
                } else {
                    document.exitFullscreen();
                    this.showToast('ğŸªŸ Windowed');
                }
            }
            
            /**
             * Show the green "Link copied!" toast above the status bar.
             * Auto-hides after 1.5 seconds.
             */
            showCopyToast(message) {
                const toast = document.getElementById('copy-toast');
                toast.textContent = message;
                toast.classList.add('show');
                clearTimeout(this._copyToastTimer);
                this._copyToastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                }, 1500);
            }
            
            /**
             * Fallback for copying text on older browsers / non-HTTPS contexts.
             * Creates a temporary textarea, selects the text, and uses execCommand.
             */
            fallbackCopy(text) {
                // Use a hidden textarea to copy text to clipboard.
                // We set readOnly and move the textarea offscreen to prevent
                // the iOS keyboard from appearing when we call select().
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');  // Prevent keyboard on iOS
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';  // Move offscreen
                textarea.style.top = '-9999px';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showCopyToast('ğŸ“‹ Link copied!');
                } catch (err) {
                    this.showCopyToast('âš ï¸ Copy failed');
                }
                document.body.removeChild(textarea);
            }
            
            togglePause() {
                this.isPaused = !this.isPaused;
                const pauseIndicator = document.getElementById('pause-indicator');
                if (this.isPaused) {
                    pauseIndicator.classList.add('show');
                    this.showToast('â¸ï¸ Paused');
                } else {
                    pauseIndicator.classList.remove('show');
                    this.showToast('â–¶ï¸ Resumed');
                    this.loadDisplay();  // Refresh immediately when unpausing
                }
            }
            
            toggleHelp() {
                const helpOverlay = document.getElementById('help-overlay');
                helpOverlay.classList.toggle('show');
            }
            
            toggleStatusOverlay() {
                const statusOverlay = document.getElementById('status-overlay');
                const displayContainer = document.querySelector('.display-container');
                
                // Toggle between expanded and collapsed states
                statusOverlay.classList.toggle('collapsed');
                
                // Update display container class for image spacing
                displayContainer.classList.toggle('status-collapsed', statusOverlay.classList.contains('collapsed'));
                
                if (statusOverlay.classList.contains('collapsed')) {
                    this.showToast('ğŸ“ Status minimized');
                } else {
                    this.showToast('ğŸ“ Status expanded');
                }
            }
            
            toggleWeatherWidget() {
                const weatherWidget = document.getElementById('weather-widget');
                const displayContainer = document.querySelector('.display-container');
                
                // Toggle visibility
                weatherWidget.classList.toggle('hidden');
                
                // Update display container class for image spacing
                displayContainer.classList.toggle('widget-hidden', weatherWidget.classList.contains('hidden'));
                
                if (weatherWidget.classList.contains('hidden')) {
                    this.showToast('ğŸŒ¤ï¸ Tap icon to expand');
                } else {
                    this.showToast('ğŸŒ¤ï¸ Tap to collapse');
                }
            }
            
            updateWeatherWidget() {
                if (!this.currentData) return;
                
                const data = this.currentData;
                document.getElementById('widget-weather-icon').textContent = 
                    this.weatherIcons[data.weather?.condition] || 'ğŸŒ¡ï¸';
                document.getElementById('widget-temp').textContent = 
                    data.weather?.temperature ?? '--';
                document.getElementById('widget-condition').textContent = 
                    data.weather?.condition || 'Unknown';
                document.getElementById('widget-description').textContent = 
                    data.weather?.description || '';
                document.getElementById('widget-humidity').textContent = 
                    (data.weather?.humidity ?? '--') + '%';
                const periodText = data.time?.period || '--';
                document.getElementById('widget-period').textContent = periodText;
                // Also update the portrait standalone clock period
                const portraitPeriod = document.getElementById('portrait-clock-period');
                if (portraitPeriod) portraitPeriod.textContent = periodText;
                
                document.getElementById('widget-activity').textContent = 
                    data.currentImage?.activity || data.activity || '--';
            }
            
            startWidgetClock() {
                // Update both the widget clock and the portrait standalone clock
                const updateClock = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Hebron'
                    });
                    // Update the in-widget clock (visible on desktop/landscape)
                    document.getElementById('widget-clock').textContent = timeStr;
                    // Update the portrait standalone clock (visible on mobile portrait)
                    const portraitClock = document.getElementById('portrait-clock-time');
                    if (portraitClock) portraitClock.textContent = timeStr;
                };
                updateClock();
                
                // Only set interval if not already running
                if (!this.clockInterval) {
                    this.clockInterval = setInterval(updateClock, 1000);
                }
            }
            
            showImageInfo() {
                const infoPanel = document.getElementById('image-info');
                if (this.currentData) {
                    document.getElementById('info-title').textContent = this.currentData.title || '--';
                    document.getElementById('info-weather').textContent = this.currentData.weather || '--';
                    document.getElementById('info-time').textContent = this.currentData.time || '--';
                    document.getElementById('info-activity').textContent = this.currentData.activity || '--';
                    document.getElementById('info-updated').textContent = this.currentData.updated || '--';
                }
                infoPanel.classList.toggle('show');
            }
            
            initializeCommandCenter() {
                const commandCenter = document.getElementById('command-center');
                const commandButton = document.getElementById('command-center-button');
                const backdrop = document.getElementById('command-center-backdrop');
                const cmdReport = document.getElementById('cmd-report');
                const cmdVacuum = document.getElementById('cmd-vacuum');
                const cmdLights = document.getElementById('cmd-lights');
                
                // Toggle Command Center popup
                commandButton.addEventListener('click', () => {
                    commandCenter.classList.toggle('open');
                });
                
                // Close on backdrop tap
                backdrop.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                });
                
                // Report button â†’ show report modal
                cmdReport.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showReportModal();
                });
                
                // Vacuum button â†’ show vacuum panel
                cmdVacuum.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showVacuumPanel();
                });
                
                // Lights button â†’ show lights panel
                cmdLights.addEventListener('click', () => {
                    commandCenter.classList.remove('open');
                    this.showLightsPanel();
                });
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && commandCenter.classList.contains('open')) {
                        commandCenter.classList.remove('open');
                    }
                });
            }
            
            initializeReportModal() {
                const reportModal = document.getElementById('report-modal');
                const reportClose = document.getElementById('report-modal-close');
                const reportForm = document.getElementById('report-form');
                
                // Initialize Command Center (which includes report button)
                this.initializeCommandCenter();
                
                // Initialize Vacuum Panel
                this.initializeVacuumPanel();
                
                // Initialize Lights Panel
                this.initializeLightsPanel();
                
                // Close modal when close button clicked
                reportClose.addEventListener('click', () => {
                    this.hideReportModal();
                });
                
                // Close modal when clicking outside
                reportModal.addEventListener('click', (e) => {
                    if (e.target === reportModal) {
                        this.hideReportModal();
                    }
                });
                
                // Handle form submission
                reportForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitReport();
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && reportModal.classList.contains('show')) {
                        this.hideReportModal();
                    }
                });
            }
            
            showReportModal() {
                const modal = document.getElementById('report-modal');
                const form = document.getElementById('report-form');
                const feedback = document.getElementById('report-feedback');
                
                // Reset form
                form.reset();
                form.style.display = 'flex';
                feedback.style.display = 'none';
                
                // Populate current image info if available
                if (this.currentData && this.currentData.currentImage) {
                    document.getElementById('report-image-id').value = this.currentData.currentImage.notion_id || '';
                }
                
                // Lock body scroll when modal is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                modal.classList.add('show');
                
                // Focus on category select
                setTimeout(() => {
                    document.getElementById('report-category').focus();
                }, 100);
            }
            
            hideReportModal() {
                const modal = document.getElementById('report-modal');
                modal.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async submitReport() {
                const submitButton = document.getElementById('report-submit');
                const checkboxes = document.querySelectorAll('input[name="issue-type"]:checked');
                const selectedCategories = Array.from(checkboxes).map(cb => cb.value);
                const description = document.getElementById('report-description').value;
                const imageId = document.getElementById('report-image-id').value;
                
                if (selectedCategories.length === 0) {
                    this.showToast('âš ï¸ Please select at least one issue type');
                    return;
                }
                
                // Disable submit button
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                try {
                    // Gather context data for the report
                    const reportData = {
                        image_data: {
                            notion_id: imageId,
                            title: this.currentData?.currentImage?.title || '',
                            url: this.currentData?.currentImage?.url || '',
                            style: this.currentData?.currentImage?.style || '',
                            row_number: this.currentData?.currentImage?.row_number || 0
                        },
                        categories: selectedCategories,
                        notes: description,
                        context_data: {
                            time_of_day: this.currentData?.time?.period || '',
                            weather_shown: this.currentData?.weather?.condition || '',
                            actual_weather: this.currentData?.weather?.condition || '',
                            weather_mismatch: false, // Would need more logic to detect this
                            hebrew_date: '', // Would need Hebrew calendar integration
                            sunrise: '',
                            sunset: '',
                            holiday: null,
                            user_agent: navigator.userAgent,
                            screen_resolution: `${screen.width}x${screen.height}`,
                            platform: navigator.platform
                        }
                    };
                    
                    // Try to submit to server endpoint
                    let success = await this.submitReportToServer(reportData);
                    
                    // Fallback to localStorage if server fails
                    if (!success) {
                        success = this.submitReportToLocalStorage(reportData);
                    }
                    
                    this.showReportFeedback(success);
                    
                } catch (error) {
                    console.error('Error submitting report:', error);
                    // Fallback to localStorage
                    const success = this.submitReportToLocalStorage({
                        category,
                        description,
                        imageId,
                        timestamp: new Date().toISOString(),
                        imageTitle: this.currentData?.currentImage?.title || ''
                    });
                    this.showReportFeedback(success);
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Report';
                }
            }
            
            async submitReportToServer(reportData) {
                // Production API endpoint for image reports (deployed on Vercel)
                const API_ENDPOINT = 'https://alice-report-api.vercel.app/api/report';
                
                try {
                    console.log('Submitting report to API:', API_ENDPOINT);
                    console.log('Report data:', reportData);
                    
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(reportData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Report submitted to server successfully:', result);
                        return true;
                    } else {
                        console.warn('Server report submission failed:', response.status);
                        const errorText = await response.text();
                        console.warn('Error details:', errorText);
                        return false;
                    }
                } catch (error) {
                    console.warn('Network error submitting report:', error);
                    return false;
                }
            }
            
            submitReportToLocalStorage(reportData) {
                try {
                    const reportId = 'RPT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    const report = {
                        id: reportId,
                        ...reportData,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Get existing reports
                    const existingReports = JSON.parse(localStorage.getItem('aliceDisplayReports') || '[]');
                    existingReports.push(report);
                    
                    // Keep only last 50 reports to avoid storage bloat
                    if (existingReports.length > 50) {
                        existingReports.splice(0, existingReports.length - 50);
                    }
                    
                    localStorage.setItem('aliceDisplayReports', JSON.stringify(existingReports));
                    console.log('Report saved to localStorage:', reportId);
                    return true;
                } catch (error) {
                    console.error('Error saving report to localStorage:', error);
                    return false;
                }
            }
            
            showReportFeedback(success) {
                const form = document.getElementById('report-form');
                const feedback = document.getElementById('report-feedback');
                const icon = document.getElementById('report-feedback-icon');
                const title = document.getElementById('report-feedback-title');
                const message = document.getElementById('report-feedback-message');
                
                form.style.display = 'none';
                feedback.style.display = 'block';
                
                if (success) {
                    icon.textContent = 'âœ…';
                    title.textContent = 'Report Submitted';
                    message.textContent = 'Thank you for your feedback! We\'ll review this issue.';
                } else {
                    icon.textContent = 'âŒ';
                    title.textContent = 'Submission Failed';
                    message.textContent = 'Unable to submit report. Please try again later.';
                }
                
                // Auto-close modal after 3 seconds
                setTimeout(() => {
                    this.hideReportModal();
                }, 3000);
            }
            
            initializeVacuumPanel() {
                const vacuumPanel = document.getElementById('vacuum-panel');
                const vacuumClose = document.getElementById('vacuum-panel-close');
                const vacuumBtnStart = document.getElementById('vacuum-btn-start');
                const vacuumBtnStop = document.getElementById('vacuum-btn-stop');
                const vacuumBtnHome = document.getElementById('vacuum-btn-home');
                
                // Close panel when close button clicked
                vacuumClose.addEventListener('click', () => {
                    this.hideVacuumPanel();
                });
                
                // Close panel when clicking outside
                vacuumPanel.addEventListener('click', (e) => {
                    if (e.target === vacuumPanel) {
                        this.hideVacuumPanel();
                    }
                });
                
                // Vacuum control buttons
                vacuumBtnStart.addEventListener('click', () => this.vacuumStart());
                vacuumBtnStop.addEventListener('click', () => this.vacuumStop());
                vacuumBtnHome.addEventListener('click', () => this.vacuumGoHome());
                
                // Tap battery display to refresh
                const vacuumBattery = document.getElementById('vacuum-battery');
                vacuumBattery.style.cursor = 'pointer';
                vacuumBattery.addEventListener('click', () => {
                    this.showToast('ğŸ”„ Refreshing battery...');
                    this.loadVacuumStatus();
                });
                
                // Close panel with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && vacuumPanel.classList.contains('show')) {
                        this.hideVacuumPanel();
                    }
                });
            }
            
            async showVacuumPanel() {
                const panel = document.getElementById('vacuum-panel');
                
                // Lock body scroll when panel is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                panel.classList.add('show');
                
                // Load battery status when panel opens
                await this.loadVacuumStatus();
            }
            
            hideVacuumPanel() {
                const panel = document.getElementById('vacuum-panel');
                panel.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async loadVacuumStatus() {
                const batteryIcon = document.getElementById('vacuum-battery-icon');
                const batteryText = document.getElementById('vacuum-battery-text');
                
                // Show loading state
                batteryIcon.textContent = 'â³';
                batteryText.textContent = 'Loading...';
                
                try {
                    // First, try the local API server
                    const apiUrl = window.location.protocol === 'file:' ? 'http://localhost:3001' : '';
                    const response = await fetch(`${apiUrl}/api/vacuum/status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device: 1 }),
                        signal: AbortSignal.timeout(5000)  // 5 second timeout
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateVacuumBattery(data.battery, data.charging);
                        this.updateVacuumStatus(data.clean_status, data.charging);
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.warn('API server not available, trying direct execution:', error.message);
                    
                    // Fallback: Try executing the command directly via browser (if possible)
                    // This won't work in a browser context, so we'll show a helpful message
                    batteryIcon.textContent = 'ğŸ¤–';
                    batteryText.textContent = 'Yiko Ready';
                    this.updateVacuumStatus('unknown', false);
                    
                    // Show a note about starting the API server
                    this.showToast('ğŸ’¡ Tip: Start vacuum API server for full functionality');
                }
            }
            
            updateVacuumBattery(batteryLevel, isCharging = false) {
                const batteryIcon = document.getElementById('vacuum-battery-icon');
                const batteryText = document.getElementById('vacuum-battery-text');
                
                // Determine battery icon based on level and charging state
                if (isCharging) {
                    batteryIcon.textContent = 'ğŸ”Œ';
                    batteryText.textContent = `${batteryLevel}% (Charging)`;
                } else if (batteryLevel >= 80) {
                    batteryIcon.textContent = 'ğŸ”‹';
                    batteryText.textContent = `${batteryLevel}% (Full)`;
                } else if (batteryLevel >= 50) {
                    batteryIcon.textContent = 'ğŸ”‹';
                    batteryText.textContent = `${batteryLevel}% (Good)`;
                } else if (batteryLevel >= 20) {
                    batteryIcon.textContent = 'ğŸª«';
                    batteryText.textContent = `${batteryLevel}% (Low)`;
                } else {
                    batteryIcon.textContent = 'ğŸª«';
                    batteryText.textContent = `${batteryLevel}% (Very Low)`;
                }
            }
            
            updateVacuumStatus(cleanStatus, isCharging = false) {
                const statusDiv = document.getElementById('vacuum-status');
                const statusIcon = document.getElementById('vacuum-status-icon');
                const statusText = document.getElementById('vacuum-status-text');
                
                // Remove previous status classes
                statusDiv.classList.remove('cleaning', 'charging', 'idle');
                
                // Determine status display
                if (isCharging) {
                    statusIcon.textContent = 'ğŸ”Œ';
                    statusText.textContent = 'Charging';
                    statusDiv.classList.add('charging');
                } else if (cleanStatus === 'cleaning' || cleanStatus === 'working') {
                    statusIcon.textContent = 'ğŸ§¹';
                    statusText.textContent = 'Cleaning';
                    statusDiv.classList.add('cleaning');
                } else if (cleanStatus === 'idle' || cleanStatus === 'stop') {
                    statusIcon.textContent = 'ğŸ’¤';
                    statusText.textContent = 'Idle';
                    statusDiv.classList.add('idle');
                } else if (cleanStatus === 'paused') {
                    statusIcon.textContent = 'â¸ï¸';
                    statusText.textContent = 'Paused';
                    statusDiv.classList.add('idle');
                } else if (cleanStatus === 'returning') {
                    statusIcon.textContent = 'ğŸ ';
                    statusText.textContent = 'Returning Home';
                    statusDiv.classList.add('charging');
                } else if (cleanStatus === 'unknown') {
                    statusIcon.textContent = 'â“';
                    statusText.textContent = 'Unknown';
                } else {
                    statusIcon.textContent = 'ğŸ“';
                    statusText.textContent = cleanStatus || 'Unknown';
                }
            }
            
            async vacuumStart() {
                await this.executeVacuumCommand('clean', 'Starting vacuum...', 'âœ… Vacuum started!');
            }
            
            async vacuumStop() {
                await this.executeVacuumCommand('stop', 'Stopping vacuum...', 'â¹ï¸ Vacuum stopped');
            }
            
            async vacuumGoHome() {
                await this.executeVacuumCommand('charge', 'Sending home...', 'ğŸ  Going home');
            }
            
            async executeVacuumCommand(command, loadingMessage, successMessage) {
                const buttons = document.querySelectorAll('.vacuum-btn');
                const clickedBtn = document.querySelector(`.vacuum-btn-${command === 'clean' ? 'start' : command === 'charge' ? 'home' : 'stop'}`);
                
                // Disable all buttons and add loading state to clicked button
                buttons.forEach(btn => {
                    btn.disabled = true;
                });
                
                if (clickedBtn) {
                    clickedBtn.classList.add('loading');
                    const btnText = clickedBtn.querySelector('span:last-child');
                    if (btnText) btnText.textContent = 'Working...';
                }
                
                this.showToast(`â³ ${loadingMessage}`);
                
                try {
                    // Try the local API server first
                    const apiUrl = window.location.protocol === 'file:' ? 'http://localhost:3001' : '';
                    const response = await fetch(`${apiUrl}/api/vacuum/command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            device: 1,
                            command: command
                        }),
                        signal: AbortSignal.timeout(30000)  // 30 second timeout for commands
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.showToast(successMessage);
                            
                            // Auto-collapse Command Center after successful action (CMD-3-4)
                            this.hideVacuumPanel();
                            const commandCenter = document.getElementById('command-center');
                            commandCenter.classList.remove('open');
                        } else {
                            throw new Error(data.error || 'Command failed');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Vacuum ${command} failed:`, error.message);
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        // API server not available
                        this.showToast('ğŸ”§ API server needed - check setup instructions');
                        
                        // Show helpful information
                        const helpText = `To control Yiko:
1. cd /Users/agentcaras/.openclaw/workspace/alice-display-website
2. npm install && npm start
3. Refresh this page`;
                        
                        console.info(helpText);
                    } else {
                        this.showToast(`âŒ ${error.message}`);
                    }
                } finally {
                    // Re-enable buttons and remove loading state
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('loading');
                    });
                    
                    // Reset button text
                    const startBtn = document.querySelector('.vacuum-btn-start span:last-child');
                    const stopBtn = document.querySelector('.vacuum-btn-stop span:last-child');
                    const homeBtn = document.querySelector('.vacuum-btn-home span:last-child');
                    
                    if (startBtn) startBtn.textContent = 'Start Cleaning';
                    if (stopBtn) stopBtn.textContent = 'Stop';
                    if (homeBtn) homeBtn.textContent = 'Go Home';
                }
            }
            
            initializeLightsPanel() {
                const lightsPanel = document.getElementById('lights-panel');
                const lightsClose = document.getElementById('lights-panel-close');
                const bedtimeBtn = document.getElementById('lights-bedtime');
                const daytimeBtn = document.getElementById('lights-daytime');
                const movieBtn = document.getElementById('lights-movie');
                
                // Close panel when close button clicked
                lightsClose.addEventListener('click', () => {
                    this.hideLightsPanel();
                });
                
                // Close panel when clicking outside
                lightsPanel.addEventListener('click', (e) => {
                    if (e.target === lightsPanel) {
                        this.hideLightsPanel();
                    }
                });
                
                // Bedtime preset
                bedtimeBtn.addEventListener('click', () => {
                    this.activateLightsPreset('bedtime');
                });
                
                // Daytime preset
                daytimeBtn.addEventListener('click', () => {
                    this.activateLightsPreset('daytime');
                });
                
                // Movie preset
                movieBtn.addEventListener('click', () => {
                    this.activateLightsPreset('movie');
                });
            }
            
            async showLightsPanel() {
                const panel = document.getElementById('lights-panel');
                
                // Lock body scroll when panel is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                
                panel.classList.add('show');
            }
            
            hideLightsPanel() {
                const panel = document.getElementById('lights-panel');
                panel.classList.remove('show');
                
                // Restore body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }
            
            async activateLightsPreset(preset) {
                // Disable all buttons temporarily
                const buttons = document.querySelectorAll('.lights-preset-btn');
                buttons.forEach(btn => btn.disabled = true);
                
                try {
                    let message = '';
                    let icon = '';
                    
                    switch (preset) {
                        case 'bedtime':
                            message = 'Setting bedtime mode...';
                            icon = 'ğŸŒ™';
                            break;
                        case 'daytime':
                            message = 'Setting daytime mode...';
                            icon = 'â˜€ï¸';
                            break;
                        case 'movie':
                            message = 'Setting movie mode...';
                            icon = 'ğŸ¬';
                            break;
                    }
                    
                    this.showToast(message);
                    
                    // Send lights control request
                    const result = await this.sendLightsCommand(preset);
                    
                    if (result.success) {
                        // Auto-collapse Command Center and hide lights panel
                        this.hideLightsPanel();
                        document.getElementById('command-center').classList.remove('open');
                        
                        // Show success toast
                        this.showToast(`${icon} ${preset.charAt(0).toUpperCase() + preset.slice(1)} mode activated`);
                    } else {
                        this.showToast(`âŒ Failed to set ${preset} mode: ${result.error}`);
                    }
                    
                } catch (error) {
                    console.error(`Error activating ${preset} preset:`, error);
                    this.showToast(`âŒ Error: ${error.message}`);
                } finally {
                    // Re-enable buttons
                    buttons.forEach(btn => btn.disabled = false);
                }
            }
            
            async sendLightsCommand(preset) {
                try {
                    // Try to connect to local lights API server
                    // Run `npm start` in the alice-display-website directory to start the server
                    const response = await fetch('http://localhost:3001/api/lights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            preset: preset,
                            timestamp: Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                    
                } catch (error) {
                    // Fallback: log the command for manual execution
                    console.warn('Could not reach lights API, logging command for manual execution:', error);
                    
                    // Generate the OpenHue commands for manual execution
                    const commands = this.generateOpenHueCommands(preset);
                    console.info('OpenHue commands to run manually:', commands);
                    
                    // For demo purposes, simulate success
                    return { 
                        success: true, 
                        message: 'Commands logged to console',
                        commands: commands
                    };
                }
            }
            
            generateOpenHueCommands(preset) {
                const lightIds = [
                    "6a704bb0-d201-4343-8939-3cd98ee80643", // Kitchen fan 3-24
                    "2923d843-cf08-4ed8-aa79-27c722c08bbe", // Kitchen BW fan
                    "24da2926-210d-4b34-af37-7ecbf613b576", // Kitchen fan 2- 3/24
                    "1c124fbc-0d5f-4d3d-b84c-35fe208cff84", // Kitchen high lamp
                    "aa86140d-999d-465e-8c90-ba4d64664e72", // Zahava lamp
                    "a02ac2d6-482e-48c9-9f39-397008b6670a", // Outside Flood
                    "f0390f66-031a-4131-83de-b31b3fa9a05b", // Hue color lamp 2
                    "741900cf-413a-43e3-be6c-6a3f49c23cfb", // Hue color lamp 1
                    "9376f857-21b9-4a96-9cf4-92cd50cf987d", // Dining room fan - 4/24
                    "9993b466-9fcd-436e-8d78-1e7d835f7b80", // Living room lamp 3/24
                    "0dc211bd-b00a-42b6-b484-e49dbe79d05e", // Living room fan 3-24 #2
                    "9bd2567a-1683-4eeb-83c7-c66f2b214873", // Downstairs entrance 2
                    "fd64c7ac-4a70-4015-87d4-48264e7a9631", // fan above table
                    "c3edaddf-d9a0-4277-ad19-9a5ad8b3085c", // Dinning room March 23
                    "ebf4d80f-5b73-4a08-84a2-0250808f5533", // Living Room Fan 2
                    "ca5e5869-8b91-4135-94e7-69277f8d4beb", // Downstairs entrance 1
                    "9f2037a2-116c-4147-96a1-d6098fc44a03", // dinning room strip
                    "4122d13e-0c3e-4a06-b752-4b90add03a6f", // Living room tv strip
                    "dfc85340-54aa-44e1-82a4-4b6d2d46a8b4", // living room piano
                    "7e629fd1-c5c3-4e59-b650-b7d0f342ce7c", // Master bedroom left July 22
                    "5c0681a9-d2f9-4716-8844-4d91e996deac", // master bed left
                    "346c7450-096e-4857-b0a0-887ef98c3e8b"  // master bed right
                ];
                
                let commands = [];
                
                switch (preset) {
                    case 'bedtime':
                        // Set all lights to 1% brightness
                        lightIds.forEach(lightId => {
                            commands.push(`openhue set light "${lightId}" --on --brightness 1`);
                        });
                        break;
                        
                    case 'daytime':
                        // Set all lights to 100% brightness
                        lightIds.forEach(lightId => {
                            commands.push(`openhue set light "${lightId}" --on --brightness 100`);
                        });
                        break;
                        
                    case 'movie':
                        // Set all lights to 30% brightness, add blue color for color-capable lights
                        const colorCapableLights = [
                            "6a704bb0-d201-4343-8939-3cd98ee80643", // Kitchen fan 3-24
                            "24da2926-210d-4b34-af37-7ecbf613b576", // Kitchen fan 2- 3/24
                            "1c124fbc-0d5f-4d3d-b84c-35fe208cff84", // Kitchen high lamp
                            "aa86140d-999d-465e-8c90-ba4d64664e72", // Zahava lamp
                            "a02ac2d6-482e-48c9-9f39-397008b6670a", // Outside Flood
                            "f0390f66-031a-4131-83de-b31b3fa9a05b", // Hue color lamp 2
                            "741900cf-413a-43e3-be6c-6a3f49c23cfb", // Hue color lamp 1
                            "9376f857-21b9-4a96-9cf4-92cd50cf987d", // Dining room fan - 4/24
                            "9993b466-9fcd-436e-8d78-1e7d835f7b80", // Living room lamp 3/24
                            "0dc211bd-b00a-42b6-b484-e49dbe79d05e", // Living room fan 3-24 #2
                            "fd64c7ac-4a70-4015-87d4-48264e7a9631", // fan above table
                            "c3edaddf-d9a0-4277-ad19-9a5ad8b3085c", // Dinning room March 23
                            "ebf4d80f-5b73-4a08-84a2-0250808f5533", // Living Room Fan 2
                            "9f2037a2-116c-4147-96a1-d6098fc44a03", // dinning room strip
                            "4122d13e-0c3e-4a06-b752-4b90add03a6f", // Living room tv strip
                            "dfc85340-54aa-44e1-82a4-4b6d2d46a8b4", // living room piano
                            "7e629fd1-c5c3-4e59-b650-b7d0f342ce7c", // Master bedroom left July 22
                            "5c0681a9-d2f9-4716-8844-4d91e996deac", // master bed left
                            "346c7450-096e-4857-b0a0-887ef98c3e8b"  // master bed right
                        ];
                        
                        lightIds.forEach(lightId => {
                            if (colorCapableLights.includes(lightId)) {
                                commands.push(`openhue set light "${lightId}" --on --brightness 30 --color blue`);
                            } else {
                                commands.push(`openhue set light "${lightId}" --on --brightness 30`);
                            }
                        });
                        break;
                }
                
                return commands;
            }
            
            closeAllPanels() {
                document.getElementById('help-overlay').classList.remove('show');
                document.getElementById('image-info').classList.remove('show');
                document.getElementById('report-modal').classList.remove('show');
                document.getElementById('vacuum-panel').classList.remove('show');
                document.getElementById('lights-panel').classList.remove('show');
                // Note: status overlay toggle is separate - not included in close all panels
                this.debugEl.classList.remove('show');
            }
            
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 1500);
            }
            
            startPolling() {
                // Update countdown display
                let nextPoll = Date.now() + this.pollInterval;
                
                const updateCountdown = () => {
                    const remaining = Math.max(0, Math.ceil((nextPoll - Date.now()) / 1000));
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    this.countdownEl.textContent = `Next check in ${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                setInterval(updateCountdown, 1000);
                
                // Main polling loop
                setInterval(() => {
                    if (!this.isPaused) {
                        this.loadDisplay();
                    }
                    nextPoll = Date.now() + this.pollInterval;
                }, this.pollInterval);
                
                console.log('ğŸ¦œ Alice Display initialized');
                console.log(`ğŸ“¡ Auto-refresh every ${this.pollInterval / 1000 / 60} minutes`);
            }
        }
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            new AliceDisplay();
        });
        
        // PWA Install Prompt Handler
        class InstallPrompt {
            constructor() {
                this.deferredPrompt = null;
                this.banner = document.getElementById('install-banner');
                this.installBtn = document.getElementById('install-btn');
                this.dismissBtn = document.getElementById('install-dismiss');
                this.iosModal = document.getElementById('ios-modal');
                this.iosModalClose = document.getElementById('ios-modal-close');
                
                this.init();
            }
            
            init() {
                // Check if already installed or dismissed
                if (this.isInstalled() || this.isDismissed()) {
                    return;
                }
                
                // Check for iOS
                if (this.isIOS()) {
                    this.setupIOSPrompt();
                    return;
                }
                
                // Listen for beforeinstallprompt (Chrome/Edge)
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showBanner();
                });
                
                // Handle install button click
                this.installBtn.addEventListener('click', () => this.handleInstall());
                this.dismissBtn.addEventListener('click', () => this.handleDismiss());
                
                // Listen for successful install
                window.addEventListener('appinstalled', () => {
                    console.log('ğŸ¦œ App installed successfully!');
                    this.hideBanner();
                    this.deferredPrompt = null;
                });
            }
            
            isInstalled() {
                // Check if running as installed PWA
                return window.matchMedia('(display-mode: standalone)').matches ||
                       window.navigator.standalone === true;
            }
            
            isDismissed() {
                const dismissed = localStorage.getItem('installDismissed');
                if (!dismissed) return false;
                
                // Allow re-prompting after 7 days
                const dismissedTime = parseInt(dismissed, 10);
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                return (Date.now() - dismissedTime) < sevenDays;
            }
            
            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            }
            
            isIPad() {
                return /iPad/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }
            
            isIOSSafari() {
                const ua = navigator.userAgent;
                const iOS = /iPad|iPhone|iPod/.test(ua);
                const webkit = /WebKit/.test(ua);
                const notChrome = !/CriOS/.test(ua);
                const notFirefox = !/FxiOS/.test(ua);
                const notEdge = !/EdgiOS/.test(ua);
                return iOS && webkit && notChrome && notFirefox && notEdge;
            }
            
            setupIOSPrompt() {
                // Get additional iOS modal elements
                const iosModalDismiss = document.getElementById('ios-modal-dismiss');
                const safariNote = this.iosModal.querySelector('.ios-safari-note');
                
                // Update note if not in Safari
                if (!this.isIOSSafari() && safariNote) {
                    safariNote.innerHTML = `
                        <strong>âš ï¸ Open in Safari</strong><br>
                        You're not in Safari. Copy this link and open it in Safari to install:
                        <div id="safari-url-copy" style="margin-top:8px;padding:10px;background:rgba(255,255,255,0.1);border-radius:6px;font-size:11px;word-break:break-all;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.15s ease;position:relative;">
                            ${window.location.href}
                            <div id="url-copy-toast" style="position:absolute;top:-30px;left:50%;transform:translateX(-50%);background:rgba(34,197,94,0.9);color:white;padding:4px 12px;border-radius:8px;font-size:11px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.25s ease;">ğŸ“‹ Copied!</div>
                        </div>
                    `;
                    safariNote.style.color = 'rgba(255, 200, 100, 0.8)';
                    
                    // Make the URL text tappable to copy to clipboard
                    const urlCopyEl = document.getElementById('safari-url-copy');
                    if (urlCopyEl) {
                        urlCopyEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const siteUrl = window.location.href;
                            const toast = document.getElementById('url-copy-toast');
                            
                            // Flash the background to show tap feedback
                            urlCopyEl.style.background = 'rgba(255,255,255,0.25)';
                            setTimeout(() => { urlCopyEl.style.background = 'rgba(255,255,255,0.1)'; }, 200);
                            
                            // Copy to clipboard
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(siteUrl).then(() => {
                                    if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                                }).catch(() => {
                                    // Fallback for non-HTTPS or permission denied
                                    const ta = document.createElement('textarea');
                                    ta.value = siteUrl;
                                    ta.style.cssText = 'position:fixed;opacity:0';
                                    document.body.appendChild(ta);
                                    ta.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(ta);
                                    if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                                });
                            } else {
                                // Fallback
                                const ta = document.createElement('textarea');
                                ta.value = siteUrl;
                                ta.style.cssText = 'position:fixed;opacity:0';
                                document.body.appendChild(ta);
                                ta.select();
                                document.execCommand('copy');
                                document.body.removeChild(ta);
                                if (toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1500); }
                            }
                        });
                    }
                }
                
                // Update text for iPad
                if (this.isIPad()) {
                    const stepDesc = this.iosModal.querySelector('.ios-step-desc');
                    if (stepDesc) {
                        stepDesc.textContent = 'Find it at the top of Safari';
                    }
                }
                
                // Show banner after a short delay on iOS
                setTimeout(() => {
                    this.showBanner();
                }, 3000);
                
                this.installBtn.addEventListener('click', () => {
                    this.iosModal.classList.add('show');
                    this.hideBanner();
                });
                
                this.dismissBtn.addEventListener('click', () => this.handleDismiss());
                
                // "Got it" button - just closes modal
                this.iosModalClose.addEventListener('click', () => {
                    this.iosModal.classList.remove('show');
                });
                
                // "Don't show again" button - closes and permanently dismisses
                if (iosModalDismiss) {
                    iosModalDismiss.addEventListener('click', () => {
                        this.iosModal.classList.remove('show');
                        // Set a very long dismissal (365 days)
                        const oneYear = 365 * 24 * 60 * 60 * 1000;
                        localStorage.setItem('installDismissed', (Date.now() + oneYear).toString());
                    });
                }
                
                // Close modal on backdrop click
                this.iosModal.addEventListener('click', (e) => {
                    if (e.target === this.iosModal) {
                        this.iosModal.classList.remove('show');
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.iosModal.classList.contains('show')) {
                        this.iosModal.classList.remove('show');
                    }
                });
            }
            
            showBanner() {
                // Delay showing to not interrupt initial experience
                setTimeout(() => {
                    this.banner.classList.add('show');
                }, 5000);
            }
            
            hideBanner() {
                this.banner.classList.remove('show');
            }
            
            async handleInstall() {
                if (!this.deferredPrompt) {
                    console.log('No install prompt available');
                    return;
                }
                
                // Show the install prompt
                this.deferredPrompt.prompt();
                
                // Wait for user response
                const { outcome } = await this.deferredPrompt.userChoice;
                console.log(`Install prompt outcome: ${outcome}`);
                
                this.deferredPrompt = null;
                this.hideBanner();
            }
            
            handleDismiss() {
                localStorage.setItem('installDismissed', Date.now().toString());
                this.hideBanner();
            }
        }
        
        // Initialize install prompt
        new InstallPrompt();
        
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('ğŸ¦œ Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);  // Check hourly
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ¦œ New version available');
                                    // Optionally notify user or auto-update
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('Service Worker registration failed:', error);
                    });
                
                // Listen for controller changes (new SW activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('ğŸ¦œ Service Worker updated, reloading...');
                    window.location.reload();
                });
            });
        }
    </script>
</body>
</html>
